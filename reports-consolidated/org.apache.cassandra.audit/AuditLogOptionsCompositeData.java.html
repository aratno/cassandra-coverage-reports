<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuditLogOptionsCompositeData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.audit</a> &gt; <span class="el_source">AuditLogOptionsCompositeData.java</span></div><h1>AuditLogOptionsCompositeData.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.audit;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.function.BiConsumer;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.management.openmbean.CompositeData;
import javax.management.openmbean.CompositeDataSupport;
import javax.management.openmbean.CompositeType;
import javax.management.openmbean.OpenDataException;
import javax.management.openmbean.OpenType;
import javax.management.openmbean.SimpleType;

import org.apache.cassandra.config.ParameterizedClass;
import org.apache.cassandra.utils.Pair;

import static org.apache.cassandra.audit.AuditLogOptionsCompositeData.AuditLogOption.option;

<span class="nc" id="L39">public class AuditLogOptionsCompositeData</span>
{
    public static class AuditLogOption
    {
        // TODO these constants will be used in upcoming audit log vtable too, see CASSANDRA-16725
        public static final String AUDIT_LOGS_DIR = &quot;audit_logs_dir&quot;;
        public static final String ARCHIVE_COMMAND = &quot;archive_command&quot;;
        public static final String ROLL_CYCLE = &quot;roll_cycle&quot;;
        public static final String BLOCK = &quot;block&quot;;
        public static final String MAX_QUEUE_WEIGHT = &quot;max_queue_weight&quot;;
        public static final String MAX_LOG_SIZE = &quot;max_log_size&quot;;
        public static final String MAX_ARCHIVE_RETRIES = &quot;max_archive_retries&quot;;
        public static final String ENABLED = &quot;enabled&quot;;
        public static final String INCLUDED_KEYSPACES = &quot;included_keyspaces&quot;;
        public static final String EXCLUDED_KEYSPACES = &quot;excluded_keyspaces&quot;;
        public static final String INCLUDED_CATEGORIES = &quot;included_categories&quot;;
        public static final String EXCLUDED_CATEGORIES = &quot;excluded_categories&quot;;
        public static final String INCLUDED_USERS = &quot;included_users&quot;;
        public static final String EXCLUDED_USERS = &quot;excluded_users&quot;;
        public static final String LOGGER = &quot;logger&quot;;

        private final String name;
        private final String description;
        private final OpenType&lt;?&gt; type;
        private final Function&lt;AuditLogOptions, Object&gt; toCompositeMapping;
        private final BiConsumer&lt;AuditLogOptions, Object&gt; fromCompositeMapping;

        public AuditLogOption(final String name,
                              final String description,
                              final OpenType&lt;?&gt; type,
                              final Function&lt;AuditLogOptions, Object&gt; toCompositeMapping,
                              final BiConsumer&lt;AuditLogOptions, Object&gt; fromCompositeMapping)
<span class="fc" id="L71">        {</span>
<span class="fc" id="L72">            this.name = name;</span>
<span class="fc" id="L73">            this.description = description;</span>
<span class="fc" id="L74">            this.type = type;</span>
<span class="fc" id="L75">            this.toCompositeMapping = toCompositeMapping;</span>
<span class="fc" id="L76">            this.fromCompositeMapping = fromCompositeMapping;</span>
<span class="fc" id="L77">        }</span>

        public static AuditLogOption option(final String name,
                                            final String description,
                                            final OpenType&lt;?&gt; type,
                                            final Function&lt;AuditLogOptions, Object&gt; toCompositeMapping,
                                            final BiConsumer&lt;AuditLogOptions, Object&gt; fromCompositeMapping)
        {
<span class="fc" id="L85">            return new AuditLogOption(name, description, type, toCompositeMapping, fromCompositeMapping);</span>
        }
    }

<span class="fc" id="L89">    private static final AuditLogOption[] options = new AuditLogOption[]{</span>
<span class="fc" id="L90">    option(AuditLogOption.AUDIT_LOGS_DIR,</span>
           &quot;directory where audit data are stored&quot;,
           SimpleType.STRING,
<span class="fc" id="L93">           o -&gt; o.audit_logs_dir,</span>
<span class="nc" id="L94">           (opts, obj) -&gt; opts.audit_logs_dir = (String) obj),</span>

<span class="fc" id="L96">    option(AuditLogOption.ARCHIVE_COMMAND,</span>
           &quot;archive command for audit data&quot;,
           SimpleType.STRING,
<span class="fc" id="L99">           o -&gt; o.archive_command,</span>
<span class="nc" id="L100">           (opts, obj) -&gt; opts.archive_command = (String) obj),</span>

<span class="fc" id="L102">    option(AuditLogOption.ROLL_CYCLE,</span>
           &quot;how often to roll BinLog segments so they can potentially be reclaimed&quot;,
           SimpleType.STRING,
<span class="fc" id="L105">           o -&gt; o.roll_cycle,</span>
<span class="nc" id="L106">           (opts, obj) -&gt; opts.roll_cycle = (String) obj),</span>

<span class="fc" id="L108">    option(AuditLogOption.BLOCK,</span>
           &quot;indicates if the BinLog should block if it falls behind or should drop bin log records&quot;,
           SimpleType.BOOLEAN,
<span class="fc" id="L111">           o -&gt; o.block,</span>
<span class="nc" id="L112">           (opts, obj) -&gt; opts.block = (Boolean) obj),</span>

<span class="fc" id="L114">    option(AuditLogOption.MAX_QUEUE_WEIGHT,</span>
           &quot;maximum weight of in-memory queue for records waiting to be written to the binlog file before blocking or dropping the log records&quot;,
           SimpleType.INTEGER,
<span class="fc" id="L117">           o -&gt; o.max_queue_weight,</span>
<span class="nc" id="L118">           (opts, obj) -&gt; opts.max_queue_weight = (Integer) obj),</span>

<span class="fc" id="L120">    option(AuditLogOption.MAX_LOG_SIZE,</span>
           &quot;maximum size of the rolled files to retain on disk before deleting the oldest file&quot;,
           SimpleType.LONG,
<span class="fc" id="L123">           o -&gt; o.max_log_size,</span>
<span class="nc" id="L124">           (opts, obj) -&gt; opts.max_log_size = (Long) obj),</span>

<span class="fc" id="L126">    option(AuditLogOption.MAX_ARCHIVE_RETRIES,</span>
           &quot;number of times to retry an archive command&quot;,
           SimpleType.INTEGER,
<span class="fc" id="L129">           o -&gt; o.max_archive_retries,</span>
<span class="nc" id="L130">           (opts, obj) -&gt; opts.max_archive_retries = (Integer) obj),</span>

<span class="fc" id="L132">    option(AuditLogOption.ENABLED,</span>
           &quot;boolean telling if we are enabled or not&quot;,
           SimpleType.BOOLEAN,
<span class="fc" id="L135">           o -&gt; o.enabled,</span>
<span class="nc" id="L136">           (opts, obj) -&gt; opts.enabled = (Boolean) obj),</span>

<span class="fc" id="L138">    option(AuditLogOption.INCLUDED_KEYSPACES,</span>
           &quot;included keyspaces&quot;,
           SimpleType.STRING,
<span class="fc" id="L141">           o -&gt; o.included_keyspaces,</span>
<span class="nc" id="L142">           (opts, obj) -&gt; opts.included_keyspaces = (String) obj),</span>

<span class="fc" id="L144">    option(AuditLogOption.EXCLUDED_KEYSPACES,</span>
           &quot;excluded keyspaces&quot;,
           SimpleType.STRING,
<span class="fc" id="L147">           o -&gt; o.excluded_keyspaces,</span>
<span class="nc" id="L148">           (opts, obj) -&gt; opts.excluded_keyspaces = (String) obj),</span>

<span class="fc" id="L150">    option(AuditLogOption.INCLUDED_CATEGORIES,</span>
           &quot;included categories&quot;,
           SimpleType.STRING,
<span class="fc" id="L153">           o -&gt; o.included_categories,</span>
<span class="nc" id="L154">           (opts, obj) -&gt; opts.included_categories = (String) obj),</span>

<span class="fc" id="L156">    option(AuditLogOption.EXCLUDED_CATEGORIES,</span>
           &quot;excluded categories&quot;,
           SimpleType.STRING,
<span class="fc" id="L159">           o -&gt; o.excluded_categories,</span>
<span class="nc" id="L160">           (opts, obj) -&gt; opts.excluded_categories = (String) obj),</span>

<span class="fc" id="L162">    option(AuditLogOption.INCLUDED_USERS,</span>
           &quot;included users&quot;,
           SimpleType.STRING,
<span class="fc" id="L165">           o -&gt; o.included_users,</span>
<span class="nc" id="L166">           (opts, obj) -&gt; opts.included_users = (String) obj),</span>

<span class="fc" id="L168">    option(AuditLogOption.EXCLUDED_USERS,</span>
           &quot;excluded users&quot;,
           SimpleType.STRING,
<span class="fc" id="L171">           o -&gt; o.excluded_users,</span>
<span class="nc" id="L172">           (opts, obj) -&gt; opts.excluded_users = (String) obj),</span>

<span class="fc" id="L174">    option(AuditLogOption.LOGGER,</span>
           &quot;audit logger implementation class name&quot;,
           SimpleType.STRING,
<span class="fc" id="L177">           o -&gt; o.logger.class_name,</span>
<span class="nc" id="L178">           (opts, obj) -&gt; opts.logger = new ParameterizedClass((String) obj, new HashMap&lt;&gt;()))</span>
    };

    public static final CompositeType COMPOSITE_TYPE;

    static
    {
        try
        {
<span class="fc" id="L187">            COMPOSITE_TYPE = new CompositeType(AuditLogOptions.class.getName(),</span>
                                               &quot;AuditLogOptions&quot;,
<span class="fc" id="L189">                                               Arrays.stream(options).map(o -&gt; o.name).toArray(String[]::new),</span>
<span class="fc" id="L190">                                               Arrays.stream(options).map(o -&gt; o.description).toArray(String[]::new),</span>
<span class="fc" id="L191">                                               Arrays.stream(options).map(o -&gt; o.type).toArray(OpenType[]::new));</span>
        }
<span class="nc" id="L193">        catch (final OpenDataException e)</span>
        {
<span class="nc" id="L195">            throw new RuntimeException(e);</span>
<span class="fc" id="L196">        }</span>
<span class="fc" id="L197">    }</span>

    public static CompositeData toCompositeData(final AuditLogOptions opts)
    {
        try
        {
<span class="fc" id="L203">            final Map&lt;String, Object&gt; valueMap = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L205" title="All 2 branches covered.">            for (final Pair&lt;String, Function&lt;AuditLogOptions, Object&gt;&gt; pair : Arrays.stream(options).map(o -&gt; Pair.create(o.name, o.toCompositeMapping)).collect(Collectors.toList()))</span>
            {
<span class="fc" id="L207">                valueMap.put(pair.left, pair.right.apply(opts));</span>
<span class="fc" id="L208">            }</span>

<span class="fc" id="L210">            return new CompositeDataSupport(COMPOSITE_TYPE, valueMap);</span>
        }
<span class="nc" id="L212">        catch (final OpenDataException e)</span>
        {
<span class="nc" id="L214">            throw new RuntimeException(e);</span>
        }
    }

    public static AuditLogOptions fromCompositeData(final CompositeData data)
    {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        assert data.getCompositeType().equals(COMPOSITE_TYPE);</span>

<span class="nc" id="L222">        final Object[] values = data.getAll(Arrays.stream(options).map(o -&gt; o.name).toArray(String[]::new));</span>
<span class="nc" id="L223">        final AuditLogOptions opts = new AuditLogOptions();</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++)</span>
        {
<span class="nc" id="L227">            options[i].fromCompositeMapping.accept(opts, values[i]);</span>
        }

<span class="nc" id="L230">        return opts;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>