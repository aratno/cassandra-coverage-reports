<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InternodeOutboundMetrics.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.metrics</a> &gt; <span class="el_source">InternodeOutboundMetrics.java</span></div><h1>InternodeOutboundMetrics.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.cassandra.metrics;

import com.codahale.metrics.Gauge;
import com.codahale.metrics.Meter;
import org.apache.cassandra.net.OutboundConnections;

import static org.apache.cassandra.metrics.CassandraMetricsRegistry.Metrics;

import org.apache.cassandra.locator.InetAddressAndPort;

/**
 * Metrics for internode connections.
 */
public class InternodeOutboundMetrics
{
    public static final String TYPE_NAME = &quot;Connection&quot;;

    /** Total number of callbacks that were not completed successfully for messages that were sent to this node
     * TODO this was always broken, as it never counted those messages without callbacks? So perhaps we can redefine it. */
<span class="fc" id="L37">    public static final Meter totalExpiredCallbacks = Metrics.meter(DefaultNameFactory.createMetricName(TYPE_NAME, &quot;TotalTimeouts&quot;, null));</span>

    /** Number of timeouts for specific IP */
    public final Meter expiredCallbacks;

    public final String address;
    /** Pending tasks for large message TCP Connections */
    public final Gauge&lt;Integer&gt; largeMessagePendingTasks;
    /** Pending bytes for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessagePendingBytes;
    /** Completed tasks for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageCompletedTasks;
    /** Completed bytes for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageCompletedBytes;
    /** Dropped tasks for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDropped;
    /** Dropped tasks because of timeout for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedTasksDueToTimeout;
    /** Dropped bytes because of timeout for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedBytesDueToTimeout;
    /** Dropped tasks because of overload for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedTasksDueToOverload;
    /** Dropped bytes because of overload for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedBytesDueToOverload;
    /** Dropped tasks because of error for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedTasksDueToError;
    /** Dropped bytes because of error for large message TCP Connections */
    public final Gauge&lt;Long&gt; largeMessageDroppedBytesDueToError;
    /** Pending tasks for small message TCP Connections */
    public final Gauge&lt;Integer&gt; smallMessagePendingTasks;
    /** Pending bytes for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessagePendingBytes;
    /** Completed tasks for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageCompletedTasks;
    /** Completed bytes for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageCompletedBytes;
    /** Dropped tasks for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedTasks;
    /** Dropped tasks because of timeout for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedTasksDueToTimeout;
    /** Dropped bytes because of timeout for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedBytesDueToTimeout;
    /** Dropped tasks because of overload for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedTasksDueToOverload;
    /** Dropped bytes because of overload for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedBytesDueToOverload;
    /** Dropped tasks because of error for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedTasksDueToError;
    /** Dropped bytes because of error for small message TCP Connections */
    public final Gauge&lt;Long&gt; smallMessageDroppedBytesDueToError;
    /** Pending tasks for small message TCP Connections */
    public final Gauge&lt;Integer&gt; urgentMessagePendingTasks;
    /** Pending bytes for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessagePendingBytes;
    /** Completed tasks for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageCompletedTasks;
    /** Completed bytes for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageCompletedBytes;
    /** Dropped tasks for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedTasks;
    /** Dropped tasks because of timeout for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedTasksDueToTimeout;
    /** Dropped bytes because of timeout for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedBytesDueToTimeout;
    /** Dropped tasks because of overload for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedTasksDueToOverload;
    /** Dropped bytes because of overload for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedBytesDueToOverload;
    /** Dropped tasks because of error for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedTasksDueToError;
    /** Dropped bytes because of error for urgent message TCP Connections */
    public final Gauge&lt;Long&gt; urgentMessageDroppedBytesDueToError;
    
    private final MetricNameFactory factory;

    /**
     * Create metrics for given connection pool.
     *
     * @param ip IP address to use for metrics label
     */
    public InternodeOutboundMetrics(InetAddressAndPort ip, final OutboundConnections messagingPool)
<span class="fc" id="L118">    {</span>
        // ipv6 addresses will contain colons, which are invalid in a JMX ObjectName
<span class="fc" id="L120">        address = ip.getHostAddressAndPortForJMX();</span>

<span class="fc" id="L122">        factory = new DefaultNameFactory(&quot;Connection&quot;, address);</span>

<span class="fc" id="L124">        largeMessagePendingTasks = Metrics.register(factory.createMetricName(&quot;LargeMessagePendingTasks&quot;), messagingPool.large::pendingCount);</span>
<span class="fc" id="L125">        largeMessagePendingBytes = Metrics.register(factory.createMetricName(&quot;LargeMessagePendingBytes&quot;), messagingPool.large::pendingBytes);</span>
<span class="fc" id="L126">        largeMessageCompletedTasks = Metrics.register(factory.createMetricName(&quot;LargeMessageCompletedTasks&quot;),messagingPool.large::sentCount);</span>
<span class="fc" id="L127">        largeMessageCompletedBytes = Metrics.register(factory.createMetricName(&quot;LargeMessageCompletedBytes&quot;),messagingPool.large::sentBytes);</span>
<span class="fc" id="L128">        largeMessageDropped = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedTasks&quot;), messagingPool.large::dropped);</span>
<span class="fc" id="L129">        largeMessageDroppedTasksDueToOverload = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToOverload&quot;), messagingPool.large::overloadedCount);</span>
<span class="fc" id="L130">        largeMessageDroppedBytesDueToOverload = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToOverload&quot;), messagingPool.large::overloadedBytes);</span>
<span class="fc" id="L131">        largeMessageDroppedTasksDueToTimeout = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToTimeout&quot;), messagingPool.large::expiredCount);</span>
<span class="fc" id="L132">        largeMessageDroppedBytesDueToTimeout = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToTimeout&quot;), messagingPool.large::expiredBytes);</span>
<span class="fc" id="L133">        largeMessageDroppedTasksDueToError = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToError&quot;), messagingPool.large::errorCount);</span>
<span class="fc" id="L134">        largeMessageDroppedBytesDueToError = Metrics.register(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToError&quot;), messagingPool.large::errorBytes);</span>
<span class="fc" id="L135">        smallMessagePendingTasks = Metrics.register(factory.createMetricName(&quot;SmallMessagePendingTasks&quot;), messagingPool.small::pendingCount);</span>
<span class="fc" id="L136">        smallMessagePendingBytes = Metrics.register(factory.createMetricName(&quot;SmallMessagePendingBytes&quot;), messagingPool.small::pendingBytes);</span>
<span class="fc" id="L137">        smallMessageCompletedTasks = Metrics.register(factory.createMetricName(&quot;SmallMessageCompletedTasks&quot;), messagingPool.small::sentCount);</span>
<span class="fc" id="L138">        smallMessageCompletedBytes = Metrics.register(factory.createMetricName(&quot;SmallMessageCompletedBytes&quot;),messagingPool.small::sentBytes);</span>
<span class="fc" id="L139">        smallMessageDroppedTasks = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedTasks&quot;), messagingPool.small::dropped);</span>
<span class="fc" id="L140">        smallMessageDroppedTasksDueToOverload = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToOverload&quot;), messagingPool.small::overloadedCount);</span>
<span class="fc" id="L141">        smallMessageDroppedBytesDueToOverload = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToOverload&quot;), messagingPool.small::overloadedBytes);</span>
<span class="fc" id="L142">        smallMessageDroppedTasksDueToTimeout = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToTimeout&quot;), messagingPool.small::expiredCount);</span>
<span class="fc" id="L143">        smallMessageDroppedBytesDueToTimeout = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToTimeout&quot;), messagingPool.small::expiredBytes);</span>
<span class="fc" id="L144">        smallMessageDroppedTasksDueToError = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToError&quot;), messagingPool.small::errorCount);</span>
<span class="fc" id="L145">        smallMessageDroppedBytesDueToError = Metrics.register(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToError&quot;), messagingPool.small::errorBytes);</span>
<span class="fc" id="L146">        urgentMessagePendingTasks = Metrics.register(factory.createMetricName(&quot;UrgentMessagePendingTasks&quot;), messagingPool.urgent::pendingCount);</span>
<span class="fc" id="L147">        urgentMessagePendingBytes = Metrics.register(factory.createMetricName(&quot;UrgentMessagePendingBytes&quot;), messagingPool.urgent::pendingBytes);</span>
<span class="fc" id="L148">        urgentMessageCompletedTasks = Metrics.register(factory.createMetricName(&quot;UrgentMessageCompletedTasks&quot;), messagingPool.urgent::sentCount);</span>
<span class="fc" id="L149">        urgentMessageCompletedBytes = Metrics.register(factory.createMetricName(&quot;UrgentMessageCompletedBytes&quot;),messagingPool.urgent::sentBytes);</span>
<span class="fc" id="L150">        urgentMessageDroppedTasks = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedTasks&quot;), messagingPool.urgent::dropped);</span>
<span class="fc" id="L151">        urgentMessageDroppedTasksDueToOverload = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToOverload&quot;), messagingPool.urgent::overloadedCount);</span>
<span class="fc" id="L152">        urgentMessageDroppedBytesDueToOverload = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToOverload&quot;), messagingPool.urgent::overloadedBytes);</span>
<span class="fc" id="L153">        urgentMessageDroppedTasksDueToTimeout = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToTimeout&quot;), messagingPool.urgent::expiredCount);</span>
<span class="fc" id="L154">        urgentMessageDroppedBytesDueToTimeout = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToTimeout&quot;), messagingPool.urgent::expiredBytes);</span>
<span class="fc" id="L155">        urgentMessageDroppedTasksDueToError = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToError&quot;), messagingPool.urgent::errorCount);</span>
<span class="fc" id="L156">        urgentMessageDroppedBytesDueToError = Metrics.register(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToError&quot;), messagingPool.urgent::errorBytes);</span>
<span class="fc" id="L157">        expiredCallbacks = Metrics.meter(factory.createMetricName(&quot;Timeouts&quot;));</span>

        // deprecated
<span class="fc" id="L160">        Metrics.register(factory.createMetricName(&quot;GossipMessagePendingTasks&quot;), (Gauge&lt;Integer&gt;) messagingPool.urgent::pendingCount);</span>
<span class="fc" id="L161">        Metrics.register(factory.createMetricName(&quot;GossipMessageCompletedTasks&quot;), (Gauge&lt;Long&gt;) messagingPool.urgent::sentCount);</span>
<span class="fc" id="L162">        Metrics.register(factory.createMetricName(&quot;GossipMessageDroppedTasks&quot;), (Gauge&lt;Long&gt;) messagingPool.urgent::dropped);</span>
<span class="fc" id="L163">    }</span>

    public void release()
    {
<span class="fc" id="L167">        Metrics.remove(factory.createMetricName(&quot;LargeMessagePendingTasks&quot;));</span>
<span class="fc" id="L168">        Metrics.remove(factory.createMetricName(&quot;LargeMessagePendingBytes&quot;));</span>
<span class="fc" id="L169">        Metrics.remove(factory.createMetricName(&quot;LargeMessageCompletedTasks&quot;));</span>
<span class="fc" id="L170">        Metrics.remove(factory.createMetricName(&quot;LargeMessageCompletedBytes&quot;));</span>
<span class="fc" id="L171">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedTasks&quot;));</span>
<span class="fc" id="L172">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToTimeout&quot;));</span>
<span class="fc" id="L173">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToTimeout&quot;));</span>
<span class="fc" id="L174">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToOverload&quot;));</span>
<span class="fc" id="L175">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToOverload&quot;));</span>
<span class="fc" id="L176">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedTasksDueToError&quot;));</span>
<span class="fc" id="L177">        Metrics.remove(factory.createMetricName(&quot;LargeMessageDroppedBytesDueToError&quot;));</span>
<span class="fc" id="L178">        Metrics.remove(factory.createMetricName(&quot;SmallMessagePendingTasks&quot;));</span>
<span class="fc" id="L179">        Metrics.remove(factory.createMetricName(&quot;SmallMessagePendingBytes&quot;));</span>
<span class="fc" id="L180">        Metrics.remove(factory.createMetricName(&quot;SmallMessageCompletedTasks&quot;));</span>
<span class="fc" id="L181">        Metrics.remove(factory.createMetricName(&quot;SmallMessageCompletedBytes&quot;));</span>
<span class="fc" id="L182">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedTasks&quot;));</span>
<span class="fc" id="L183">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToTimeout&quot;));</span>
<span class="fc" id="L184">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToTimeout&quot;));</span>
<span class="fc" id="L185">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToOverload&quot;));</span>
<span class="fc" id="L186">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToOverload&quot;));</span>
<span class="fc" id="L187">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedTasksDueToError&quot;));</span>
<span class="fc" id="L188">        Metrics.remove(factory.createMetricName(&quot;SmallMessageDroppedBytesDueToError&quot;));</span>
<span class="fc" id="L189">        Metrics.remove(factory.createMetricName(&quot;GossipMessagePendingTasks&quot;));</span>
<span class="fc" id="L190">        Metrics.remove(factory.createMetricName(&quot;GossipMessageCompletedTasks&quot;));</span>
<span class="fc" id="L191">        Metrics.remove(factory.createMetricName(&quot;GossipMessageDroppedTasks&quot;));</span>
<span class="fc" id="L192">        Metrics.remove(factory.createMetricName(&quot;UrgentMessagePendingTasks&quot;));</span>
<span class="fc" id="L193">        Metrics.remove(factory.createMetricName(&quot;UrgentMessagePendingBytes&quot;));</span>
<span class="fc" id="L194">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageCompletedTasks&quot;));</span>
<span class="fc" id="L195">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageCompletedBytes&quot;));</span>
<span class="fc" id="L196">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedTasks&quot;));</span>
<span class="fc" id="L197">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToTimeout&quot;));</span>
<span class="fc" id="L198">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToTimeout&quot;));</span>
<span class="fc" id="L199">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToOverload&quot;));</span>
<span class="fc" id="L200">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToOverload&quot;));</span>
<span class="fc" id="L201">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedTasksDueToError&quot;));</span>
<span class="fc" id="L202">        Metrics.remove(factory.createMetricName(&quot;UrgentMessageDroppedBytesDueToError&quot;));</span>
<span class="fc" id="L203">        Metrics.remove(factory.createMetricName(&quot;Timeouts&quot;));</span>
<span class="fc" id="L204">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>