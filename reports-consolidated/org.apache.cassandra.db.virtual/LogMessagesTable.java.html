<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogMessagesTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.db.virtual</a> &gt; <span class="el_source">LogMessagesTable.java</span></div><h1>LogMessagesTable.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.db.virtual;

import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;

import com.google.common.annotations.VisibleForTesting;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import ch.qos.logback.classic.spi.LoggingEvent;
import org.apache.cassandra.config.CassandraRelevantProperties;
import org.apache.cassandra.db.DecoratedKey;
import org.apache.cassandra.db.marshal.Int32Type;
import org.apache.cassandra.db.marshal.TimestampType;
import org.apache.cassandra.db.marshal.UTF8Type;
import org.apache.cassandra.dht.LocalPartitioner;
import org.apache.cassandra.schema.TableMetadata;

/**
 * Virtual table for holding Cassandra logs. Entries to this table are added via log appender.
 * &lt;p&gt;
 * The virtual table is bounded in its size. If a new log message is appended to virtual table,
 * the oldest one is removed.
 * &lt;p&gt;
 * This virtual table can be truncated.
 * &lt;p&gt;
 * This table does not enable {@code ALLOW FILTERING} implicitly.
 *
 * @see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18238&quot;&gt;CASSANDRA-18238&lt;/a&gt;
 * @see org.apache.cassandra.utils.logging.VirtualTableAppender
 */
public final class LogMessagesTable extends AbstractMutableVirtualTable
{
<span class="fc" id="L55">    private static final Logger logger = LoggerFactory.getLogger(LogMessagesTable.class);</span>

    public static final int LOGS_VIRTUAL_TABLE_MIN_ROWS = 1000;
    public static final int LOGS_VIRTUAL_TABLE_DEFAULT_ROWS = 50_000;
    public static final int LOGS_VIRTUAL_TABLE_MAX_ROWS = 100_000;

    public static final String TABLE_NAME = &quot;system_logs&quot;;
    private static final String TABLE_COMMENT = &quot;Cassandra logs&quot;;

    public static final String TIMESTAMP_COLUMN_NAME = &quot;timestamp&quot;;
    public static final String LOGGER_COLUMN_NAME = &quot;logger&quot;;
    public static final String ORDER_IN_MILLISECOND_COLUMN_NAME = &quot;order_in_millisecond&quot;;
    public static final String LEVEL_COLUMN_NAME = &quot;level&quot;;
    public static final String MESSAGE_COLUMN_NAME = &quot;message&quot;;

    private final List&lt;LogMessage&gt; buffer;

    LogMessagesTable(String keyspace)
    {
<span class="fc" id="L74">        this(keyspace, resolveBufferSize());</span>
<span class="fc" id="L75">    }</span>

    @VisibleForTesting
    LogMessagesTable(String keyspace, int size)
    {
<span class="fc" id="L80">        super(TableMetadata.builder(keyspace, TABLE_NAME)</span>
<span class="fc" id="L81">                           .comment(TABLE_COMMENT)</span>
<span class="fc" id="L82">                           .kind(TableMetadata.Kind.VIRTUAL)</span>
<span class="fc" id="L83">                           .partitioner(new LocalPartitioner(TimestampType.instance))</span>
<span class="fc" id="L84">                           .addPartitionKeyColumn(TIMESTAMP_COLUMN_NAME, TimestampType.instance)</span>
<span class="fc" id="L85">                           .addClusteringColumn(ORDER_IN_MILLISECOND_COLUMN_NAME, Int32Type.instance)</span>
<span class="fc" id="L86">                           .addRegularColumn(LOGGER_COLUMN_NAME, UTF8Type.instance)</span>
<span class="fc" id="L87">                           .addRegularColumn(LEVEL_COLUMN_NAME, UTF8Type.instance)</span>
<span class="fc" id="L88">                           .addRegularColumn(MESSAGE_COLUMN_NAME, UTF8Type.instance).build());</span>

<span class="fc" id="L90">        logger.debug(&quot;capacity of virtual table {} is set to be at most {} rows&quot;, metadata().toString(), size);</span>
<span class="fc" id="L91">        buffer = BoundedLinkedList.create(size);</span>
<span class="fc" id="L92">    }</span>

    @Override
    public DataSet data()
    {
<span class="fc" id="L97">        SimpleDataSet result = new SimpleDataSet(metadata(), DecoratedKey.comparator.reversed());</span>

<span class="fc" id="L99">        synchronized (buffer)</span>
        {
<span class="fc" id="L101">            long milliSecondsOfPreviousLog = 0;</span>
            long milliSecondsOfCurrentLog;

<span class="fc" id="L104">            int index = 0;</span>

<span class="fc" id="L106">            Iterator&lt;LogMessage&gt; iterator = buffer.listIterator();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">            while (iterator.hasNext())</span>
            {
<span class="fc" id="L109">                LogMessage log = iterator.next();</span>

<span class="fc" id="L111">                milliSecondsOfCurrentLog = log.timestamp;</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">                if (milliSecondsOfPreviousLog == milliSecondsOfCurrentLog)</span>
<span class="fc" id="L113">                    ++index;</span>
                else
<span class="fc" id="L115">                    index = 0;</span>

<span class="fc" id="L117">                milliSecondsOfPreviousLog = milliSecondsOfCurrentLog;</span>

<span class="fc" id="L119">                result.row(new Date(log.timestamp), index)</span>
<span class="fc" id="L120">                      .column(LOGGER_COLUMN_NAME, log.logger)</span>
<span class="fc" id="L121">                      .column(LEVEL_COLUMN_NAME, log.level)</span>
<span class="fc" id="L122">                      .column(MESSAGE_COLUMN_NAME, log.message);</span>
<span class="fc" id="L123">            }</span>
<span class="fc" id="L124">        }</span>

<span class="fc" id="L126">        return result;</span>
    }

    public void add(LoggingEvent event)
    {
<span class="fc" id="L131">        buffer.add(new LogMessage(event));</span>
<span class="fc" id="L132">    }</span>

    @Override
    public void truncate()
    {
<span class="fc" id="L137">        buffer.clear();</span>
<span class="fc" id="L138">    }</span>

    @Override
    public boolean allowFilteringImplicitly()
    {
<span class="fc" id="L143">        return false;</span>
    }

    @VisibleForTesting
    static int resolveBufferSize()
    {
<span class="fc" id="L149">        int size = CassandraRelevantProperties.LOGS_VIRTUAL_TABLE_MAX_ROWS.getInt();</span>
<span class="fc bfc" id="L150" title="All 4 branches covered.">        return (size &lt; LOGS_VIRTUAL_TABLE_MIN_ROWS || size &gt; LOGS_VIRTUAL_TABLE_MAX_ROWS)</span>
<span class="fc" id="L151">               ? LOGS_VIRTUAL_TABLE_DEFAULT_ROWS : size;</span>
    }

    @VisibleForTesting
    public static class LogMessage
    {
        public final long timestamp;
        public final String logger;
        public final String level;
        public final String message;

        public LogMessage(LoggingEvent event)
        {
<span class="fc" id="L164">            this(event.getTimeStamp(), event.getLoggerName(), event.getLevel().toString(), event.getFormattedMessage());</span>
<span class="fc" id="L165">        }</span>

        public LogMessage(long timestamp, String logger, String level, String message)
<span class="fc" id="L168">        {</span>
<span class="fc" id="L169">            this.timestamp = timestamp;</span>
<span class="fc" id="L170">            this.logger = logger;</span>
<span class="fc" id="L171">            this.level = level;</span>
<span class="fc" id="L172">            this.message = message;</span>
<span class="fc" id="L173">        }</span>
    }

    private static final class BoundedLinkedList&lt;T&gt; extends LinkedList&lt;T&gt;
    {
        private final int maxSize;

        public static &lt;T&gt; List&lt;T&gt; create(int size)
        {
<span class="fc" id="L182">            return Collections.synchronizedList(new BoundedLinkedList&lt;&gt;(size));</span>
        }

        private BoundedLinkedList(int maxSize)
<span class="fc" id="L186">        {</span>
<span class="fc" id="L187">            this.maxSize = maxSize;</span>
<span class="fc" id="L188">        }</span>

        @Override
        public boolean add(T t)
        {
<span class="fc bfc" id="L193" title="All 2 branches covered.">            if (size() == maxSize)</span>
<span class="fc" id="L194">                removeLast();</span>

<span class="fc" id="L196">            addFirst(t);</span>

<span class="fc" id="L198">            return true;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>