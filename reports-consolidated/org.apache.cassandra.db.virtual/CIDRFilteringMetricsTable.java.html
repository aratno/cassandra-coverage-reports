<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CIDRFilteringMetricsTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.db.virtual</a> &gt; <span class="el_source">CIDRFilteringMetricsTable.java</span></div><h1>CIDRFilteringMetricsTable.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.db.virtual;

import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.google.common.annotations.VisibleForTesting;

import com.codahale.metrics.Counter;
import com.codahale.metrics.Snapshot;
import org.apache.cassandra.auth.CassandraAuthorizer;
import org.apache.cassandra.config.DatabaseDescriptor;
import org.apache.cassandra.cql3.QueryOptions;
import org.apache.cassandra.cql3.QueryProcessor;
import org.apache.cassandra.cql3.UntypedResultSet;
import org.apache.cassandra.cql3.statements.SelectStatement;
import org.apache.cassandra.db.marshal.DoubleType;
import org.apache.cassandra.db.marshal.LongType;
import org.apache.cassandra.db.marshal.UTF8Type;
import org.apache.cassandra.dht.LocalPartitioner;
import org.apache.cassandra.metrics.CIDRAuthorizerMetrics;
import org.apache.cassandra.schema.SchemaConstants;
import org.apache.cassandra.schema.TableMetadata;
import org.apache.cassandra.service.ClientState;
import org.apache.cassandra.transport.messages.ResultMessage;
import org.apache.cassandra.utils.MBeanWrapper;

import static org.apache.cassandra.service.QueryState.forInternalCalls;
import static org.apache.cassandra.utils.Clock.Global.nanoTime;

/**
 * Virtual tables capturing metrics related to CIDR filtering
 */
public class CIDRFilteringMetricsTable implements CIDRFilteringMetricsTableMBean
{
    public static final String MBEAN_NAME = &quot;org.apache.cassandra.db:type=CIDRFilteringMetricsTable&quot;;

<span class="fc" id="L59">    private static final CIDRFilteringMetricsTable instance = new CIDRFilteringMetricsTable();</span>

    CIDRFilteringMetricsTable()
<span class="fc" id="L62">    {</span>
        // Register mbean for nodetool to access vtable entries
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (!MBeanWrapper.instance.isRegistered(MBEAN_NAME))</span>
<span class="fc" id="L65">            MBeanWrapper.instance.registerMBean(this, MBEAN_NAME);</span>
<span class="fc" id="L66">    }</span>

    public static Collection&lt;VirtualTable&gt; getAll(String keyspace)
    {
<span class="fc" id="L70">        return Arrays.asList(</span>
        new CIDRFilteringMetricsCountsTable(keyspace),
        new CIDRFilteringMetricsLatenciesTable(keyspace)
        );
    }

    /**
     * Virtual table capturing counts i.e, non-latency metrics related to CIDR filtering
     */
    public static class CIDRFilteringMetricsCountsTable extends AbstractVirtualTable
    {
        public static final String TABLE_NAME = &quot;cidr_filtering_metrics_counts&quot;;

        public static final String NAME_COL = &quot;name&quot;;
        public static final String VALUE_COL = &quot;value&quot;;
        public static final String CIDR_ACCESSES_ACCEPTED_COUNT_NAME_PREFIX = &quot;Number of CIDR accesses accepted from CIDR group - &quot;;
        public static final String CIDR_ACCESSES_REJECTED_COUNT_NAME_PREFIX = &quot;Number of CIDR accesses rejected from CIDR group - &quot;;
        public static final String CIDR_GROUPS_CACHE_RELOAD_COUNT_NAME = &quot;CIDR groups cache reload count&quot;;

        @VisibleForTesting
        CIDRFilteringMetricsCountsTable(String keyspace)
        {
<span class="fc" id="L92">            super(TableMetadata.builder(keyspace, TABLE_NAME)</span>
<span class="fc" id="L93">                               .comment(&quot;Count metrics specific to CIDR filtering&quot;)</span>
<span class="fc" id="L94">                               .kind(TableMetadata.Kind.VIRTUAL)</span>
<span class="fc" id="L95">                               .partitioner(new LocalPartitioner(UTF8Type.instance))</span>
<span class="fc" id="L96">                               .addPartitionKeyColumn(NAME_COL, UTF8Type.instance)</span>
<span class="fc" id="L97">                               .addRegularColumn(VALUE_COL, LongType.instance)</span>
<span class="fc" id="L98">                               .build());</span>
<span class="fc" id="L99">        }</span>

        private void addRow(SimpleDataSet dataSet, String name, long value)
        {
<span class="fc" id="L103">            dataSet.row(name)</span>
<span class="fc" id="L104">                   .column(VALUE_COL, value);</span>
<span class="fc" id="L105">        }</span>

        @Override
        public DataSet data()
        {
<span class="fc" id="L110">            SimpleDataSet result = new SimpleDataSet(metadata());</span>

<span class="fc" id="L112">            CIDRAuthorizerMetrics cidrAuthorizerMetrics = DatabaseDescriptor.getCIDRAuthorizer().getCidrAuthorizerMetrics();</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">            for (Map.Entry&lt;String, Counter&gt; entry : cidrAuthorizerMetrics.acceptedCidrAccessCount.entrySet())</span>
            {
<span class="fc" id="L116">                addRow(result, CIDR_ACCESSES_ACCEPTED_COUNT_NAME_PREFIX + entry.getKey(),</span>
<span class="fc" id="L117">                       entry.getValue().getCount());</span>
<span class="fc" id="L118">            }</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">            for (Map.Entry&lt;String, Counter&gt; entry : cidrAuthorizerMetrics.rejectedCidrAccessCount.entrySet())</span>
            {
<span class="fc" id="L122">                addRow(result, CIDR_ACCESSES_REJECTED_COUNT_NAME_PREFIX + entry.getKey(),</span>
<span class="fc" id="L123">                       entry.getValue().getCount());</span>
<span class="fc" id="L124">            }</span>

<span class="fc" id="L126">            addRow(result, CIDR_GROUPS_CACHE_RELOAD_COUNT_NAME, cidrAuthorizerMetrics.cacheReloadCount.getCount());</span>

<span class="fc" id="L128">            return result;</span>
        }
    }

    /**
     * Virtual table capturing latency metrics related to CIDR filtering
     */
    public static class CIDRFilteringMetricsLatenciesTable extends AbstractVirtualTable
    {
        public static final String TABLE_NAME = &quot;cidr_filtering_metrics_latencies&quot;;

        public static final String NAME_COL = &quot;name&quot;;
        public static final String P50_COL = &quot;p50th&quot;;
        public static final String P95_COL = &quot;p95th&quot;;
        public static final String P99_COL = &quot;p99th&quot;;
        public static final String P999_COL = &quot;p999th&quot;;
        public static final String MAX_COL = &quot;max&quot;;

        public static final String CIDR_CHECKS_LATENCY_NAME = &quot;CIDR checks latency (ns)&quot;;
        public static final String CIDR_GROUPS_CACHE_RELOAD_LATENCY_NAME = &quot;CIDR groups cache reload latency (ns)&quot;;
        public static final String LOOKUP_CIDR_GROUPS_FOR_IP_LATENCY_NAME = &quot;Lookup IP in CIDR groups cache latency (ns)&quot;;

        @VisibleForTesting
        CIDRFilteringMetricsLatenciesTable(String keyspace)
        {
<span class="fc" id="L153">            super(TableMetadata.builder(keyspace, TABLE_NAME)</span>
<span class="fc" id="L154">                               .comment(&quot;Latency metrics specific to CIDR filtering&quot;)</span>
<span class="fc" id="L155">                               .kind(TableMetadata.Kind.VIRTUAL)</span>
<span class="fc" id="L156">                               .partitioner(new LocalPartitioner(UTF8Type.instance))</span>
<span class="fc" id="L157">                               .addPartitionKeyColumn(NAME_COL, UTF8Type.instance)</span>
<span class="fc" id="L158">                               .addRegularColumn(P50_COL, DoubleType.instance)</span>
<span class="fc" id="L159">                               .addRegularColumn(P95_COL, DoubleType.instance)</span>
<span class="fc" id="L160">                               .addRegularColumn(P99_COL, DoubleType.instance)</span>
<span class="fc" id="L161">                               .addRegularColumn(P999_COL, DoubleType.instance)</span>
<span class="fc" id="L162">                               .addRegularColumn(MAX_COL, DoubleType.instance)</span>
<span class="fc" id="L163">                               .build());</span>
<span class="fc" id="L164">        }</span>

        private void addRow(SimpleDataSet dataSet, String name, Snapshot snapshot)
        {
<span class="fc" id="L168">            dataSet.row(name)</span>
<span class="fc" id="L169">                   .column(P50_COL, snapshot.getMedian())</span>
<span class="fc" id="L170">                   .column(P95_COL, snapshot.get95thPercentile())</span>
<span class="fc" id="L171">                   .column(P99_COL, snapshot.get99thPercentile())</span>
<span class="fc" id="L172">                   .column(P999_COL, snapshot.get999thPercentile())</span>
<span class="fc" id="L173">                   .column(MAX_COL, (double) snapshot.getMax());</span>
<span class="fc" id="L174">        }</span>

        @Override
        public DataSet data()
        {
<span class="fc" id="L179">            SimpleDataSet result = new SimpleDataSet(metadata());</span>

            CIDRAuthorizerMetrics cidrAuthorizerMetrics =
<span class="fc" id="L182">            DatabaseDescriptor.getCIDRAuthorizer().getCidrAuthorizerMetrics();</span>

<span class="fc" id="L184">            addRow(result, CIDR_CHECKS_LATENCY_NAME, cidrAuthorizerMetrics.cidrChecksLatency.getSnapshot());</span>
<span class="fc" id="L185">            addRow(result, CIDR_GROUPS_CACHE_RELOAD_LATENCY_NAME,</span>
<span class="fc" id="L186">                   cidrAuthorizerMetrics.cacheReloadLatency.getSnapshot());</span>
<span class="fc" id="L187">            addRow(result, LOOKUP_CIDR_GROUPS_FOR_IP_LATENCY_NAME,</span>
<span class="fc" id="L188">                   cidrAuthorizerMetrics.lookupCidrGroupsForIpLatency.getSnapshot());</span>

<span class="fc" id="L190">            return result;</span>
        }
    }

    private UntypedResultSet retrieveRows(SelectStatement statement)
    {
<span class="fc" id="L196">        QueryOptions options = QueryOptions.forInternalCalls(CassandraAuthorizer.authReadConsistencyLevel(),</span>
<span class="fc" id="L197">                                                             Collections.emptyList());</span>

<span class="fc" id="L199">        ResultMessage.Rows rows = statement.execute(forInternalCalls(), options, nanoTime());</span>
<span class="fc" id="L200">        return UntypedResultSet.create(rows.result);</span>
    }

    public Map&lt;String, Long&gt; getCountsMetricsFromVtable()
    {
<span class="fc" id="L205">        String countsMetricsTableName = SchemaConstants.VIRTUAL_VIEWS + '.' +</span>
                                        CIDRFilteringMetricsTable.CIDRFilteringMetricsCountsTable.TABLE_NAME;

<span class="fc" id="L208">        SelectStatement getCountsMetricsStatement =</span>
<span class="fc" id="L209">            (SelectStatement) QueryProcessor.getStatement(String.format(&quot;SELECT * FROM %s&quot;, countsMetricsTableName),</span>
<span class="fc" id="L210">                                                          ClientState.forInternalCalls());</span>

<span class="fc" id="L212">        Map&lt;String, Long&gt; metrics = new HashMap&lt;&gt;();</span>

<span class="fc" id="L214">        UntypedResultSet result = retrieveRows(getCountsMetricsStatement);</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">        for (UntypedResultSet.Row row : result)</span>
        {
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (!row.has(CIDRFilteringMetricsTable.CIDRFilteringMetricsCountsTable.NAME_COL) ||</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">                !row.has(CIDRFilteringMetricsTable.CIDRFilteringMetricsCountsTable.VALUE_COL))</span>
<span class="nc" id="L219">                throw new RuntimeException(&quot;Invalid row &quot; + row + &quot; in table: &quot; + countsMetricsTableName);</span>

<span class="fc" id="L221">            metrics.put(row.getString(CIDRFilteringMetricsTable.CIDRFilteringMetricsCountsTable.NAME_COL),</span>
<span class="fc" id="L222">                        row.getLong(CIDRFilteringMetricsTable.CIDRFilteringMetricsCountsTable.VALUE_COL));</span>
<span class="fc" id="L223">        }</span>

<span class="fc" id="L225">        return metrics;</span>
    }

    public Map&lt;String, List&lt;Double&gt;&gt; getLatenciesMetricsFromVtable()
    {
<span class="fc" id="L230">        String latenciesMetricsTableName = SchemaConstants.VIRTUAL_VIEWS + '.' +</span>
                                           CIDRFilteringMetricsTable.CIDRFilteringMetricsLatenciesTable.TABLE_NAME;

<span class="fc" id="L233">        SelectStatement getLatenciesMetricsStatement =</span>
<span class="fc" id="L234">            (SelectStatement) QueryProcessor.getStatement(String.format(&quot;SELECT * FROM %s&quot;, latenciesMetricsTableName),</span>
<span class="fc" id="L235">                                                          ClientState.forInternalCalls());</span>

<span class="fc" id="L237">        Map&lt;String, List&lt;Double&gt;&gt; metrics = new HashMap&lt;&gt;();</span>

<span class="fc" id="L239">        UntypedResultSet result = retrieveRows(getLatenciesMetricsStatement);</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">        for (UntypedResultSet.Row row : result)</span>
        {
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">            if (!row.has(CIDRFilteringMetricsLatenciesTable.NAME_COL) ||</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">                !row.has(CIDRFilteringMetricsLatenciesTable.P50_COL))</span>
<span class="nc" id="L244">                throw new RuntimeException(&quot;Invalid row &quot; + row + &quot; in table: &quot; + latenciesMetricsTableName);</span>

<span class="fc" id="L246">            metrics.put(row.getString(CIDRFilteringMetricsTable.CIDRFilteringMetricsLatenciesTable.NAME_COL),</span>
<span class="fc" id="L247">                        Arrays.asList(row.getDouble(CIDRFilteringMetricsLatenciesTable.P50_COL),</span>
<span class="fc" id="L248">                                      row.getDouble(CIDRFilteringMetricsLatenciesTable.P95_COL),</span>
<span class="fc" id="L249">                                      row.getDouble(CIDRFilteringMetricsLatenciesTable.P99_COL),</span>
<span class="fc" id="L250">                                      row.getDouble(CIDRFilteringMetricsLatenciesTable.P999_COL),</span>
<span class="fc" id="L251">                                      row.getDouble(CIDRFilteringMetricsLatenciesTable.MAX_COL)));</span>
<span class="fc" id="L252">        }</span>

<span class="fc" id="L254">        return metrics;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>