<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaEvent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.schema</a> &gt; <span class="el_source">SchemaEvent.java</span></div><h1>SchemaEvent.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.schema;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.StreamSupport;
import javax.annotation.Nullable;

import com.google.common.collect.ImmutableCollection;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Lists;
import com.google.common.collect.MapDifference;

import org.apache.cassandra.diag.DiagnosticEvent;
import org.apache.cassandra.utils.Collectors3;

public final class SchemaEvent extends DiagnosticEvent
{
    private final SchemaEventType type;

    private final ImmutableCollection&lt;String&gt; keyspaces;
    private final ImmutableMap&lt;String, String&gt; indexTables;
    private final ImmutableCollection&lt;String&gt; tables;
    private final ImmutableCollection&lt;String&gt; nonSystemKeyspaces;
    private final ImmutableCollection&lt;String&gt; userKeyspaces;
    private final int numberOfTables;
    private final UUID version;

    @Nullable
    private final KeyspaceMetadata ksUpdate;
    @Nullable
    private final KeyspaceMetadata previous;
    @Nullable
    private final KeyspaceMetadata.KeyspaceDiff ksDiff;
    @Nullable
    private final TableMetadata tableUpdate;
    @Nullable
    private final Tables.TablesDiff tablesDiff;
    @Nullable
    private final Views.ViewsDiff viewsDiff;
    @Nullable
    private final MapDifference&lt;String, TableMetadata&gt; indexesDiff;

<span class="fc" id="L66">    public enum SchemaEventType</span>
    {
<span class="fc" id="L68">        KS_METADATA_LOADED,</span>
<span class="fc" id="L69">        KS_METADATA_RELOADED,</span>
<span class="fc" id="L70">        KS_METADATA_REMOVED,</span>
<span class="fc" id="L71">        VERSION_UPDATED,</span>
<span class="fc" id="L72">        VERSION_ANOUNCED,</span>
<span class="fc" id="L73">        KS_CREATING,</span>
<span class="fc" id="L74">        KS_CREATED,</span>
<span class="fc" id="L75">        KS_ALTERING,</span>
<span class="fc" id="L76">        KS_ALTERED,</span>
<span class="fc" id="L77">        KS_DROPPING,</span>
<span class="fc" id="L78">        KS_DROPPED,</span>
<span class="fc" id="L79">        TABLE_CREATING,</span>
<span class="fc" id="L80">        TABLE_CREATED,</span>
<span class="fc" id="L81">        TABLE_ALTERING,</span>
<span class="fc" id="L82">        TABLE_ALTERED,</span>
<span class="fc" id="L83">        TABLE_DROPPING,</span>
<span class="fc" id="L84">        TABLE_DROPPED,</span>
<span class="fc" id="L85">        SCHEMATA_LOADING,</span>
<span class="fc" id="L86">        SCHEMATA_LOADED,</span>
<span class="fc" id="L87">        SCHEMATA_CLEARED</span>
    }

    SchemaEvent(SchemaEventType type, Schema schema, @Nullable KeyspaceMetadata ksUpdate,
                @Nullable KeyspaceMetadata previous, @Nullable KeyspaceMetadata.KeyspaceDiff ksDiff,
                @Nullable TableMetadata tableUpdate, @Nullable Tables.TablesDiff tablesDiff,
                @Nullable Views.ViewsDiff viewsDiff, @Nullable MapDifference&lt;String, TableMetadata&gt; indexesDiff)
<span class="fc" id="L94">    {</span>
<span class="fc" id="L95">        this.type = type;</span>
<span class="fc" id="L96">        this.ksUpdate = ksUpdate;</span>
<span class="fc" id="L97">        this.previous = previous;</span>
<span class="fc" id="L98">        this.ksDiff = ksDiff;</span>
<span class="fc" id="L99">        this.tableUpdate = tableUpdate;</span>
<span class="fc" id="L100">        this.tablesDiff = tablesDiff;</span>
<span class="fc" id="L101">        this.viewsDiff = viewsDiff;</span>
<span class="fc" id="L102">        this.indexesDiff = indexesDiff;</span>

<span class="fc" id="L104">        this.keyspaces = schema.distributedAndLocalKeyspaces().names();</span>
<span class="fc" id="L105">        this.nonSystemKeyspaces = schema.distributedKeyspaces().names();</span>
<span class="fc" id="L106">        this.userKeyspaces = schema.getUserKeyspaces().names();</span>
<span class="fc" id="L107">        this.numberOfTables = schema.getNumberOfTables();</span>
<span class="fc" id="L108">        this.version = schema.getVersion();</span>

<span class="fc" id="L110">        this.indexTables = schema.distributedKeyspaces().stream()</span>
<span class="fc" id="L111">                                 .flatMap(ks -&gt; ks.tables.indexTables().entrySet().stream())</span>
<span class="pc" id="L112">                                 .collect(Collectors3.toImmutableMap(e -&gt; String.format(&quot;%s,%s&quot;, e.getValue().keyspace, e.getKey()),</span>
<span class="nc" id="L113">                                                                     e -&gt; String.format(&quot;%s,%s,%s&quot;, e.getValue().id.toHexString(), e.getValue().keyspace, e.getValue().name)));</span>

<span class="fc" id="L115">        this.tables = schema.distributedKeyspaces().stream()</span>
<span class="fc" id="L116">                            .flatMap(ks -&gt; StreamSupport.stream(ks.tablesAndViews().spliterator(), false))</span>
<span class="fc" id="L117">                            .map(e -&gt; String.format(&quot;%s,%s,%s&quot;, e.id.toHexString(), e.keyspace, e.name))</span>
<span class="fc" id="L118">                            .collect(Collectors3.toImmutableList());</span>
<span class="fc" id="L119">    }</span>

    public SchemaEventType getType()
    {
<span class="fc" id="L123">        return type;</span>
    }

    public Map&lt;String, Serializable&gt; toMap()
    {
<span class="fc" id="L128">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="fc" id="L129">        ret.put(&quot;keyspaces&quot;, this.keyspaces);</span>
<span class="fc" id="L130">        ret.put(&quot;nonSystemKeyspaces&quot;, this.nonSystemKeyspaces);</span>
<span class="fc" id="L131">        ret.put(&quot;userKeyspaces&quot;, this.userKeyspaces);</span>
<span class="fc" id="L132">        ret.put(&quot;numberOfTables&quot;, this.numberOfTables);</span>
<span class="fc" id="L133">        ret.put(&quot;version&quot;, this.version);</span>
<span class="fc" id="L134">        ret.put(&quot;tables&quot;, this.tables);</span>
<span class="fc" id="L135">        ret.put(&quot;indexTables&quot;, this.indexTables);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (ksUpdate != null) ret.put(&quot;ksMetadataUpdate&quot;, repr(ksUpdate));</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (previous != null) ret.put(&quot;ksMetadataPrevious&quot;, repr(previous));</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (ksDiff != null)</span>
        {
<span class="nc" id="L140">            HashMap&lt;String, Serializable&gt; ks = new HashMap&lt;&gt;();</span>
<span class="nc" id="L141">            ks.put(&quot;before&quot;, repr(ksDiff.before));</span>
<span class="nc" id="L142">            ks.put(&quot;after&quot;, repr(ksDiff.after));</span>
<span class="nc" id="L143">            ks.put(&quot;tables&quot;, repr(ksDiff.tables));</span>
<span class="nc" id="L144">            ks.put(&quot;views&quot;, repr(ksDiff.views));</span>
<span class="nc" id="L145">            ks.put(&quot;types&quot;, repr(ksDiff.types));</span>
<span class="nc" id="L146">            ks.put(&quot;udas&quot;, repr(ksDiff.udas));</span>
<span class="nc" id="L147">            ks.put(&quot;udfs&quot;, repr(ksDiff.udfs));</span>
<span class="nc" id="L148">            ret.put(&quot;ksDiff&quot;, ks);</span>
        }
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (tableUpdate != null) ret.put(&quot;tableMetadataUpdate&quot;, repr(tableUpdate));</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (tablesDiff != null) ret.put(&quot;tablesDiff&quot;, repr(tablesDiff));</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (viewsDiff != null) ret.put(&quot;viewsDiff&quot;, repr(viewsDiff));</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (indexesDiff != null) ret.put(&quot;indexesDiff&quot;, Lists.newArrayList(indexesDiff.entriesDiffering().keySet()));</span>
<span class="fc" id="L154">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(Diff&lt;?, ?&gt; diff)
    {
<span class="nc" id="L159">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (diff.created != null) ret.put(&quot;created&quot;, diff.created.toString());</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (diff.dropped != null) ret.put(&quot;dropped&quot;, diff.dropped.toString());</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (diff.altered != null)</span>
<span class="nc" id="L163">            ret.put(&quot;created&quot;, Lists.newArrayList(diff.altered.stream().map(Diff.Altered::toString).iterator()));</span>
<span class="nc" id="L164">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(KeyspaceMetadata ksm)
    {
<span class="nc" id="L169">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc" id="L170">        ret.put(&quot;name&quot;, ksm.name);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (ksm.kind != null) ret.put(&quot;kind&quot;, ksm.kind.name());</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (ksm.params != null) ret.put(&quot;params&quot;, ksm.params.toString());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (ksm.tables != null) ret.put(&quot;tables&quot;, ksm.tables.toString());</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (ksm.views != null) ret.put(&quot;views&quot;, ksm.views.toString());</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (ksm.userFunctions != null) ret.put(&quot;functions&quot;, ksm.userFunctions.toString());</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (ksm.types != null) ret.put(&quot;types&quot;, ksm.types.toString());</span>
<span class="nc" id="L177">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(TableMetadata table)
    {
<span class="nc" id="L182">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc" id="L183">        ret.put(&quot;id&quot;, table.id.toHexString());</span>
<span class="nc" id="L184">        ret.put(&quot;name&quot;, table.name);</span>
<span class="nc" id="L185">        ret.put(&quot;keyspace&quot;, table.keyspace);</span>
<span class="nc" id="L186">        ret.put(&quot;partitioner&quot;, table.partitioner.toString());</span>
<span class="nc" id="L187">        ret.put(&quot;kind&quot;, table.kind.name());</span>
<span class="nc" id="L188">        ret.put(&quot;flags&quot;, Lists.newArrayList(table.flags.stream().map(Enum::name).iterator()));</span>
<span class="nc" id="L189">        ret.put(&quot;params&quot;, repr(table.params));</span>
<span class="nc" id="L190">        ret.put(&quot;indexes&quot;, Lists.newArrayList(table.indexes.stream().map(this::repr).iterator()));</span>
<span class="nc" id="L191">        ret.put(&quot;triggers&quot;, Lists.newArrayList(repr(table.triggers)));</span>
<span class="nc" id="L192">        ret.put(&quot;columns&quot;, Lists.newArrayList(table.columns.values().stream().map(this::repr).iterator()));</span>
<span class="nc" id="L193">        ret.put(&quot;droppedColumns&quot;, Lists.newArrayList(table.droppedColumns.values().stream().map(this::repr).iterator()));</span>
<span class="nc" id="L194">        ret.put(&quot;isCompactTable&quot;, table.isCompactTable());</span>
<span class="nc" id="L195">        ret.put(&quot;isCompound&quot;, TableMetadata.Flag.isCompound(table.flags));</span>
<span class="nc" id="L196">        ret.put(&quot;isCounter&quot;, table.isCounter());</span>
<span class="nc" id="L197">        ret.put(&quot;isCQLTable&quot;, TableMetadata.Flag.isCQLTable(table.flags));</span>
<span class="nc" id="L198">        ret.put(&quot;isDense&quot;, TableMetadata.Flag.isDense(table.flags));</span>
<span class="nc" id="L199">        ret.put(&quot;isIndex&quot;, table.isIndex());</span>
<span class="nc" id="L200">        ret.put(&quot;isStaticCompactTable&quot;, TableMetadata.Flag.isStaticCompactTable(table.flags));</span>
<span class="nc" id="L201">        ret.put(&quot;isView&quot;, table.isView());</span>
<span class="nc" id="L202">        ret.put(&quot;isVirtual&quot;, table.isVirtual());</span>
<span class="nc" id="L203">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(TableParams params)
    {
<span class="nc" id="L208">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (params == null) return ret;</span>
<span class="nc" id="L210">        ret.put(&quot;minIndexInterval&quot;, params.minIndexInterval);</span>
<span class="nc" id="L211">        ret.put(&quot;maxIndexInterval&quot;, params.maxIndexInterval);</span>
<span class="nc" id="L212">        ret.put(&quot;defaultTimeToLive&quot;, params.defaultTimeToLive);</span>
<span class="nc" id="L213">        ret.put(&quot;gcGraceSeconds&quot;, params.gcGraceSeconds);</span>
<span class="nc" id="L214">        ret.put(&quot;bloomFilterFpChance&quot;, params.bloomFilterFpChance);</span>
<span class="nc" id="L215">        ret.put(&quot;cdc&quot;, params.cdc);</span>
<span class="nc" id="L216">        ret.put(&quot;crcCheckChance&quot;, params.crcCheckChance);</span>
<span class="nc" id="L217">        ret.put(&quot;memtableFlushPeriodInMs&quot;, params.memtableFlushPeriodInMs);</span>
<span class="nc" id="L218">        ret.put(&quot;comment&quot;, params.comment);</span>
<span class="nc" id="L219">        ret.put(&quot;caching&quot;, repr(params.caching));</span>
<span class="nc" id="L220">        ret.put(&quot;compaction&quot;, repr(params.compaction));</span>
<span class="nc" id="L221">        ret.put(&quot;compression&quot;, repr(params.compression));</span>
<span class="nc" id="L222">        ret.put(&quot;memtable&quot;, repr(params.memtable));</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (params.speculativeRetry != null) ret.put(&quot;speculativeRetry&quot;, params.speculativeRetry.kind().name());</span>
<span class="nc" id="L224">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(CachingParams caching)
    {
<span class="nc" id="L229">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (caching == null) return ret;</span>
<span class="nc" id="L231">        ret.putAll(caching.asMap());</span>
<span class="nc" id="L232">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(CompactionParams comp)
    {
<span class="nc" id="L237">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (comp == null) return ret;</span>
<span class="nc" id="L239">        ret.putAll(comp.asMap());</span>
<span class="nc" id="L240">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(CompressionParams compr)
    {
<span class="nc" id="L245">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">        if (compr == null) return ret;</span>
<span class="nc" id="L247">        ret.putAll(compr.asMap());</span>
<span class="nc" id="L248">        return ret;</span>
    }

    private String repr(MemtableParams params)
    {
<span class="nc" id="L253">        return params.configurationKey();</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(IndexMetadata index)
    {
<span class="nc" id="L258">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (index == null) return ret;</span>
<span class="nc" id="L260">        ret.put(&quot;name&quot;, index.name);</span>
<span class="nc" id="L261">        ret.put(&quot;kind&quot;, index.kind.name());</span>
<span class="nc" id="L262">        ret.put(&quot;id&quot;, index.id);</span>
<span class="nc" id="L263">        ret.put(&quot;options&quot;, new HashMap&lt;&gt;(index.options));</span>
<span class="nc" id="L264">        ret.put(&quot;isCustom&quot;, index.isCustom());</span>
<span class="nc" id="L265">        ret.put(&quot;isKeys&quot;, index.isKeys());</span>
<span class="nc" id="L266">        ret.put(&quot;isComposites&quot;, index.isComposites());</span>
<span class="nc" id="L267">        return ret;</span>
    }

    private List&lt;Map&lt;String, Serializable&gt;&gt; repr(Triggers triggers)
    {
<span class="nc" id="L272">        List&lt;Map&lt;String, Serializable&gt;&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (triggers == null) return ret;</span>
<span class="nc" id="L274">        Iterator&lt;TriggerMetadata&gt; iter = triggers.iterator();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        while (iter.hasNext()) ret.add(repr(iter.next()));</span>
<span class="nc" id="L276">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(TriggerMetadata trigger)
    {
<span class="nc" id="L281">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (trigger == null) return ret;</span>
<span class="nc" id="L283">        ret.put(&quot;name&quot;, trigger.name);</span>
<span class="nc" id="L284">        ret.put(&quot;classOption&quot;, trigger.classOption);</span>
<span class="nc" id="L285">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(ColumnMetadata col)
    {
<span class="nc" id="L290">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (col == null) return ret;</span>
<span class="nc" id="L292">        ret.put(&quot;name&quot;, col.name.toString());</span>
<span class="nc" id="L293">        ret.put(&quot;kind&quot;, col.kind.name());</span>
<span class="nc" id="L294">        ret.put(&quot;type&quot;, col.type.toString());</span>
<span class="nc" id="L295">        ret.put(&quot;ksName&quot;, col.ksName);</span>
<span class="nc" id="L296">        ret.put(&quot;cfName&quot;, col.cfName);</span>
<span class="nc" id="L297">        ret.put(&quot;position&quot;, col.position());</span>
<span class="nc" id="L298">        ret.put(&quot;clusteringOrder&quot;, col.clusteringOrder().name());</span>
<span class="nc" id="L299">        ret.put(&quot;isComplex&quot;, col.isComplex());</span>
<span class="nc" id="L300">        ret.put(&quot;isStatic&quot;, col.isStatic());</span>
<span class="nc" id="L301">        ret.put(&quot;isPrimaryKeyColumn&quot;, col.isPrimaryKeyColumn());</span>
<span class="nc" id="L302">        ret.put(&quot;isSimple&quot;, col.isSimple());</span>
<span class="nc" id="L303">        ret.put(&quot;isPartitionKey&quot;, col.isPartitionKey());</span>
<span class="nc" id="L304">        ret.put(&quot;isClusteringColumn&quot;, col.isClusteringColumn());</span>
<span class="nc" id="L305">        ret.put(&quot;isCounterColumn&quot;, col.isCounterColumn());</span>
<span class="nc" id="L306">        ret.put(&quot;isRegular&quot;, col.isRegular());</span>
<span class="nc" id="L307">        return ret;</span>
    }

    private HashMap&lt;String, Serializable&gt; repr(DroppedColumn column)
    {
<span class="nc" id="L312">        HashMap&lt;String, Serializable&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (column == null) return ret;</span>
<span class="nc" id="L314">        ret.put(&quot;droppedTime&quot;, column.droppedTime);</span>
<span class="nc" id="L315">        ret.put(&quot;column&quot;, repr(column.column));</span>
<span class="nc" id="L316">        return ret;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>