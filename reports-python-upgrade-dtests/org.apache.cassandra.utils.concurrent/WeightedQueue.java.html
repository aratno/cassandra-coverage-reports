<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeightedQueue.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.utils.concurrent</a> &gt; <span class="el_source">WeightedQueue.java</span></div><h1>WeightedQueue.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.utils.concurrent;

import java.util.Collection;
import java.util.Iterator;
import java.util.Objects;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.TimeUnit;

import com.google.common.base.Preconditions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static org.apache.cassandra.utils.concurrent.BlockingQueues.newBlockingQueue;
import static org.apache.cassandra.utils.concurrent.Semaphore.newSemaphore;

/**
 * Weighted queue is a wrapper around any blocking queue that turns it into a blocking weighted queue. The queue
 * will weigh each element being added and removed. Adding to the queue is blocked if adding would violate
 * the weight bound.
 *
 * If an element weighs in at larger than the capacity of the queue then exactly one such element will be allowed
 * into the queue at a time.
 *
 * If the weight of an object changes after it is added you are going to have a bad time. Checking weight should be
 * cheap so memoize expensive to compute weights. If weight throws that can also result in leaked permits so it's
 * always a good idea to memoize weight so it doesn't throw.
 *
 * In the interests of not writing unit tests for methods no one uses there is a lot of UnsupportedOperationException.
 * If you need them then add them and add proper unit tests to WeightedQueueTest. &quot;Good&quot; tests. 100% coverage including
 * exception paths and resource leaks.
 **/
public class WeightedQueue&lt;T&gt; implements BlockingQueue&lt;T&gt;
{
<span class="nc" id="L52">    private static final Logger logger = LoggerFactory.getLogger(WeightedQueue.class);</span>
<span class="nc" id="L53">    public static final Weigher NATURAL_WEIGHER = (Weigher&lt;Object&gt;) weighable -&gt;</span>
    {
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (weighable instanceof Weighable)</span>
        {
<span class="nc" id="L57">            return ((Weighable)weighable).weight();</span>
        }
<span class="nc" id="L59">        return 1;</span>
    };

    private final Weigher&lt;T&gt; weigher;
    private final BlockingQueue&lt;T&gt; queue;
    private final int maxWeight;
    final Semaphore availableWeight;

    public boolean add(T e)
    {
<span class="nc" id="L69">        throw new UnsupportedOperationException();</span>
    }

    public boolean offer(T t)
    {
<span class="nc" id="L74">        Preconditions.checkNotNull(t);</span>
<span class="nc" id="L75">        boolean acquired = tryAcquireWeight(t);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (acquired)</span>
        {
<span class="nc" id="L78">            boolean offered = false;</span>
            try
            {
<span class="nc" id="L81">                offered = queue.offer(t);</span>
<span class="nc" id="L82">                return offered;</span>
            }
            finally
            {
<span class="nc bnc" id="L86" title="All 2 branches missed.">                if (!offered)</span>
                {
<span class="nc" id="L88">                    releaseWeight(t);</span>
                }
            }
        }
<span class="nc" id="L92">        return false;</span>
    }

    public T remove()
    {
<span class="nc" id="L97">        throw new UnsupportedOperationException();</span>
    }

    public T poll()
    {
<span class="nc" id="L102">        T retval = queue.poll();</span>
<span class="nc" id="L103">        releaseWeight(retval);</span>
<span class="nc" id="L104">        return retval;</span>
    }

    public T element()
    {
<span class="nc" id="L109">        throw new UnsupportedOperationException();</span>
    }

    public T peek()
    {
<span class="nc" id="L114">        throw new UnsupportedOperationException();</span>
    }

    public void put(T t) throws InterruptedException
    {
<span class="nc" id="L119">        Preconditions.checkNotNull(t);</span>
<span class="nc" id="L120">        acquireWeight(t, 0, null);</span>
<span class="nc" id="L121">        boolean put = false;</span>
        try
        {
<span class="nc" id="L124">            queue.put(t);</span>
<span class="nc" id="L125">            put = true;</span>
        }
        finally
        {
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (!put)</span>
            {
<span class="nc" id="L131">                releaseWeight(t);</span>
            }
        }
<span class="nc" id="L134">    }</span>

    public boolean offer(T t, long timeout, TimeUnit unit) throws InterruptedException
    {
<span class="nc" id="L138">        Preconditions.checkNotNull(t);</span>
<span class="nc" id="L139">        Preconditions.checkNotNull(unit);</span>
<span class="nc" id="L140">        boolean acquired = acquireWeight(t, timeout, unit);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (acquired)</span>
        {
<span class="nc" id="L143">            boolean offered = false;</span>
            try
            {
<span class="nc" id="L146">                offered = queue.offer(t, timeout, unit);</span>
<span class="nc" id="L147">                return offered;</span>
            }
            finally
            {
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (!offered)</span>
                {
<span class="nc" id="L153">                    releaseWeight(t);</span>
                }
            }
        }
<span class="nc" id="L157">        return false;</span>
    }

    public T take() throws InterruptedException
    {
<span class="nc" id="L162">        T retval = queue.take();</span>
<span class="nc" id="L163">        releaseWeight(retval);</span>
<span class="nc" id="L164">        return retval;</span>
    }

    public T poll(long timeout, TimeUnit unit) throws InterruptedException
    {
<span class="nc" id="L169">        throw new UnsupportedOperationException();</span>
    }

    public int remainingCapacity()
    {
<span class="nc" id="L174">        throw new UnsupportedOperationException(&quot;Seems like a bad idea&quot;);</span>
    }

    public boolean remove(Object o)
    {
<span class="nc" id="L179">        throw new UnsupportedOperationException();</span>
    }

    public boolean containsAll(Collection&lt;?&gt; c)
    {
<span class="nc" id="L184">        throw new UnsupportedOperationException(&quot;Seems like a bad idea&quot;);</span>
    }

    public boolean addAll(Collection&lt;? extends T&gt; c)
    {
<span class="nc" id="L189">        throw new UnsupportedOperationException();</span>
    }

    public boolean removeAll(Collection&lt;?&gt; c)
    {
<span class="nc" id="L194">        throw new UnsupportedOperationException(&quot;Seems like a bad idea&quot;);</span>
    }

    public boolean retainAll(Collection&lt;?&gt; c)
    {
<span class="nc" id="L199">        throw new UnsupportedOperationException(&quot;Seems like a bad idea&quot;);</span>
    }

    public void clear()
    {
<span class="nc" id="L204">        throw new UnsupportedOperationException();</span>
    }

    public int size()
    {
<span class="nc" id="L209">        throw new UnsupportedOperationException();</span>
    }

    public boolean isEmpty()
    {
<span class="nc" id="L214">        throw new UnsupportedOperationException();</span>
    }

    public boolean contains(Object o)
    {
<span class="nc" id="L219">        throw new UnsupportedOperationException(&quot;Seems like a bad idea&quot;);</span>
    }

    public Iterator&lt;T&gt; iterator()
    {
<span class="nc" id="L224">        throw new UnsupportedOperationException();</span>
    }

    public Object[] toArray()
    {
<span class="nc" id="L229">        throw new UnsupportedOperationException();</span>
    }

    public &lt;T1&gt; T1[] toArray(T1[] a)
    {
<span class="nc" id="L234">        throw new UnsupportedOperationException();</span>
    }

    public int drainTo(Collection&lt;? super T&gt; c)
    {
<span class="nc" id="L239">        throw new UnsupportedOperationException();</span>
    }

    public int drainTo(Collection&lt;? super T&gt; c, int maxElements)
    {
<span class="nc" id="L244">        int count = 0;</span>
        T o;
<span class="nc bnc" id="L246" title="All 4 branches missed.">        while(count &lt; maxElements &amp;&amp; (o = poll()) != null)</span>
        {
<span class="nc" id="L248">            c.add(o);</span>
<span class="nc" id="L249">            count++;</span>
        }
<span class="nc" id="L251">        return count;</span>
    }

    public interface Weigher&lt;T&gt;
    {
        int weigh(T weighable);
    }

    public interface Weighable
    {
        int weight();
    }

    public WeightedQueue(int maxWeight)
    {
<span class="nc" id="L266">        this(maxWeight, newBlockingQueue(), NATURAL_WEIGHER);</span>
<span class="nc" id="L267">    }</span>

    public WeightedQueue(int maxWeight, BlockingQueue&lt;T&gt; queue, Weigher&lt;T&gt; weigher)
<span class="nc" id="L270">    {</span>
<span class="nc" id="L271">        Preconditions.checkNotNull(queue);</span>
<span class="nc" id="L272">        Preconditions.checkNotNull(weigher);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        Preconditions.checkArgument(maxWeight &gt; 0);</span>
<span class="nc" id="L274">        this.maxWeight = maxWeight;</span>
<span class="nc" id="L275">        this.queue = queue;</span>
<span class="nc" id="L276">        this.weigher = weigher;</span>
<span class="nc" id="L277">        availableWeight = newSemaphore(maxWeight);</span>
<span class="nc" id="L278">    }</span>

    boolean acquireWeight(T weighable, long timeout, TimeUnit unit) throws InterruptedException
    {
<span class="nc" id="L282">        int weight = weigher.weigh(weighable);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (weight &lt; 1)</span>
        {
<span class="nc" id="L285">            throw new IllegalArgumentException(String.format(&quot;Weighable: \&quot;%s\&quot; had illegal weight %d&quot;, Objects.toString(weighable), weight));</span>
        }

        //Allow exactly one overweight element
<span class="nc" id="L289">        weight = Math.min(maxWeight, weight);</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (unit != null)</span>
        {
<span class="nc" id="L293">            return availableWeight.tryAcquire(weight, timeout, unit);</span>
        }
        else
        {
<span class="nc" id="L297">            availableWeight.acquire(weight);</span>
<span class="nc" id="L298">            return true;</span>
        }
    }

    boolean tryAcquireWeight(T weighable)
    {
<span class="nc" id="L304">        int weight = weigher.weigh(weighable);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (weight &lt; 1)</span>
        {
<span class="nc" id="L307">            throw new IllegalArgumentException(String.format(&quot;Weighable: \&quot;%s\&quot; had illegal weight %d&quot;, Objects.toString(weighable), weight));</span>
        }

        //Allow exactly one overweight element
<span class="nc" id="L311">        weight = Math.min(maxWeight, weight);</span>

<span class="nc" id="L313">        return availableWeight.tryAcquire(weight);</span>
    }

    void releaseWeight(T weighable)
    {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (weighable == null)</span>
        {
<span class="nc" id="L320">            return;</span>
        }

<span class="nc" id="L323">        int weight = weigher.weigh(weighable);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (weight &lt; 1)</span>
        {
<span class="nc" id="L326">            throw new IllegalArgumentException(String.format(&quot;Weighable: \&quot;%s\&quot; had illegal weight %d&quot;, Objects.toString(weighable), weight));</span>
        }

        //Allow exactly one overweight element
<span class="nc" id="L330">        weight = Math.min(maxWeight, weight);</span>

<span class="nc" id="L332">        availableWeight.release(weight);</span>
<span class="nc" id="L333">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>