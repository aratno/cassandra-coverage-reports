<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Duration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.cql3.functions.types</a> &gt; <span class="el_source">Duration.java</span></div><h1>Duration.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.cassandra.cql3.functions.types;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import com.google.common.base.Objects;

import static com.google.common.base.Preconditions.checkArgument;

/**
 * Represents a duration. A duration stores separately months, days, and seconds due to the fact
 * that the number of days in a month varies, and a day can have 23 or 25 hours if a daylight saving
 * is involved.
 */
public final class Duration
{

    private static final long NANOS_PER_MICRO = 1000L;
    private static final long NANOS_PER_MILLI = 1000 * NANOS_PER_MICRO;
    private static final long NANOS_PER_SECOND = 1000 * NANOS_PER_MILLI;
    private static final long NANOS_PER_MINUTE = 60 * NANOS_PER_SECOND;
    private static final long NANOS_PER_HOUR = 60 * NANOS_PER_MINUTE;
    private static final int DAYS_PER_WEEK = 7;
    private static final int MONTHS_PER_YEAR = 12;

    /**
     * The Regexp used to parse the duration provided as String.
     */
<span class="nc" id="L46">    private static final Pattern STANDARD_PATTERN =</span>
<span class="nc" id="L47">    Pattern.compile(</span>
    &quot;\\G(\\d+)(y|Y|mo|MO|mO|Mo|w|W|d|D|h|H|s|S|ms|MS|mS|Ms|us|US|uS|Us|µs|µS|ns|NS|nS|Ns|m|M)&quot;);

    /**
     * The Regexp used to parse the duration when provided in the ISO 8601 format with designators.
     */
<span class="nc" id="L53">    private static final Pattern ISO8601_PATTERN =</span>
<span class="nc" id="L54">    Pattern.compile(&quot;P((\\d+)Y)?((\\d+)M)?((\\d+)D)?(T((\\d+)H)?((\\d+)M)?((\\d+)S)?)?&quot;);</span>

    /**
     * The Regexp used to parse the duration when provided in the ISO 8601 format with designators.
     */
<span class="nc" id="L59">    private static final Pattern ISO8601_WEEK_PATTERN = Pattern.compile(&quot;P(\\d+)W&quot;);</span>

    /**
     * The Regexp used to parse the duration when provided in the ISO 8601 alternative format.
     */
<span class="nc" id="L64">    private static final Pattern ISO8601_ALTERNATIVE_PATTERN =</span>
<span class="nc" id="L65">    Pattern.compile(&quot;P(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})&quot;);</span>

    /**
     * The number of months.
     */
    private final int months;

    /**
     * The number of days.
     */
    private final int days;

    /**
     * The number of nanoseconds.
     */
    private final long nanoseconds;

    private Duration(int months, int days, long nanoseconds)
<span class="nc" id="L83">    {</span>
        // Makes sure that all the values are negative if one of them is
<span class="nc bnc" id="L85" title="All 12 branches missed.">        if ((months &lt; 0 || days &lt; 0 || nanoseconds &lt; 0)</span>
            &amp;&amp; ((months &gt; 0 || days &gt; 0 || nanoseconds &gt; 0)))
        {
<span class="nc" id="L88">            throw new IllegalArgumentException(</span>
<span class="nc" id="L89">            String.format(</span>
            &quot;All values must be either negative or positive, got %d months, %d days, %d nanoseconds&quot;,
<span class="nc" id="L91">            months, days, nanoseconds));</span>
        }
<span class="nc" id="L93">        this.months = months;</span>
<span class="nc" id="L94">        this.days = days;</span>
<span class="nc" id="L95">        this.nanoseconds = nanoseconds;</span>
<span class="nc" id="L96">    }</span>

    /**
     * Creates a duration with the given number of months, days and nanoseconds.
     *
     * &lt;p&gt;A duration can be negative. In this case, all the non zero values must be negative.
     *
     * @param months      the number of months
     * @param days        the number of days
     * @param nanoseconds the number of nanoseconds
     * @throws IllegalArgumentException if the values are not all negative or all positive
     */
    public static Duration newInstance(int months, int days, long nanoseconds)
    {
<span class="nc" id="L110">        return new Duration(months, days, nanoseconds);</span>
    }

    /**
     * Converts a &lt;code&gt;String&lt;/code&gt; into a duration.
     *
     * &lt;p&gt;The accepted formats are:
     *
     * &lt;ul&gt;
     * &lt;li&gt;multiple digits followed by a time unit like: 12h30m where the time unit can be:
     * &lt;ul&gt;
     * &lt;li&gt;{@code y}: years
     * &lt;li&gt;{@code m}: months
     * &lt;li&gt;{@code w}: weeks
     * &lt;li&gt;{@code d}: days
     * &lt;li&gt;{@code h}: hours
     * &lt;li&gt;{@code m}: minutes
     * &lt;li&gt;{@code s}: seconds
     * &lt;li&gt;{@code ms}: milliseconds
     * &lt;li&gt;{@code us} or {@code µs}: microseconds
     * &lt;li&gt;{@code ns}: nanoseconds
     * &lt;/ul&gt;
     * &lt;li&gt;ISO 8601 format: P[n]Y[n]M[n]DT[n]H[n]M[n]S or P[n]W
     * &lt;li&gt;ISO 8601 alternative format: P[YYYY]-[MM]-[DD]T[hh]:[mm]:[ss]
     * &lt;/ul&gt;
     *
     * @param input the &lt;code&gt;String&lt;/code&gt; to convert
     * @return a {@link Duration}
     */
    public static Duration from(String input)
    {
<span class="nc" id="L141">        boolean isNegative = input.startsWith(&quot;-&quot;);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        String source = isNegative ? input.substring(1) : input;</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (source.startsWith(&quot;P&quot;))</span>
        {
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (source.endsWith(&quot;W&quot;)) return parseIso8601WeekFormat(isNegative, source);</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (source.contains(&quot;-&quot;)) return parseIso8601AlternativeFormat(isNegative, source);</span>

<span class="nc" id="L150">            return parseIso8601Format(isNegative, source);</span>
        }
<span class="nc" id="L152">        return parseStandardFormat(isNegative, source);</span>
    }

    private static Duration parseIso8601Format(boolean isNegative, String source)
    {
<span class="nc" id="L157">        Matcher matcher = ISO8601_PATTERN.matcher(source);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!matcher.matches())</span>
<span class="nc" id="L159">            throw new IllegalArgumentException(</span>
<span class="nc" id="L160">            String.format(&quot;Unable to convert '%s' to a duration&quot;, source));</span>

<span class="nc" id="L162">        Builder builder = new Builder(isNegative);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (matcher.group(1) != null) builder.addYears(groupAsLong(matcher, 2));</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (matcher.group(3) != null) builder.addMonths(groupAsLong(matcher, 4));</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (matcher.group(5) != null) builder.addDays(groupAsLong(matcher, 6));</span>

        // Checks if the String contains time information
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (matcher.group(7) != null)</span>
        {
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (matcher.group(8) != null) builder.addHours(groupAsLong(matcher, 9));</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (matcher.group(10) != null) builder.addMinutes(groupAsLong(matcher, 11));</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (matcher.group(12) != null) builder.addSeconds(groupAsLong(matcher, 13));</span>
        }
<span class="nc" id="L178">        return builder.build();</span>
    }

    private static Duration parseIso8601AlternativeFormat(boolean isNegative, String source)
    {
<span class="nc" id="L183">        Matcher matcher = ISO8601_ALTERNATIVE_PATTERN.matcher(source);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!matcher.matches())</span>
<span class="nc" id="L185">            throw new IllegalArgumentException(</span>
<span class="nc" id="L186">            String.format(&quot;Unable to convert '%s' to a duration&quot;, source));</span>

<span class="nc" id="L188">        return new Builder(isNegative)</span>
<span class="nc" id="L189">               .addYears(groupAsLong(matcher, 1))</span>
<span class="nc" id="L190">               .addMonths(groupAsLong(matcher, 2))</span>
<span class="nc" id="L191">               .addDays(groupAsLong(matcher, 3))</span>
<span class="nc" id="L192">               .addHours(groupAsLong(matcher, 4))</span>
<span class="nc" id="L193">               .addMinutes(groupAsLong(matcher, 5))</span>
<span class="nc" id="L194">               .addSeconds(groupAsLong(matcher, 6))</span>
<span class="nc" id="L195">               .build();</span>
    }

    private static Duration parseIso8601WeekFormat(boolean isNegative, String source)
    {
<span class="nc" id="L200">        Matcher matcher = ISO8601_WEEK_PATTERN.matcher(source);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (!matcher.matches())</span>
<span class="nc" id="L202">            throw new IllegalArgumentException(</span>
<span class="nc" id="L203">            String.format(&quot;Unable to convert '%s' to a duration&quot;, source));</span>

<span class="nc" id="L205">        return new Builder(isNegative).addWeeks(groupAsLong(matcher, 1)).build();</span>
    }

    private static Duration parseStandardFormat(boolean isNegative, String source)
    {
<span class="nc" id="L210">        Matcher matcher = STANDARD_PATTERN.matcher(source);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (!matcher.find())</span>
<span class="nc" id="L212">            throw new IllegalArgumentException(</span>
<span class="nc" id="L213">            String.format(&quot;Unable to convert '%s' to a duration&quot;, source));</span>

<span class="nc" id="L215">        Builder builder = new Builder(isNegative);</span>
        boolean done;

        do
        {
<span class="nc" id="L220">            long number = groupAsLong(matcher, 1);</span>
<span class="nc" id="L221">            String symbol = matcher.group(2);</span>
<span class="nc" id="L222">            add(builder, number, symbol);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            done = matcher.end() == source.length();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        } while (matcher.find());</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (!done)</span>
<span class="nc" id="L227">            throw new IllegalArgumentException(</span>
<span class="nc" id="L228">            String.format(&quot;Unable to convert '%s' to a duration&quot;, source));</span>

<span class="nc" id="L230">        return builder.build();</span>
    }

    private static long groupAsLong(Matcher matcher, int group)
    {
<span class="nc" id="L235">        return Long.parseLong(matcher.group(group));</span>
    }

    private static Builder add(Builder builder, long number, String symbol)
    {
<span class="nc" id="L240">        String s = symbol.toLowerCase();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (s.equals(&quot;y&quot;))</span>
        {
<span class="nc" id="L243">            return builder.addYears(number);</span>
        }
<span class="nc bnc" id="L245" title="All 2 branches missed.">        else if (s.equals(&quot;mo&quot;))</span>
        {
<span class="nc" id="L247">            return builder.addMonths(number);</span>
        }
<span class="nc bnc" id="L249" title="All 2 branches missed.">        else if (s.equals(&quot;w&quot;))</span>
        {
<span class="nc" id="L251">            return builder.addWeeks(number);</span>
        }
<span class="nc bnc" id="L253" title="All 2 branches missed.">        else if (s.equals(&quot;d&quot;))</span>
        {
<span class="nc" id="L255">            return builder.addDays(number);</span>
        }
<span class="nc bnc" id="L257" title="All 2 branches missed.">        else if (s.equals(&quot;h&quot;))</span>
        {
<span class="nc" id="L259">            return builder.addHours(number);</span>
        }
<span class="nc bnc" id="L261" title="All 2 branches missed.">        else if (s.equals(&quot;m&quot;))</span>
        {
<span class="nc" id="L263">            return builder.addMinutes(number);</span>
        }
<span class="nc bnc" id="L265" title="All 2 branches missed.">        else if (s.equals(&quot;s&quot;))</span>
        {
<span class="nc" id="L267">            return builder.addSeconds(number);</span>
        }
<span class="nc bnc" id="L269" title="All 2 branches missed.">        else if (s.equals(&quot;ms&quot;))</span>
        {
<span class="nc" id="L271">            return builder.addMillis(number);</span>
        }
<span class="nc bnc" id="L273" title="All 4 branches missed.">        else if (s.equals(&quot;us&quot;) || s.equals(&quot;µs&quot;))</span>
        {
<span class="nc" id="L275">            return builder.addMicros(number);</span>
        }
<span class="nc bnc" id="L277" title="All 2 branches missed.">        else if (s.equals(&quot;ns&quot;))</span>
        {
<span class="nc" id="L279">            return builder.addNanos(number);</span>
        }
<span class="nc" id="L281">        throw new IllegalArgumentException(String.format(&quot;Unknown duration symbol '%s'&quot;, symbol));</span>
    }

    /**
     * Appends the result of the division to the specified builder if the dividend is not zero.
     *
     * @param builder  the builder to append to
     * @param dividend the dividend
     * @param divisor  the divisor
     * @param unit     the time unit to append after the result of the division
     * @return the remainder of the division
     */
    private static long append(StringBuilder builder, long dividend, long divisor, String unit)
    {
<span class="nc bnc" id="L295" title="All 4 branches missed.">        if (dividend == 0 || dividend &lt; divisor) return dividend;</span>

<span class="nc" id="L297">        builder.append(dividend / divisor).append(unit);</span>
<span class="nc" id="L298">        return dividend % divisor;</span>
    }

    /**
     * Returns the number of months in this duration.
     *
     * @return the number of months in this duration.
     */
    public int getMonths()
    {
<span class="nc" id="L308">        return months;</span>
    }

    /**
     * Returns the number of days in this duration.
     *
     * @return the number of days in this duration.
     */
    public int getDays()
    {
<span class="nc" id="L318">        return days;</span>
    }

    /**
     * Returns the number of nanoseconds in this duration.
     *
     * @return the number of months in this duration.
     */
    public long getNanoseconds()
    {
<span class="nc" id="L328">        return nanoseconds;</span>
    }

    @Override
    public int hashCode()
    {
<span class="nc" id="L334">        return Objects.hashCode(days, months, nanoseconds);</span>
    }

    @Override
    public boolean equals(Object obj)
    {
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (!(obj instanceof Duration)) return false;</span>

<span class="nc" id="L342">        Duration other = (Duration) obj;</span>
<span class="nc bnc" id="L343" title="All 6 branches missed.">        return days == other.days &amp;&amp; months == other.months &amp;&amp; nanoseconds == other.nanoseconds;</span>
    }

    @Override
    public String toString()
    {
<span class="nc" id="L349">        StringBuilder builder = new StringBuilder();</span>

<span class="nc bnc" id="L351" title="All 6 branches missed.">        if (months &lt; 0 || days &lt; 0 || nanoseconds &lt; 0) builder.append('-');</span>

<span class="nc" id="L353">        long remainder = append(builder, Math.abs(months), MONTHS_PER_YEAR, &quot;y&quot;);</span>
<span class="nc" id="L354">        append(builder, remainder, 1, &quot;mo&quot;);</span>

<span class="nc" id="L356">        append(builder, Math.abs(days), 1, &quot;d&quot;);</span>

<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (nanoseconds != 0)</span>
        {
<span class="nc" id="L360">            remainder = append(builder, Math.abs(nanoseconds), NANOS_PER_HOUR, &quot;h&quot;);</span>
<span class="nc" id="L361">            remainder = append(builder, remainder, NANOS_PER_MINUTE, &quot;m&quot;);</span>
<span class="nc" id="L362">            remainder = append(builder, remainder, NANOS_PER_SECOND, &quot;s&quot;);</span>
<span class="nc" id="L363">            remainder = append(builder, remainder, NANOS_PER_MILLI, &quot;ms&quot;);</span>
<span class="nc" id="L364">            remainder = append(builder, remainder, NANOS_PER_MICRO, &quot;us&quot;);</span>
<span class="nc" id="L365">            append(builder, remainder, 1, &quot;ns&quot;);</span>
        }
<span class="nc" id="L367">        return builder.toString();</span>
    }

    private static class Builder
    {
        /**
         * {@code true} if the duration is a negative one, {@code false} otherwise.
         */
        private final boolean isNegative;

        /**
         * The number of months.
         */
        private int months;

        /**
         * The number of days.
         */
        private int days;

        /**
         * The number of nanoseconds.
         */
        private long nanoseconds;

        /**
         * We need to make sure that the values for each units are provided in order.
         */
        private int currentUnitIndex;

        public Builder(boolean isNegative)
<span class="nc" id="L398">        {</span>
<span class="nc" id="L399">            this.isNegative = isNegative;</span>
<span class="nc" id="L400">        }</span>

        /**
         * Adds the specified amount of years.
         *
         * @param numberOfYears the number of years to add.
         * @return this {@code Builder}
         */
        public Builder addYears(long numberOfYears)
        {
<span class="nc" id="L410">            validateOrder(1);</span>
<span class="nc" id="L411">            validateMonths(numberOfYears, MONTHS_PER_YEAR);</span>
<span class="nc" id="L412">            months += numberOfYears * MONTHS_PER_YEAR;</span>
<span class="nc" id="L413">            return this;</span>
        }

        /**
         * Adds the specified amount of months.
         *
         * @param numberOfMonths the number of months to add.
         * @return this {@code Builder}
         */
        public Builder addMonths(long numberOfMonths)
        {
<span class="nc" id="L424">            validateOrder(2);</span>
<span class="nc" id="L425">            validateMonths(numberOfMonths, 1);</span>
<span class="nc" id="L426">            months += numberOfMonths;</span>
<span class="nc" id="L427">            return this;</span>
        }

        /**
         * Adds the specified amount of weeks.
         *
         * @param numberOfWeeks the number of weeks to add.
         * @return this {@code Builder}
         */
        public Builder addWeeks(long numberOfWeeks)
        {
<span class="nc" id="L438">            validateOrder(3);</span>
<span class="nc" id="L439">            validateDays(numberOfWeeks, DAYS_PER_WEEK);</span>
<span class="nc" id="L440">            days += numberOfWeeks * DAYS_PER_WEEK;</span>
<span class="nc" id="L441">            return this;</span>
        }

        /**
         * Adds the specified amount of days.
         *
         * @param numberOfDays the number of days to add.
         * @return this {@code Builder}
         */
        public Builder addDays(long numberOfDays)
        {
<span class="nc" id="L452">            validateOrder(4);</span>
<span class="nc" id="L453">            validateDays(numberOfDays, 1);</span>
<span class="nc" id="L454">            days += numberOfDays;</span>
<span class="nc" id="L455">            return this;</span>
        }

        /**
         * Adds the specified amount of hours.
         *
         * @param numberOfHours the number of hours to add.
         * @return this {@code Builder}
         */
        public Builder addHours(long numberOfHours)
        {
<span class="nc" id="L466">            validateOrder(5);</span>
<span class="nc" id="L467">            validateNanos(numberOfHours, NANOS_PER_HOUR);</span>
<span class="nc" id="L468">            nanoseconds += numberOfHours * NANOS_PER_HOUR;</span>
<span class="nc" id="L469">            return this;</span>
        }

        /**
         * Adds the specified amount of minutes.
         *
         * @param numberOfMinutes the number of minutes to add.
         * @return this {@code Builder}
         */
        public Builder addMinutes(long numberOfMinutes)
        {
<span class="nc" id="L480">            validateOrder(6);</span>
<span class="nc" id="L481">            validateNanos(numberOfMinutes, NANOS_PER_MINUTE);</span>
<span class="nc" id="L482">            nanoseconds += numberOfMinutes * NANOS_PER_MINUTE;</span>
<span class="nc" id="L483">            return this;</span>
        }

        /**
         * Adds the specified amount of seconds.
         *
         * @param numberOfSeconds the number of seconds to add.
         * @return this {@code Builder}
         */
        public Builder addSeconds(long numberOfSeconds)
        {
<span class="nc" id="L494">            validateOrder(7);</span>
<span class="nc" id="L495">            validateNanos(numberOfSeconds, NANOS_PER_SECOND);</span>
<span class="nc" id="L496">            nanoseconds += numberOfSeconds * NANOS_PER_SECOND;</span>
<span class="nc" id="L497">            return this;</span>
        }

        /**
         * Adds the specified amount of milliseconds.
         *
         * @param numberOfMillis the number of milliseconds to add.
         * @return this {@code Builder}
         */
        public Builder addMillis(long numberOfMillis)
        {
<span class="nc" id="L508">            validateOrder(8);</span>
<span class="nc" id="L509">            validateNanos(numberOfMillis, NANOS_PER_MILLI);</span>
<span class="nc" id="L510">            nanoseconds += numberOfMillis * NANOS_PER_MILLI;</span>
<span class="nc" id="L511">            return this;</span>
        }

        /**
         * Adds the specified amount of microseconds.
         *
         * @param numberOfMicros the number of microseconds to add.
         * @return this {@code Builder}
         */
        public Builder addMicros(long numberOfMicros)
        {
<span class="nc" id="L522">            validateOrder(9);</span>
<span class="nc" id="L523">            validateNanos(numberOfMicros, NANOS_PER_MICRO);</span>
<span class="nc" id="L524">            nanoseconds += numberOfMicros * NANOS_PER_MICRO;</span>
<span class="nc" id="L525">            return this;</span>
        }

        /**
         * Adds the specified amount of nanoseconds.
         *
         * @param numberOfNanos the number of nanoseconds to add.
         * @return this {@code Builder}
         */
        public Builder addNanos(long numberOfNanos)
        {
<span class="nc" id="L536">            validateOrder(10);</span>
<span class="nc" id="L537">            validateNanos(numberOfNanos, 1);</span>
<span class="nc" id="L538">            nanoseconds += numberOfNanos;</span>
<span class="nc" id="L539">            return this;</span>
        }

        /**
         * Validates that the total number of months can be stored.
         *
         * @param units         the number of units that need to be added
         * @param monthsPerUnit the number of days per unit
         */
        private void validateMonths(long units, int monthsPerUnit)
        {
<span class="nc" id="L550">            validate(units, (Integer.MAX_VALUE - months) / monthsPerUnit, &quot;months&quot;);</span>
<span class="nc" id="L551">        }</span>

        /**
         * Validates that the total number of days can be stored.
         *
         * @param units       the number of units that need to be added
         * @param daysPerUnit the number of days per unit
         */
        private void validateDays(long units, int daysPerUnit)
        {
<span class="nc" id="L561">            validate(units, (Integer.MAX_VALUE - days) / daysPerUnit, &quot;days&quot;);</span>
<span class="nc" id="L562">        }</span>

        /**
         * Validates that the total number of nanoseconds can be stored.
         *
         * @param units        the number of units that need to be added
         * @param nanosPerUnit the number of nanoseconds per unit
         */
        private void validateNanos(long units, long nanosPerUnit)
        {
<span class="nc" id="L572">            validate(units, (Long.MAX_VALUE - nanoseconds) / nanosPerUnit, &quot;nanoseconds&quot;);</span>
<span class="nc" id="L573">        }</span>

        /**
         * Validates that the specified amount is less than the limit.
         *
         * @param units    the number of units to check
         * @param limit    the limit on the number of units
         * @param unitName the unit name
         */
        private void validate(long units, long limit, String unitName)
        {
<span class="nc bnc" id="L584" title="All 2 branches missed.">            checkArgument(</span>
            units &lt;= limit,
            &quot;Invalid duration. The total number of %s must be less or equal to %s&quot;,
            unitName,
            Integer.MAX_VALUE);
<span class="nc" id="L589">        }</span>

        /**
         * Validates that the duration values are added in the proper order.
         *
         * @param unitIndex the unit index (e.g. years=1, months=2, ...)
         */
        private void validateOrder(int unitIndex)
        {
<span class="nc bnc" id="L598" title="All 2 branches missed.">            if (unitIndex == currentUnitIndex)</span>
<span class="nc" id="L599">                throw new IllegalArgumentException(</span>
<span class="nc" id="L600">                String.format(</span>
<span class="nc" id="L601">                &quot;Invalid duration. The %s are specified multiple times&quot;, getUnitName(unitIndex)));</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (unitIndex &lt;= currentUnitIndex)</span>
<span class="nc" id="L604">                throw new IllegalArgumentException(</span>
<span class="nc" id="L605">                String.format(</span>
                &quot;Invalid duration. The %s should be after %s&quot;,
<span class="nc" id="L607">                getUnitName(currentUnitIndex), getUnitName(unitIndex)));</span>

<span class="nc" id="L609">            currentUnitIndex = unitIndex;</span>
<span class="nc" id="L610">        }</span>

        /**
         * Returns the name of the unit corresponding to the specified index.
         *
         * @param unitIndex the unit index
         * @return the name of the unit corresponding to the specified index.
         */
        private String getUnitName(int unitIndex)
        {
<span class="nc bnc" id="L620" title="All 11 branches missed.">            switch (unitIndex)</span>
            {
                case 1:
<span class="nc" id="L623">                    return &quot;years&quot;;</span>
                case 2:
<span class="nc" id="L625">                    return &quot;months&quot;;</span>
                case 3:
<span class="nc" id="L627">                    return &quot;weeks&quot;;</span>
                case 4:
<span class="nc" id="L629">                    return &quot;days&quot;;</span>
                case 5:
<span class="nc" id="L631">                    return &quot;hours&quot;;</span>
                case 6:
<span class="nc" id="L633">                    return &quot;minutes&quot;;</span>
                case 7:
<span class="nc" id="L635">                    return &quot;seconds&quot;;</span>
                case 8:
<span class="nc" id="L637">                    return &quot;milliseconds&quot;;</span>
                case 9:
<span class="nc" id="L639">                    return &quot;microseconds&quot;;</span>
                case 10:
<span class="nc" id="L641">                    return &quot;nanoseconds&quot;;</span>
                default:
<span class="nc" id="L643">                    throw new AssertionError(&quot;unknown unit index: &quot; + unitIndex);</span>
            }
        }

        public Duration build()
        {
<span class="nc bnc" id="L649" title="All 2 branches missed.">            return isNegative</span>
<span class="nc" id="L650">                   ? new Duration(-months, -days, -nanoseconds)</span>
<span class="nc" id="L651">                   : new Duration(months, days, nanoseconds);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>