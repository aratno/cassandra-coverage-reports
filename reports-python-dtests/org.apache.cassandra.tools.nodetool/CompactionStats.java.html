<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompactionStats.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.tools.nodetool</a> &gt; <span class="el_source">CompactionStats.java</span></div><h1>CompactionStats.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.cassandra.tools.nodetool;

import java.io.PrintStream;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import io.airlift.airline.Command;
import io.airlift.airline.Option;

import org.apache.cassandra.db.compaction.CompactionInfo;
import org.apache.cassandra.db.compaction.CompactionInfo.Unit;
import org.apache.cassandra.io.util.FileUtils;
import org.apache.cassandra.metrics.CassandraMetricsRegistry;
import org.apache.cassandra.tools.NodeProbe;
import org.apache.cassandra.tools.NodeTool.NodeToolCmd;
import org.apache.cassandra.tools.nodetool.formatter.TableBuilder;

import static java.lang.String.format;

@Command(name = &quot;compactionstats&quot;, description = &quot;Print statistics on compactions&quot;)
<span class="fc" id="L41">public class CompactionStats extends NodeToolCmd</span>
{
<span class="fc" id="L43">    @Option(title = &quot;human_readable&quot;,</span>
            name = {&quot;-H&quot;, &quot;--human-readable&quot;},
            description = &quot;Display bytes in human readable form, i.e. KiB, MiB, GiB, TiB&quot;)
    private boolean humanReadable = false;

<span class="fc" id="L48">    @Option(title = &quot;vtable_output&quot;,</span>
            name = {&quot;-V&quot;, &quot;--vtable&quot;},
            description = &quot;Display fields matching vtable output&quot;)
    private boolean vtableOutput = false;

    @Override
    public void execute(NodeProbe probe)
    {
<span class="fc" id="L56">        PrintStream out = probe.output().out;</span>
<span class="fc" id="L57">        TableBuilder tableBuilder = new TableBuilder();</span>
<span class="fc" id="L58">        pendingTasksAndConcurrentCompactorsStats(probe, tableBuilder);</span>
<span class="fc" id="L59">        compactionsStats(probe, tableBuilder);</span>
<span class="fc" id="L60">        reportCompactionTable(probe.getCompactionManagerProxy().getCompactions(), probe.getCompactionThroughputBytes(), humanReadable, vtableOutput, out, tableBuilder);</span>
<span class="fc" id="L61">    }</span>

    private void pendingTasksAndConcurrentCompactorsStats(NodeProbe probe, TableBuilder tableBuilder)
    {
<span class="fc" id="L65">        Map&lt;String, Map&lt;String, Integer&gt;&gt; pendingTaskNumberByTable =</span>
<span class="fc" id="L66">        (Map&lt;String, Map&lt;String, Integer&gt;&gt;) probe.getCompactionMetric(&quot;PendingTasksByTableName&quot;);</span>

<span class="fc" id="L68">        tableBuilder.add(&quot;concurrent compactors&quot;, Integer.toString(probe.getConcurrentCompactors()));</span>
<span class="fc" id="L69">        tableBuilder.add(&quot;pending tasks&quot;, Integer.toString(numPendingTasks(pendingTaskNumberByTable)));</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">        for (Entry&lt;String, Map&lt;String, Integer&gt;&gt; ksEntry : pendingTaskNumberByTable.entrySet())</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">            for (Entry&lt;String, Integer&gt; tableEntry : ksEntry.getValue().entrySet())</span>
<span class="fc" id="L73">                tableBuilder.add(ksEntry.getKey(), tableEntry.getKey(), tableEntry.getValue().toString());</span>
<span class="fc" id="L74">    }</span>

    private int numPendingTasks(Map&lt;String, Map&lt;String, Integer&gt;&gt; pendingTaskNumberByTable)
    {
<span class="fc" id="L78">        int numTotalPendingTasks = 0;</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        for (Entry&lt;String, Map&lt;String, Integer&gt;&gt; ksEntry : pendingTaskNumberByTable.entrySet())</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            for (Entry&lt;String, Integer&gt; tableEntry : ksEntry.getValue().entrySet())</span>
<span class="fc" id="L81">                numTotalPendingTasks += tableEntry.getValue();</span>

<span class="fc" id="L83">        return numTotalPendingTasks;</span>
    }

    private void compactionsStats(NodeProbe probe, TableBuilder tableBuilder)
    {
<span class="fc" id="L88">        CassandraMetricsRegistry.JmxMeterMBean totalCompactionsCompletedMetrics =</span>
<span class="fc" id="L89">        (CassandraMetricsRegistry.JmxMeterMBean) probe.getCompactionMetric(&quot;TotalCompactionsCompleted&quot;);</span>
<span class="fc" id="L90">        tableBuilder.add(&quot;compactions completed&quot;, String.valueOf(totalCompactionsCompletedMetrics.getCount()));</span>

<span class="fc" id="L92">        CassandraMetricsRegistry.JmxCounterMBean bytesCompacted = (CassandraMetricsRegistry.JmxCounterMBean) probe.getCompactionMetric(&quot;BytesCompacted&quot;);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (humanReadable)</span>
<span class="nc" id="L94">            tableBuilder.add(&quot;data compacted&quot;, FileUtils.stringifyFileSize(Double.parseDouble(Long.toString(bytesCompacted.getCount()))));</span>
        else
<span class="fc" id="L96">            tableBuilder.add(&quot;data compacted&quot;, Long.toString(bytesCompacted.getCount()));</span>

<span class="fc" id="L98">        CassandraMetricsRegistry.JmxCounterMBean compactionsAborted = (CassandraMetricsRegistry.JmxCounterMBean) probe.getCompactionMetric(&quot;CompactionsAborted&quot;);</span>
<span class="fc" id="L99">        tableBuilder.add(&quot;compactions aborted&quot;, Long.toString(compactionsAborted.getCount()));</span>

<span class="fc" id="L101">        CassandraMetricsRegistry.JmxCounterMBean compactionsReduced = (CassandraMetricsRegistry.JmxCounterMBean) probe.getCompactionMetric(&quot;CompactionsReduced&quot;);</span>
<span class="fc" id="L102">        tableBuilder.add(&quot;compactions reduced&quot;, Long.toString(compactionsReduced.getCount()));</span>

<span class="fc" id="L104">        CassandraMetricsRegistry.JmxCounterMBean sstablesDroppedFromCompaction = (CassandraMetricsRegistry.JmxCounterMBean) probe.getCompactionMetric(&quot;SSTablesDroppedFromCompaction&quot;);</span>
<span class="fc" id="L105">        tableBuilder.add(&quot;sstables dropped from compaction&quot;, Long.toString(sstablesDroppedFromCompaction.getCount()));</span>

<span class="fc" id="L107">        NumberFormat formatter = new DecimalFormat(&quot;0.00&quot;);</span>

<span class="fc" id="L109">        tableBuilder.add(&quot;15 minute rate&quot;, String.format(&quot;%s/minute&quot;, formatter.format(totalCompactionsCompletedMetrics.getFifteenMinuteRate() * 60)));</span>
<span class="fc" id="L110">        tableBuilder.add(&quot;mean rate&quot;, String.format(&quot;%s/hour&quot;, formatter.format(totalCompactionsCompletedMetrics.getMeanRate() * 60 * 60)));</span>

<span class="fc" id="L112">        double configured = probe.getStorageService().getCompactionThroughtputMibPerSecAsDouble();</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        tableBuilder.add(&quot;compaction throughput (MiB/s)&quot;, configured == 0 ? &quot;throttling disabled (0)&quot; : Double.toString(configured));</span>
<span class="fc" id="L114">    }</span>

    public static void reportCompactionTable(List&lt;Map&lt;String,String&gt;&gt; compactions, long compactionThroughputInBytes, boolean humanReadable, PrintStream out, TableBuilder table)
    {
<span class="nc" id="L118">        reportCompactionTable(compactions, compactionThroughputInBytes, humanReadable, false, out, table);</span>
<span class="nc" id="L119">    }</span>

    public static void reportCompactionTable(List&lt;Map&lt;String,String&gt;&gt; compactions, long compactionThroughputInBytes, boolean humanReadable, boolean vtableOutput, PrintStream out, TableBuilder table)
    {
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (compactions.isEmpty())</span>
        {
<span class="fc" id="L125">            table.printTo(out);</span>
<span class="fc" id="L126">            return;</span>
        }

<span class="fc" id="L129">        long remainingBytes = 0;</span>

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (vtableOutput)</span>
<span class="nc" id="L132">            table.add(&quot;keyspace&quot;, &quot;table&quot;, &quot;task id&quot;, &quot;completion ratio&quot;, &quot;kind&quot;, &quot;progress&quot;, &quot;sstables&quot;, &quot;total&quot;, &quot;unit&quot;, &quot;target directory&quot;);</span>
        else
<span class="fc" id="L134">            table.add(&quot;id&quot;, &quot;compaction type&quot;, &quot;keyspace&quot;, &quot;table&quot;, &quot;completed&quot;, &quot;total&quot;, &quot;unit&quot;, &quot;progress&quot;);</span>

<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (Map&lt;String, String&gt; c : compactions)</span>
        {
<span class="fc" id="L138">            long total = Long.parseLong(c.get(CompactionInfo.TOTAL));</span>
<span class="fc" id="L139">            long completed = Long.parseLong(c.get(CompactionInfo.COMPLETED));</span>
<span class="fc" id="L140">            String taskType = c.get(CompactionInfo.TASK_TYPE);</span>
<span class="fc" id="L141">            String keyspace = c.get(CompactionInfo.KEYSPACE);</span>
<span class="fc" id="L142">            String columnFamily = c.get(CompactionInfo.COLUMNFAMILY);</span>
<span class="fc" id="L143">            String unit = c.get(CompactionInfo.UNIT);</span>
<span class="pc bpc" id="L144" title="3 of 4 branches missed.">            boolean toFileSize = humanReadable &amp;&amp; Unit.isFileSize(unit);</span>
<span class="fc" id="L145">            String[] tables = c.get(CompactionInfo.SSTABLES).split(&quot;,&quot;);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            String progressStr = toFileSize ? FileUtils.stringifyFileSize(completed) : Long.toString(completed);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            String totalStr = toFileSize ? FileUtils.stringifyFileSize(total) : Long.toString(total);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">            String percentComplete = total == 0 ? &quot;n/a&quot; : new DecimalFormat(&quot;0.00&quot;).format((double) completed / total * 100) + '%';</span>
<span class="fc" id="L149">            String id = c.get(CompactionInfo.COMPACTION_ID);</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if (vtableOutput)</span>
            {
<span class="nc" id="L152">                String targetDirectory = c.get(CompactionInfo.TARGET_DIRECTORY);</span>
<span class="nc" id="L153">                table.add(keyspace, columnFamily, id, percentComplete, taskType, progressStr, String.valueOf(tables.length), totalStr, unit, targetDirectory);</span>
<span class="nc" id="L154">            }</span>
            else
<span class="fc" id="L156">                table.add(id, taskType, keyspace, columnFamily, progressStr, totalStr, unit, percentComplete);</span>

<span class="fc" id="L158">            remainingBytes += total - completed;</span>
<span class="fc" id="L159">        }</span>

<span class="fc" id="L161">        String remainingTime = &quot;n/a&quot;;</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (compactionThroughputInBytes != 0)</span>
        {
<span class="fc" id="L164">            long remainingTimeInSecs = remainingBytes / compactionThroughputInBytes;</span>
<span class="fc" id="L165">            remainingTime = format(&quot;%dh%02dm%02ds&quot;, remainingTimeInSecs / 3600, (remainingTimeInSecs % 3600) / 60, (remainingTimeInSecs % 60));</span>
        }

<span class="fc" id="L168">        table.add(&quot;active compaction remaining time&quot;, remainingTime);</span>
<span class="fc" id="L169">        table.printTo(out);</span>
<span class="fc" id="L170">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>