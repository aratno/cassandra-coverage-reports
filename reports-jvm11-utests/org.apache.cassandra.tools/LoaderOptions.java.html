<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoaderOptions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.tools</a> &gt; <span class="el_source">LoaderOptions.java</span></div><h1>LoaderOptions.java</h1><pre class="source lang-java linenums">/*
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */
package org.apache.cassandra.tools;

import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.MalformedURLException;
import java.net.UnknownHostException;
import java.util.HashSet;
import java.util.Set;

import com.google.common.net.HostAndPort;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.GnuParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.datastax.driver.core.AuthProvider;
import com.datastax.driver.core.PlainTextAuthProvider;
import org.apache.cassandra.config.Config;
import org.apache.cassandra.config.DataRateSpec;
import org.apache.cassandra.config.EncryptionOptions;
import org.apache.cassandra.config.YamlConfigurationLoader;
import org.apache.cassandra.exceptions.ConfigurationException;
import org.apache.cassandra.io.util.File;
import org.apache.cassandra.locator.InetAddressAndPort;
import org.apache.cassandra.tools.BulkLoader.CmdLineOptions;

import static org.apache.cassandra.config.DataRateSpec.DataRateUnit.MEBIBYTES_PER_SECOND;

public class LoaderOptions
{
<span class="fc" id="L58">    private static final Logger logger = LoggerFactory.getLogger(LoaderOptions.class);</span>

    public static final String HELP_OPTION = &quot;help&quot;;
    public static final String VERBOSE_OPTION = &quot;verbose&quot;;
    public static final String NOPROGRESS_OPTION = &quot;no-progress&quot;;
    public static final String NATIVE_PORT_OPTION = &quot;port&quot;;
    public static final String STORAGE_PORT_OPTION = &quot;storage-port&quot;;
    @Deprecated
    public static final String SSL_STORAGE_PORT_OPTION = &quot;ssl-storage-port&quot;;
    public static final String USER_OPTION = &quot;username&quot;;
    public static final String PASSWD_OPTION = &quot;password&quot;;
    public static final String AUTH_PROVIDER_OPTION = &quot;auth-provider&quot;;
    public static final String INITIAL_HOST_ADDRESS_OPTION = &quot;nodes&quot;;
    public static final String IGNORE_NODES_OPTION = &quot;ignore&quot;;
    public static final String CONNECTIONS_PER_HOST = &quot;connections-per-host&quot;;
    public static final String CONFIG_PATH = &quot;conf-path&quot;;

    /**
     * Throttle defined in megabits per second. CASSANDRA-10637 introduced a builder and is the preferred way to
     * provide options instead of using these constant fields.
     * @deprecated Use {@code throttle-mib} instead
     */
    @Deprecated
    public static final String THROTTLE_MBITS = &quot;throttle&quot;;
    public static final String THROTTLE_MEBIBYTES = &quot;throttle-mib&quot;;
    /**
     * Inter-datacenter throttle defined in megabits per second. CASSANDRA-10637 introduced a builder and is the
     * preferred way to provide options instead of using these constant fields.
     * @deprecated Use {@code inter-dc-throttle-mib} instead
     */
    @Deprecated
    public static final String INTER_DC_THROTTLE_MBITS = &quot;inter-dc-throttle&quot;;
    public static final String INTER_DC_THROTTLE_MEBIBYTES = &quot;inter-dc-throttle-mib&quot;;
    public static final String ENTIRE_SSTABLE_THROTTLE_MEBIBYTES = &quot;entire-sstable-throttle-mib&quot;;
    public static final String ENTIRE_SSTABLE_INTER_DC_THROTTLE_MEBIBYTES = &quot;entire-sstable-inter-dc-throttle-mib&quot;;
    public static final String TOOL_NAME = &quot;sstableloader&quot;;
    public static final String TARGET_KEYSPACE = &quot;target-keyspace&quot;;
    public static final String TARGET_TABLE = &quot;target-table&quot;;

    /* client encryption options */
    public static final String SSL_TRUSTSTORE = &quot;truststore&quot;;
    public static final String SSL_TRUSTSTORE_PW = &quot;truststore-password&quot;;
    public static final String SSL_KEYSTORE = &quot;keystore&quot;;
    public static final String SSL_KEYSTORE_PW = &quot;keystore-password&quot;;
    public static final String SSL_PROTOCOL = &quot;ssl-protocol&quot;;
    public static final String SSL_ALGORITHM = &quot;ssl-alg&quot;;
    public static final String SSL_STORE_TYPE = &quot;store-type&quot;;
    public static final String SSL_CIPHER_SUITES = &quot;ssl-ciphers&quot;;

    public final File directory;
    public final boolean debug;
    public final boolean verbose;
    public final boolean noProgress;
    public final int nativePort;
    public final String user;
    public final String passwd;
    public final AuthProvider authProvider;
    public final long throttleBytes;
    public final long interDcThrottleBytes;
    public final int entireSSTableThrottleMebibytes;
    public final int entireSSTableInterDcThrottleMebibytes;
    public final int storagePort;
    public final int sslStoragePort;
    public final EncryptionOptions clientEncOptions;
    public final int connectionsPerHost;
    public final EncryptionOptions.ServerEncryptionOptions serverEncOptions;
    public final Set&lt;InetSocketAddress&gt; hosts;
    public final Set&lt;InetAddressAndPort&gt; ignores;
    public final String targetKeyspace;
    public final String targetTable;

    LoaderOptions(Builder builder)
<span class="fc" id="L130">    {</span>
<span class="fc" id="L131">        directory = builder.directory;</span>
<span class="fc" id="L132">        debug = builder.debug;</span>
<span class="fc" id="L133">        verbose = builder.verbose;</span>
<span class="fc" id="L134">        noProgress = builder.noProgress;</span>
<span class="fc" id="L135">        nativePort = builder.nativePort;</span>
<span class="fc" id="L136">        user = builder.user;</span>
<span class="fc" id="L137">        passwd = builder.passwd;</span>
<span class="fc" id="L138">        authProvider = builder.authProvider;</span>
<span class="fc" id="L139">        throttleBytes = builder.throttleBytes;</span>
<span class="fc" id="L140">        interDcThrottleBytes = builder.interDcThrottleBytes;</span>
<span class="fc" id="L141">        entireSSTableThrottleMebibytes = builder.entireSSTableThrottleMebibytes;</span>
<span class="fc" id="L142">        entireSSTableInterDcThrottleMebibytes = builder.entireSSTableInterDcThrottleMebibytes;</span>
<span class="fc" id="L143">        storagePort = builder.storagePort;</span>
<span class="fc" id="L144">        sslStoragePort = builder.sslStoragePort;</span>
<span class="fc" id="L145">        clientEncOptions = builder.clientEncOptions;</span>
<span class="fc" id="L146">        connectionsPerHost = builder.connectionsPerHost;</span>
<span class="fc" id="L147">        serverEncOptions = builder.serverEncOptions;</span>
<span class="fc" id="L148">        hosts = builder.hosts;</span>
<span class="fc" id="L149">        ignores = builder.ignores;</span>
<span class="fc" id="L150">        targetKeyspace = builder.targetKeyspace;</span>
<span class="fc" id="L151">        targetTable = builder.targetTable;</span>
<span class="fc" id="L152">    }</span>

    static class Builder
    {
        File directory;
        boolean debug;
        boolean verbose;
        boolean noProgress;
<span class="fc" id="L160">        int nativePort = 9042;</span>
        String user;
        String passwd;
        String authProviderName;
        AuthProvider authProvider;
<span class="fc" id="L165">        long throttleBytes = 0;</span>
<span class="fc" id="L166">        long interDcThrottleBytes = 0;</span>
<span class="fc" id="L167">        int entireSSTableThrottleMebibytes = 0;</span>
<span class="fc" id="L168">        int entireSSTableInterDcThrottleMebibytes = 0;</span>

        int storagePort;
        int sslStoragePort;
<span class="fc" id="L172">        EncryptionOptions clientEncOptions = new EncryptionOptions();</span>
<span class="fc" id="L173">        int connectionsPerHost = 1;</span>
<span class="fc" id="L174">        EncryptionOptions.ServerEncryptionOptions serverEncOptions = new EncryptionOptions.ServerEncryptionOptions();</span>
<span class="fc" id="L175">        Set&lt;InetAddress&gt; hostsArg = new HashSet&lt;&gt;();</span>
<span class="fc" id="L176">        Set&lt;InetAddress&gt; ignoresArg = new HashSet&lt;&gt;();</span>
<span class="fc" id="L177">        Set&lt;InetSocketAddress&gt; hosts = new HashSet&lt;&gt;();</span>
<span class="fc" id="L178">        Set&lt;InetAddressAndPort&gt; ignores = new HashSet&lt;&gt;();</span>
        String targetKeyspace;
        String targetTable;

        Builder()
<span class="fc" id="L183">        {</span>
            //
<span class="fc" id="L185">        }</span>

        public LoaderOptions build()
        {
<span class="fc" id="L189">            constructAuthProvider();</span>

            try
            {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                for (InetAddress host : hostsArg)</span>
                {
<span class="nc" id="L195">                    hosts.add(new InetSocketAddress(host, nativePort));</span>
<span class="nc" id="L196">                }</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                for (InetAddress host : ignoresArg)</span>
                {
<span class="nc" id="L199">                    ignores.add(InetAddressAndPort.getByNameOverrideDefaults(host.getHostAddress(), storagePort));</span>
<span class="nc" id="L200">                }</span>
            }
<span class="nc" id="L202">            catch (UnknownHostException e)</span>
            {
<span class="nc" id="L204">                throw new RuntimeException(e);</span>
<span class="fc" id="L205">            }</span>

<span class="fc" id="L207">            return new LoaderOptions(this);</span>
        }

        public Builder directory(File directory)
        {
<span class="nc" id="L212">            this.directory = directory;</span>
<span class="nc" id="L213">            return this;</span>
        }

        public Builder debug(boolean debug)
        {
<span class="nc" id="L218">            this.debug = debug;</span>
<span class="nc" id="L219">            return this;</span>
        }

        public Builder verbose(boolean verbose)
        {
<span class="nc" id="L224">            this.verbose = verbose;</span>
<span class="nc" id="L225">            return this;</span>
        }

        public Builder noProgress(boolean noProgress)
        {
<span class="nc" id="L230">            this.noProgress = noProgress;</span>
<span class="nc" id="L231">            return this;</span>
        }

        public Builder nativePort(int nativePort)
        {
<span class="nc" id="L236">            this.nativePort = nativePort;</span>
<span class="nc" id="L237">            return this;</span>
        }

        public Builder user(String user)
        {
<span class="nc" id="L242">            this.user = user;</span>
<span class="nc" id="L243">            return this;</span>
        }

        public Builder password(String passwd)
        {
<span class="nc" id="L248">            this.passwd = passwd;</span>
<span class="nc" id="L249">            return this;</span>
        }

        public Builder authProvider(AuthProvider authProvider)
        {
<span class="nc" id="L254">            this.authProvider = authProvider;</span>
<span class="nc" id="L255">            return this;</span>
        }

        public Builder throttleMebibytes(int throttleMebibytes)
        {
<span class="fc" id="L260">            this.throttleBytes = (long) MEBIBYTES_PER_SECOND.toBytesPerSecond(throttleMebibytes);</span>
<span class="fc" id="L261">            return this;</span>
        }

        @Deprecated
        public Builder throttle(int throttleMegabits)
        {
<span class="fc" id="L267">            this.throttleBytes = (long) DataRateSpec.LongBytesPerSecondBound.megabitsPerSecondInBytesPerSecond(throttleMegabits).toBytesPerSecond();</span>
<span class="fc" id="L268">            return this;</span>
        }

        public Builder interDcThrottleMebibytes(int interDcThrottleMebibytes)
        {
<span class="fc" id="L273">            this.interDcThrottleBytes = (long) MEBIBYTES_PER_SECOND.toBytesPerSecond(interDcThrottleMebibytes);</span>
<span class="fc" id="L274">            return this;</span>
        }

        public Builder interDcThrottleMegabits(int interDcThrottleMegabits)
        {
<span class="fc" id="L279">            this.interDcThrottleBytes = (long) DataRateSpec.LongBytesPerSecondBound.megabitsPerSecondInBytesPerSecond(interDcThrottleMegabits).toBytesPerSecond();</span>
<span class="fc" id="L280">            return this;</span>
        }

        @Deprecated
        public Builder interDcThrottle(int interDcThrottle)
        {
<span class="nc" id="L286">            return interDcThrottleMegabits(interDcThrottle);</span>
        }

        public Builder entireSSTableThrottleMebibytes(int entireSSTableThrottleMebibytes)
        {
<span class="fc" id="L291">            this.entireSSTableThrottleMebibytes = entireSSTableThrottleMebibytes;</span>
<span class="fc" id="L292">            return this;</span>
        }

        @Deprecated
        public Builder entireSSTableThrottle(int entireSSTableThrottle)
        {
<span class="nc" id="L298">            this.entireSSTableThrottleMebibytes = entireSSTableThrottle;</span>
<span class="nc" id="L299">            return this;</span>
        }

        public Builder entireSSTableInterDcThrottleMebibytes(int entireSSTableInterDcThrottleMebibytes)
        {
<span class="fc" id="L304">            this.entireSSTableInterDcThrottleMebibytes = entireSSTableInterDcThrottleMebibytes;</span>
<span class="fc" id="L305">            return this;</span>
        }

        @Deprecated
        public Builder entireSSTableInterDcThrottle(int entireSSTableInterDcThrottle)
        {
<span class="nc" id="L311">            this.entireSSTableInterDcThrottleMebibytes = entireSSTableInterDcThrottle;</span>
<span class="nc" id="L312">            return this;</span>
        }

        public Builder storagePort(int storagePort)
        {
<span class="nc" id="L317">            this.storagePort = storagePort;</span>
<span class="nc" id="L318">            return this;</span>
        }

        @Deprecated
        public Builder sslStoragePort(int sslStoragePort)
        {
<span class="nc" id="L324">            this.sslStoragePort = storagePort;</span>
<span class="nc" id="L325">            return this;</span>
        }

        public Builder encOptions(EncryptionOptions encOptions)
        {
<span class="nc" id="L330">            this.clientEncOptions = encOptions;</span>
<span class="nc" id="L331">            return this;</span>
        }

        public Builder connectionsPerHost(int connectionsPerHost)
        {
<span class="nc" id="L336">            this.connectionsPerHost = connectionsPerHost;</span>
<span class="nc" id="L337">            return this;</span>
        }

        public Builder serverEncOptions(EncryptionOptions.ServerEncryptionOptions serverEncOptions)
        {
<span class="nc" id="L342">            this.serverEncOptions = serverEncOptions;</span>
<span class="nc" id="L343">            return this;</span>
        }

        @Deprecated
        public Builder hosts(Set&lt;InetAddress&gt; hosts)
        {
<span class="nc" id="L349">            this.hostsArg.addAll(hosts);</span>
<span class="nc" id="L350">            return this;</span>
        }

        public Builder hostsAndNativePort(Set&lt;InetSocketAddress&gt; hosts)
        {
<span class="nc" id="L355">            this.hosts.addAll(hosts);</span>
<span class="nc" id="L356">            return this;</span>
        }

        public Builder host(InetAddress host)
        {
<span class="nc" id="L361">            hostsArg.add(host);</span>
<span class="nc" id="L362">            return this;</span>
        }

        public Builder hostAndNativePort(InetSocketAddress host)
        {
<span class="nc" id="L367">            hosts.add(host);</span>
<span class="nc" id="L368">            return this;</span>
        }

        public Builder ignore(Set&lt;InetAddress&gt; ignores)
        {
<span class="nc" id="L373">            this.ignoresArg.addAll(ignores);</span>
<span class="nc" id="L374">            return this;</span>
        }

        public Builder ignoresAndInternalPorts(Set&lt;InetAddressAndPort&gt; ignores)
        {
<span class="nc" id="L379">            this.ignores.addAll(ignores);</span>
<span class="nc" id="L380">            return this;</span>
        }

        public Builder ignore(InetAddress ignore)
        {
<span class="nc" id="L385">            ignoresArg.add(ignore);</span>
<span class="nc" id="L386">            return this;</span>
        }

        public Builder ignoreAndInternalPorts(InetAddressAndPort ignore)
        {
<span class="nc" id="L391">            ignores.add(ignore);</span>
<span class="nc" id="L392">            return this;</span>
        }

        public Builder targetKeyspace(String keyspace)
        {
<span class="nc" id="L397">            this.targetKeyspace = keyspace;</span>
<span class="nc" id="L398">            return this;</span>
        }

        public Builder targetTable(String table)
        {
<span class="nc" id="L403">            this.targetKeyspace = table;</span>
<span class="nc" id="L404">            return this;</span>
        }

        public Builder parseArgs(String cmdArgs[])
        {
<span class="fc" id="L409">            CommandLineParser parser = new GnuParser();</span>
<span class="fc" id="L410">            CmdLineOptions options = getCmdLineOptions();</span>
            try
            {
<span class="fc" id="L413">                CommandLine cmd = parser.parse(options, cmdArgs, false);</span>

<span class="pc bpc" id="L415" title="1 of 2 branches missed.">                if (cmd.hasOption(HELP_OPTION))</span>
                {
<span class="nc" id="L417">                    printUsage(options);</span>
<span class="nc" id="L418">                    System.exit(0);</span>
                }

<span class="fc" id="L421">                String[] args = cmd.getArgs();</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">                if (args.length == 0)</span>
                {
<span class="fc" id="L424">                    System.err.println(&quot;Missing sstable directory argument&quot;);</span>
<span class="fc" id="L425">                    printUsage(options);</span>
<span class="nc" id="L426">                    System.exit(1);</span>
                }

<span class="fc bfc" id="L429" title="All 2 branches covered.">                if (args.length &gt; 1)</span>
                {
<span class="fc" id="L431">                    System.err.println(&quot;Too many arguments&quot;);</span>
<span class="fc" id="L432">                    printUsage(options);</span>
<span class="nc" id="L433">                    System.exit(1);</span>
                }

<span class="fc" id="L436">                String dirname = args[0];</span>
<span class="fc" id="L437">                File dir = new File(dirname);</span>

<span class="pc bpc" id="L439" title="1 of 2 branches missed.">                if (!dir.exists())</span>
                {
<span class="nc" id="L441">                    errorMsg(&quot;Unknown directory: &quot; + dirname, options);</span>
                }

<span class="pc bpc" id="L444" title="1 of 2 branches missed.">                if (!dir.isDirectory())</span>
                {
<span class="nc" id="L446">                    errorMsg(dirname + &quot; is not a directory&quot;, options);</span>
                }

<span class="fc" id="L449">                directory = dir;</span>

<span class="fc" id="L451">                verbose = cmd.hasOption(VERBOSE_OPTION);</span>
<span class="fc" id="L452">                noProgress = cmd.hasOption(NOPROGRESS_OPTION);</span>

<span class="pc bpc" id="L454" title="1 of 2 branches missed.">                if (cmd.hasOption(USER_OPTION))</span>
                {
<span class="nc" id="L456">                    user = cmd.getOptionValue(USER_OPTION);</span>
                }

<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                if (cmd.hasOption(PASSWD_OPTION))</span>
                {
<span class="nc" id="L461">                    passwd = cmd.getOptionValue(PASSWD_OPTION);</span>
                }

<span class="pc bpc" id="L464" title="1 of 2 branches missed.">                if (cmd.hasOption(AUTH_PROVIDER_OPTION))</span>
                {
<span class="nc" id="L466">                    authProviderName = cmd.getOptionValue(AUTH_PROVIDER_OPTION);</span>
                }

                // try to load config file first, so that values can be
                // rewritten with other option values.
                // otherwise use default config.
                Config config;
<span class="fc bfc" id="L473" title="All 2 branches covered.">                if (cmd.hasOption(CONFIG_PATH))</span>
                {
<span class="fc" id="L475">                    File configFile = new File(cmd.getOptionValue(CONFIG_PATH));</span>
<span class="pc bpc" id="L476" title="1 of 2 branches missed.">                    if (!configFile.exists())</span>
                    {
<span class="nc" id="L478">                        errorMsg(&quot;Config file not found&quot;, options);</span>
                    }
<span class="fc" id="L480">                    config = new YamlConfigurationLoader().loadConfig(configFile.toPath().toUri().toURL());</span>

                    // below 2 checks are needed in order to match the pre-CASSANDRA-15234 upper bound for those parameters which were still in megabits per second
<span class="pc bpc" id="L483" title="1 of 2 branches missed.">                    if (config.stream_throughput_outbound.toMegabitsPerSecond() &gt;= Integer.MAX_VALUE)</span>
                    {
<span class="nc" id="L485">                        throw new ConfigurationException(&quot;stream_throughput_outbound: &quot; + config.stream_throughput_outbound.toString() + &quot; is too large&quot;, false);</span>
                    }

<span class="pc bpc" id="L488" title="1 of 2 branches missed.">                    if (config.inter_dc_stream_throughput_outbound.toMegabitsPerSecond() &gt;= Integer.MAX_VALUE)</span>
                    {
<span class="nc" id="L490">                        throw new ConfigurationException(&quot;inter_dc_stream_throughput_outbound: &quot; + config.inter_dc_stream_throughput_outbound.toString() + &quot; is too large&quot;, false);</span>
                    }

<span class="pc bpc" id="L493" title="1 of 2 branches missed.">                    if (config.entire_sstable_stream_throughput_outbound.toMebibytesPerSecond() &gt;= Integer.MAX_VALUE)</span>
                    {
<span class="nc" id="L495">                        throw new ConfigurationException(&quot;entire_sstable_stream_throughput_outbound: &quot; + config.entire_sstable_stream_throughput_outbound.toString() + &quot; is too large&quot;, false);</span>
                    }

<span class="pc bpc" id="L498" title="1 of 2 branches missed.">                    if (config.entire_sstable_inter_dc_stream_throughput_outbound.toMebibytesPerSecond() &gt;= Integer.MAX_VALUE)</span>
                    {
<span class="nc" id="L500">                        throw new ConfigurationException(&quot;entire_sstable_inter_dc_stream_throughput_outbound: &quot; + config.entire_sstable_inter_dc_stream_throughput_outbound.toString() + &quot; is too large&quot;, false);</span>
                    }
<span class="fc" id="L502">                }</span>
                else
                {
<span class="fc" id="L505">                    config = new Config();</span>
                    // unthrottle stream by default
<span class="fc" id="L507">                    config.stream_throughput_outbound = new DataRateSpec.LongBytesPerSecondBound(0);</span>
<span class="fc" id="L508">                    config.inter_dc_stream_throughput_outbound = new DataRateSpec.LongBytesPerSecondBound(0);</span>
<span class="fc" id="L509">                    config.entire_sstable_stream_throughput_outbound = new DataRateSpec.LongBytesPerSecondBound(0);</span>
<span class="fc" id="L510">                    config.entire_sstable_inter_dc_stream_throughput_outbound = new DataRateSpec.LongBytesPerSecondBound(0);</span>
                }

<span class="pc bpc" id="L513" title="1 of 2 branches missed.">                if (cmd.hasOption(STORAGE_PORT_OPTION))</span>
<span class="nc" id="L514">                    storagePort = Integer.parseInt(cmd.getOptionValue(STORAGE_PORT_OPTION));</span>
                else
<span class="fc" id="L516">                    storagePort = config.storage_port;</span>

<span class="pc bpc" id="L518" title="1 of 2 branches missed.">                if (cmd.hasOption(IGNORE_NODES_OPTION))</span>
                {
<span class="nc" id="L520">                    String[] nodes = cmd.getOptionValue(IGNORE_NODES_OPTION).split(&quot;,&quot;);</span>
                    try
                    {
<span class="nc bnc" id="L523" title="All 2 branches missed.">                        for (String node : nodes)</span>
                        {
<span class="nc" id="L525">                            ignores.add(InetAddressAndPort.getByNameOverrideDefaults(node.trim(), storagePort));</span>
                        }
<span class="nc" id="L527">                    } catch (UnknownHostException e)</span>
                    {
<span class="nc" id="L529">                        errorMsg(&quot;Unknown host: &quot; + e.getMessage(), options);</span>
<span class="nc" id="L530">                    }</span>
                }

<span class="pc bpc" id="L533" title="1 of 2 branches missed.">                if (cmd.hasOption(CONNECTIONS_PER_HOST))</span>
                {
<span class="nc" id="L535">                    connectionsPerHost = Integer.parseInt(cmd.getOptionValue(CONNECTIONS_PER_HOST));</span>
                }

<span class="fc" id="L538">                throttleBytes = config.stream_throughput_outbound.toBytesPerSecondAsInt();</span>

<span class="pc bpc" id="L540" title="1 of 2 branches missed.">                if (cmd.hasOption(SSL_STORAGE_PORT_OPTION))</span>
<span class="nc" id="L541">                    logger.info(&quot;ssl storage port is deprecated and not used, all communication goes though storage port &quot; +</span>
                                &quot;which is able to handle encrypted communication too.&quot;);

                // Copy the encryption options and apply the config so that argument parsing can accesss isEnabled.
<span class="fc" id="L545">                clientEncOptions = config.client_encryption_options.applyConfig();</span>
<span class="fc" id="L546">                serverEncOptions = config.server_encryption_options;</span>
<span class="fc" id="L547">                serverEncOptions.applyConfig();</span>

<span class="fc bfc" id="L549" title="All 2 branches covered.">                if (cmd.hasOption(NATIVE_PORT_OPTION))</span>
                {
<span class="fc" id="L551">                    nativePort = Integer.parseInt(cmd.getOptionValue(NATIVE_PORT_OPTION));</span>
                }
                else
                {
<span class="pc bpc" id="L555" title="3 of 6 branches missed.">                    if (config.native_transport_port_ssl != null &amp;&amp; (config.client_encryption_options.getEnabled() || clientEncOptions.getEnabled()))</span>
<span class="fc" id="L556">                        nativePort = config.native_transport_port_ssl;</span>
                    else
<span class="fc" id="L558">                        nativePort = config.native_transport_port;</span>
                }

<span class="pc bpc" id="L561" title="1 of 2 branches missed.">                if (cmd.hasOption(INITIAL_HOST_ADDRESS_OPTION))</span>
                {
<span class="fc" id="L563">                    String[] nodes = cmd.getOptionValue(INITIAL_HOST_ADDRESS_OPTION).split(&quot;,&quot;);</span>
                    try
                    {
<span class="fc bfc" id="L566" title="All 2 branches covered.">                        for (String node : nodes)</span>
                        {
<span class="fc" id="L568">                            HostAndPort hap = HostAndPort.fromString(node);</span>
<span class="fc" id="L569">                            hosts.add(new InetSocketAddress(InetAddress.getByName(hap.getHost()), hap.getPortOrDefault(nativePort)));</span>
                        }
<span class="nc" id="L571">                    } catch (UnknownHostException e)</span>
                    {
<span class="nc" id="L573">                        errorMsg(&quot;Unknown host: &quot; + e.getMessage(), options);</span>
<span class="fc" id="L574">                    }</span>

<span class="fc" id="L576">                } else</span>
                {
<span class="nc" id="L578">                    System.err.println(&quot;Initial hosts must be specified (-d)&quot;);</span>
<span class="nc" id="L579">                    printUsage(options);</span>
<span class="nc" id="L580">                    System.exit(1);</span>
                }

<span class="fc bfc" id="L583" title="All 4 branches covered.">                if (cmd.hasOption(THROTTLE_MBITS) &amp;&amp; cmd.hasOption(THROTTLE_MEBIBYTES))</span>
                {
<span class="nc" id="L585">                    errorMsg(String.format(&quot;Both '%s' and '%s' were provided. Please only provide one of the two options&quot;, THROTTLE_MBITS, THROTTLE_MEBIBYTES), options);</span>
                }

<span class="fc bfc" id="L588" title="All 4 branches covered.">                if (cmd.hasOption(INTER_DC_THROTTLE_MBITS) &amp;&amp; cmd.hasOption(INTER_DC_THROTTLE_MEBIBYTES))</span>
                {
<span class="nc" id="L590">                    errorMsg(String.format(&quot;Both '%s' and '%s' were provided. Please only provide one of the two options&quot;, INTER_DC_THROTTLE_MBITS, INTER_DC_THROTTLE_MEBIBYTES), options);</span>
                }

<span class="fc bfc" id="L593" title="All 2 branches covered.">                if (cmd.hasOption(THROTTLE_MBITS))</span>
                {
<span class="fc" id="L595">                    throttle(Integer.parseInt(cmd.getOptionValue(THROTTLE_MBITS)));</span>
                }

<span class="fc bfc" id="L598" title="All 2 branches covered.">                if (cmd.hasOption(THROTTLE_MEBIBYTES))</span>
                {
<span class="fc" id="L600">                    throttleMebibytes(Integer.parseInt(cmd.getOptionValue(THROTTLE_MEBIBYTES)));</span>
                }

<span class="fc bfc" id="L603" title="All 2 branches covered.">                if (cmd.hasOption(INTER_DC_THROTTLE_MBITS))</span>
                {
<span class="fc" id="L605">                    interDcThrottleMegabits(Integer.parseInt(cmd.getOptionValue(INTER_DC_THROTTLE_MBITS)));</span>
                }

<span class="fc bfc" id="L608" title="All 2 branches covered.">                if (cmd.hasOption(INTER_DC_THROTTLE_MEBIBYTES))</span>
                {
<span class="fc" id="L610">                    interDcThrottleMebibytes(Integer.parseInt(cmd.getOptionValue(INTER_DC_THROTTLE_MEBIBYTES)));</span>
                }

<span class="fc bfc" id="L613" title="All 2 branches covered.">                if (cmd.hasOption(ENTIRE_SSTABLE_THROTTLE_MEBIBYTES))</span>
                {
<span class="fc" id="L615">                    entireSSTableThrottleMebibytes(Integer.parseInt(cmd.getOptionValue(ENTIRE_SSTABLE_THROTTLE_MEBIBYTES)));</span>
                }

<span class="fc bfc" id="L618" title="All 2 branches covered.">                if (cmd.hasOption(ENTIRE_SSTABLE_INTER_DC_THROTTLE_MEBIBYTES))</span>
                {
<span class="fc" id="L620">                    entireSSTableInterDcThrottleMebibytes(Integer.parseInt(cmd.getOptionValue(ENTIRE_SSTABLE_INTER_DC_THROTTLE_MEBIBYTES)));</span>
                }

<span class="pc bpc" id="L623" title="1 of 4 branches missed.">                if (cmd.hasOption(SSL_TRUSTSTORE) || cmd.hasOption(SSL_TRUSTSTORE_PW) ||</span>
<span class="pc bpc" id="L624" title="2 of 4 branches missed.">                    cmd.hasOption(SSL_KEYSTORE) || cmd.hasOption(SSL_KEYSTORE_PW))</span>
                {
<span class="fc" id="L626">                    clientEncOptions = clientEncOptions.withEnabled(true);</span>
                }

<span class="fc bfc" id="L629" title="All 2 branches covered.">                if (cmd.hasOption(SSL_TRUSTSTORE))</span>
                {
<span class="fc" id="L631">                    clientEncOptions = clientEncOptions.withTrustStore(cmd.getOptionValue(SSL_TRUSTSTORE));</span>
                }

<span class="fc bfc" id="L634" title="All 2 branches covered.">                if (cmd.hasOption(SSL_TRUSTSTORE_PW))</span>
                {
<span class="fc" id="L636">                    clientEncOptions = clientEncOptions.withTrustStorePassword(cmd.getOptionValue(SSL_TRUSTSTORE_PW));</span>
                }

<span class="fc bfc" id="L639" title="All 2 branches covered.">                if (cmd.hasOption(SSL_KEYSTORE))</span>
                {
                    // if a keystore was provided, lets assume we'll need to use
<span class="fc" id="L642">                    clientEncOptions = clientEncOptions.withKeyStore(cmd.getOptionValue(SSL_KEYSTORE))</span>
<span class="fc" id="L643">                                                       .withRequireClientAuth(true);</span>
                }

<span class="fc bfc" id="L646" title="All 2 branches covered.">                if (cmd.hasOption(SSL_KEYSTORE_PW))</span>
                {
<span class="fc" id="L648">                    clientEncOptions = clientEncOptions.withKeyStorePassword(cmd.getOptionValue(SSL_KEYSTORE_PW));</span>
                }

<span class="fc bfc" id="L651" title="All 2 branches covered.">                if (cmd.hasOption(SSL_PROTOCOL))</span>
                {
<span class="fc" id="L653">                    clientEncOptions = clientEncOptions.withProtocol(cmd.getOptionValue(SSL_PROTOCOL));</span>
                }

<span class="fc bfc" id="L656" title="All 2 branches covered.">                if (cmd.hasOption(SSL_ALGORITHM))</span>
                {
<span class="fc" id="L658">                    clientEncOptions = clientEncOptions.withAlgorithm(cmd.getOptionValue(SSL_ALGORITHM));</span>
                }

<span class="fc bfc" id="L661" title="All 2 branches covered.">                if (cmd.hasOption(SSL_STORE_TYPE))</span>
                {
<span class="fc" id="L663">                    clientEncOptions = clientEncOptions.withStoreType(cmd.getOptionValue(SSL_STORE_TYPE));</span>
                }

<span class="fc bfc" id="L666" title="All 2 branches covered.">                if (cmd.hasOption(SSL_CIPHER_SUITES))</span>
                {
<span class="fc" id="L668">                    clientEncOptions = clientEncOptions.withCipherSuites(cmd.getOptionValue(SSL_CIPHER_SUITES).split(&quot;,&quot;));</span>
                }

<span class="pc bpc" id="L671" title="1 of 2 branches missed.">                if (cmd.hasOption(TARGET_KEYSPACE))</span>
                {
<span class="nc" id="L673">                    targetKeyspace = cmd.getOptionValue(TARGET_KEYSPACE);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                    if (StringUtils.isBlank(targetKeyspace))</span>
<span class="nc" id="L675">                        errorMsg(&quot;Empty keyspace is not supported.&quot;, options);</span>
                }

<span class="pc bpc" id="L678" title="1 of 2 branches missed.">                if (cmd.hasOption(TARGET_TABLE))</span>
                {
<span class="nc" id="L680">                    targetTable = cmd.getOptionValue(TARGET_TABLE);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                    if (StringUtils.isBlank(targetTable))</span>
<span class="nc" id="L682">                        errorMsg(&quot;Empty table is not supported.&quot;, options);</span>
                }

<span class="fc" id="L685">                return this;</span>
            }
<span class="nc" id="L687">            catch (ParseException | ConfigurationException | MalformedURLException e)</span>
            {
<span class="nc" id="L689">                errorMsg(e.getMessage(), options);</span>
<span class="nc" id="L690">                return null;</span>
            }
        }

        private void constructAuthProvider()
        {
            // Both username and password need to be provided
<span class="pc bpc" id="L697" title="3 of 6 branches missed.">            if ((user != null) != (passwd != null))</span>
<span class="nc" id="L698">                errorMsg(&quot;Username and password must both be provided&quot;, getCmdLineOptions());</span>

<span class="pc bpc" id="L700" title="1 of 2 branches missed.">            if (user != null)</span>
            {
                // Support for 3rd party auth providers that support plain text credentials.
                // In this case the auth provider must provide a constructor of the form:
                //
                // public MyAuthProvider(String username, String password)
<span class="nc bnc" id="L706" title="All 2 branches missed.">                if (authProviderName != null)</span>
                {
                    try
                    {
<span class="nc" id="L710">                        Class authProviderClass = Class.forName(authProviderName);</span>
<span class="nc" id="L711">                        Constructor constructor = authProviderClass.getConstructor(String.class, String.class);</span>
<span class="nc" id="L712">                        authProvider = (AuthProvider)constructor.newInstance(user, passwd);</span>
                    }
<span class="nc" id="L714">                    catch (ClassNotFoundException e)</span>
                    {
<span class="nc" id="L716">                        errorMsg(&quot;Unknown auth provider: &quot; + e.getMessage(), getCmdLineOptions());</span>
                    }
<span class="nc" id="L718">                    catch (NoSuchMethodException e)</span>
                    {
<span class="nc" id="L720">                        errorMsg(&quot;Auth provider does not support plain text credentials: &quot; + e.getMessage(), getCmdLineOptions());</span>
                    }
<span class="nc" id="L722">                    catch (InstantiationException | IllegalAccessException | IllegalArgumentException | InvocationTargetException e)</span>
                    {
<span class="nc" id="L724">                        errorMsg(&quot;Could not create auth provider with plain text credentials: &quot; + e.getMessage(), getCmdLineOptions());</span>
<span class="nc" id="L725">                    }</span>
                }
                else
                {
                    // If a 3rd party auth provider wasn't provided use the driver plain text provider
<span class="nc" id="L730">                    this.authProvider = new PlainTextAuthProvider(user, passwd);</span>
                }
            }
            // Alternate support for 3rd party auth providers that don't use plain text credentials.
            // In this case the auth provider must provide a nullary constructor of the form:
            //
            // public MyAuthProvider()
<span class="pc bpc" id="L737" title="1 of 2 branches missed.">            else if (authProviderName != null)</span>
            {
                try
                {
<span class="nc" id="L741">                    authProvider = (AuthProvider)Class.forName(authProviderName).newInstance();</span>
                }
<span class="nc" id="L743">                catch (ClassNotFoundException | InstantiationException | IllegalAccessException e)</span>
                {
<span class="nc" id="L745">                    errorMsg(&quot;Unknown auth provider: &quot; + e.getMessage(), getCmdLineOptions());</span>
<span class="nc" id="L746">                }</span>
            }
<span class="fc" id="L748">        }</span>
    }

    public static Builder builder()
    {
<span class="fc" id="L753">        return new Builder();</span>
    }

    private static void errorMsg(String msg, CmdLineOptions options)
    {
<span class="fc" id="L758">        System.err.println(msg);</span>
<span class="fc" id="L759">        printUsage(options);</span>
<span class="nc" id="L760">        System.exit(1);</span>
<span class="nc" id="L761">    }</span>

    private static CmdLineOptions getCmdLineOptions()
    {
<span class="fc" id="L765">        CmdLineOptions options = new CmdLineOptions();</span>
<span class="fc" id="L766">        options.addOption(&quot;v&quot;, VERBOSE_OPTION, &quot;verbose output&quot;);</span>
<span class="fc" id="L767">        options.addOption(&quot;h&quot;, HELP_OPTION, &quot;display this help message&quot;);</span>
<span class="fc" id="L768">        options.addOption(null, NOPROGRESS_OPTION, &quot;don't display progress&quot;);</span>
<span class="fc" id="L769">        options.addOption(&quot;i&quot;, IGNORE_NODES_OPTION, &quot;NODES&quot;, &quot;don't stream to this (comma separated) list of nodes&quot;);</span>
<span class="fc" id="L770">        options.addOption(&quot;d&quot;, INITIAL_HOST_ADDRESS_OPTION, &quot;initial hosts&quot;, &quot;Required. try to connect to these hosts (comma separated) initially for ring information&quot;);</span>
<span class="fc" id="L771">        options.addOption(&quot;p&quot;,  NATIVE_PORT_OPTION, &quot;native transport port&quot;, &quot;port used for native connection (default 9042)&quot;);</span>
<span class="fc" id="L772">        options.addOption(&quot;sp&quot;,  STORAGE_PORT_OPTION, &quot;storage port&quot;, &quot;port used for internode communication (default 7000)&quot;);</span>
<span class="fc" id="L773">        options.addOption(&quot;ssp&quot;,  SSL_STORAGE_PORT_OPTION, &quot;ssl storage port&quot;, &quot;port used for TLS internode communication (default 7001), this option is deprecated, all communication goes through storage port which handles encrypted communication as well&quot;);</span>
<span class="fc" id="L774">        options.addOption(&quot;t&quot;, THROTTLE_MBITS, &quot;throttle&quot;, &quot;throttle speed in Mbps (default 0 for unlimited), this option is deprecated, use \&quot;throttle-mib\&quot; instead&quot;);</span>
<span class="fc" id="L775">        options.addOption(null, THROTTLE_MEBIBYTES, &quot;throttle-mib&quot;, &quot;throttle speed in MiB/s (default 0 for unlimited)&quot;);</span>
<span class="fc" id="L776">        options.addOption(&quot;idct&quot;, INTER_DC_THROTTLE_MBITS, &quot;inter-dc-throttle&quot;, &quot;inter-datacenter throttle speed in Mbps (default 0 for unlimited), this option is deprecated, use \&quot;inter-dc-throttle-mib\&quot; instead&quot;);</span>
<span class="fc" id="L777">        options.addOption(null, INTER_DC_THROTTLE_MEBIBYTES, &quot;inter-dc-throttle-mib&quot;, &quot;inter-datacenter throttle speed in MiB/s (default 0 for unlimited)&quot;);</span>
<span class="fc" id="L778">        options.addOption(null, ENTIRE_SSTABLE_THROTTLE_MEBIBYTES, &quot;entire-sstable-throttle-mib&quot;, &quot;entire SSTable throttle speed in MiB/s (default 0 for unlimited)&quot;);</span>
<span class="fc" id="L779">        options.addOption(null, ENTIRE_SSTABLE_INTER_DC_THROTTLE_MEBIBYTES, &quot;entire-sstable-inter-dc-throttle-mib&quot;, &quot;entire SSTable inter-datacenter throttle speed in MiB/s (default 0 for unlimited)&quot;);</span>
<span class="fc" id="L780">        options.addOption(&quot;u&quot;, USER_OPTION, &quot;username&quot;, &quot;username for cassandra authentication&quot;);</span>
<span class="fc" id="L781">        options.addOption(&quot;pw&quot;, PASSWD_OPTION, &quot;password&quot;, &quot;password for cassandra authentication&quot;);</span>
<span class="fc" id="L782">        options.addOption(&quot;ap&quot;, AUTH_PROVIDER_OPTION, &quot;auth provider&quot;, &quot;custom AuthProvider class name for cassandra authentication&quot;);</span>
<span class="fc" id="L783">        options.addOption(&quot;cph&quot;, CONNECTIONS_PER_HOST, &quot;connectionsPerHost&quot;, &quot;number of concurrent connections-per-host.&quot;);</span>
        // ssl connection-related options
<span class="fc" id="L785">        options.addOption(&quot;ts&quot;, SSL_TRUSTSTORE, &quot;TRUSTSTORE&quot;, &quot;Client SSL: full path to truststore&quot;);</span>
<span class="fc" id="L786">        options.addOption(&quot;tspw&quot;, SSL_TRUSTSTORE_PW, &quot;TRUSTSTORE-PASSWORD&quot;, &quot;Client SSL: password of the truststore&quot;);</span>
<span class="fc" id="L787">        options.addOption(&quot;ks&quot;, SSL_KEYSTORE, &quot;KEYSTORE&quot;, &quot;Client SSL: full path to keystore&quot;);</span>
<span class="fc" id="L788">        options.addOption(&quot;kspw&quot;, SSL_KEYSTORE_PW, &quot;KEYSTORE-PASSWORD&quot;, &quot;Client SSL: password of the keystore&quot;);</span>
<span class="fc" id="L789">        options.addOption(&quot;prtcl&quot;, SSL_PROTOCOL, &quot;PROTOCOL&quot;, &quot;Client SSL: connections protocol to use (default: TLS)&quot;);</span>
<span class="fc" id="L790">        options.addOption(&quot;alg&quot;, SSL_ALGORITHM, &quot;ALGORITHM&quot;, &quot;Client SSL: algorithm&quot;);</span>
<span class="fc" id="L791">        options.addOption(&quot;st&quot;, SSL_STORE_TYPE, &quot;STORE-TYPE&quot;, &quot;Client SSL: type of store&quot;);</span>
<span class="fc" id="L792">        options.addOption(&quot;ciphers&quot;, SSL_CIPHER_SUITES, &quot;CIPHER-SUITES&quot;, &quot;Client SSL: comma-separated list of encryption suites to use&quot;);</span>
<span class="fc" id="L793">        options.addOption(&quot;f&quot;, CONFIG_PATH, &quot;path to config file&quot;, &quot;cassandra.yaml file path for streaming throughput and client/server SSL.&quot;);</span>
<span class="fc" id="L794">        options.addOption(&quot;k&quot;, TARGET_KEYSPACE, &quot;target keyspace name&quot;, &quot;target keyspace name&quot;);</span>
<span class="fc" id="L795">        options.addOption(&quot;tb&quot;, TARGET_TABLE, &quot;target table name&quot;, &quot;target table name&quot;);</span>
<span class="fc" id="L796">        return options;</span>
    }

    public static void printUsage(Options options)
    {
<span class="fc" id="L801">        String usage = String.format(&quot;%s [options] &lt;dir_path&gt;&quot;, TOOL_NAME);</span>
<span class="fc" id="L802">        String header = System.lineSeparator() +</span>
                &quot;Bulk load the sstables found in the directory &lt;dir_path&gt; to the configured cluster.&quot; +
                &quot;The parent directories of &lt;dir_path&gt; are used as the target keyspace/table name. &quot; +
                &quot;So for instance, to load an sstable named Standard1-g-1-Data.db into Keyspace1/Standard1, &quot; +
                &quot;you will need to have the files Standard1-g-1-Data.db and Standard1-g-1-Index.db into a directory /path/to/Keyspace1/Standard1/.&quot;;
<span class="fc" id="L807">        String footer = System.lineSeparator() +</span>
                &quot;You can provide cassandra.yaml file with -f command line option to set up streaming throughput, client and server encryption options. &quot; +
                &quot;Only stream_throughput_outbound, server_encryption_options and client_encryption_options are read from yaml. &quot; +
                &quot;You can override options read from cassandra.yaml with corresponding command line options.&quot;;
<span class="fc" id="L811">        new HelpFormatter().printHelp(usage, header, options, footer);</span>
<span class="fc" id="L812">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>