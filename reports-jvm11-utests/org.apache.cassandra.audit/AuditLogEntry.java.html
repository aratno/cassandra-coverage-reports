<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuditLogEntry.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.audit</a> &gt; <span class="el_source">AuditLogEntry.java</span></div><h1>AuditLogEntry.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.cassandra.audit;

import java.net.InetSocketAddress;
import java.net.UnknownHostException;
import java.util.UUID;
import javax.annotation.Nullable;

import org.apache.commons.lang3.StringUtils;

import org.apache.cassandra.auth.AuthenticatedUser;
import org.apache.cassandra.cql3.CQLStatement;
import org.apache.cassandra.cql3.QueryOptions;
import org.apache.cassandra.locator.InetAddressAndPort;
import org.apache.cassandra.service.ClientState;
import org.apache.cassandra.service.QueryState;
import org.apache.cassandra.utils.FBUtilities;

import static org.apache.cassandra.utils.Clock.Global.currentTimeMillis;

public class AuditLogEntry
{
<span class="fc" id="L39">    private final InetAddressAndPort host = FBUtilities.getBroadcastAddressAndPort();</span>
    private final InetAddressAndPort source;
    private final String user;
    private final long timestamp;
    private final AuditLogEntryType type;
    private final UUID batch;
    private final String keyspace;
    private final String scope;
    private final String operation;
    private final QueryOptions options;
    private final QueryState state;

    private AuditLogEntry(AuditLogEntryType type,
                          InetAddressAndPort source,
                          String user,
                          long timestamp,
                          UUID batch,
                          String keyspace,
                          String scope,
                          String operation,
                          QueryOptions options,
                          QueryState state)
<span class="fc" id="L61">    {</span>
<span class="fc" id="L62">        this.type = type;</span>
<span class="fc" id="L63">        this.source = source;</span>
<span class="fc" id="L64">        this.user = user;</span>
<span class="fc" id="L65">        this.timestamp = timestamp;</span>
<span class="fc" id="L66">        this.batch = batch;</span>
<span class="fc" id="L67">        this.keyspace = keyspace;</span>
<span class="fc" id="L68">        this.scope = scope;</span>
<span class="fc" id="L69">        this.operation = operation;</span>
<span class="fc" id="L70">        this.options = options;</span>
<span class="fc" id="L71">        this.state = state;</span>
<span class="fc" id="L72">    }</span>

    String getLogString()
    {
<span class="fc" id="L76">        StringBuilder builder = new StringBuilder(100);</span>
<span class="fc" id="L77">        builder.append(&quot;user:&quot;).append(user)</span>
<span class="fc" id="L78">               .append(&quot;|host:&quot;).append(host)</span>
<span class="fc" id="L79">               .append(&quot;|source:&quot;).append(source.getAddress());</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (source.getPort() &gt; 0)</span>
        {
<span class="fc" id="L82">            builder.append(&quot;|port:&quot;).append(source.getPort());</span>
        }

<span class="fc" id="L85">        builder.append(&quot;|timestamp:&quot;).append(timestamp)</span>
<span class="fc" id="L86">               .append(&quot;|type:&quot;).append(type)</span>
<span class="fc" id="L87">               .append(&quot;|category:&quot;).append(type.getCategory());</span>

<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        if (batch != null)</span>
        {
<span class="nc" id="L91">            builder.append(&quot;|batch:&quot;).append(batch);</span>
        }
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(keyspace))</span>
        {
<span class="fc" id="L95">            builder.append(&quot;|ks:&quot;).append(keyspace);</span>
        }
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (StringUtils.isNotBlank(scope))</span>
        {
<span class="fc" id="L99">            builder.append(&quot;|scope:&quot;).append(scope);</span>
        }
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(operation))</span>
        {
<span class="fc" id="L103">            builder.append(&quot;|operation:&quot;).append(operation);</span>
        }
<span class="fc" id="L105">        return builder.toString();</span>
    }

    public InetAddressAndPort getHost()
    {
<span class="nc" id="L110">        return host;</span>
    }

    public InetAddressAndPort getSource()
    {
<span class="fc" id="L115">        return source;</span>
    }

    public String getUser()
    {
<span class="fc" id="L120">        return user;</span>
    }

    public long getTimestamp()
    {
<span class="fc" id="L125">        return timestamp;</span>
    }

    public AuditLogEntryType getType()
    {
<span class="fc" id="L130">        return type;</span>
    }

    public UUID getBatch()
    {
<span class="nc" id="L135">        return batch;</span>
    }

    public String getKeyspace()
    {
<span class="fc" id="L140">        return keyspace;</span>
    }

    public String getScope()
    {
<span class="fc" id="L145">        return scope;</span>
    }

    public String getOperation()
    {
<span class="fc" id="L150">        return operation;</span>
    }

    public QueryOptions getOptions()
    {
<span class="nc" id="L155">        return options;</span>
    }

    public QueryState getState()
    {
<span class="nc" id="L160">        return state;</span>
    }

    public static class Builder
    {
        private static final InetAddressAndPort DEFAULT_SOURCE;

        static
        {
            try
            {
<span class="fc" id="L171">                DEFAULT_SOURCE = InetAddressAndPort.getByNameOverrideDefaults(&quot;0.0.0.0&quot;, 0);</span>
            }
<span class="nc" id="L173">            catch (UnknownHostException e)</span>
            {

<span class="nc" id="L176">                throw new RuntimeException(&quot;failed to create default source address&quot;, e);</span>
<span class="fc" id="L177">            }</span>
<span class="fc" id="L178">        }</span>

        private static final String DEFAULT_OPERATION = StringUtils.EMPTY;

        private AuditLogEntryType type;
        private InetAddressAndPort source;
        private String user;
        private long timestamp;
        private UUID batch;
        private String keyspace;
        private String scope;
        private String operation;
        private QueryOptions options;
        private QueryState state;

        public Builder(QueryState queryState)
<span class="fc" id="L194">        {</span>
<span class="fc" id="L195">            state = queryState;</span>

<span class="fc" id="L197">            ClientState clientState = queryState.getClientState();</span>

<span class="pc bpc" id="L199" title="1 of 2 branches missed.">            if (clientState != null)</span>
            {
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">                if (clientState.getRemoteAddress() != null)</span>
                {
<span class="fc" id="L203">                    InetSocketAddress addr = clientState.getRemoteAddress();</span>
<span class="fc" id="L204">                    source = InetAddressAndPort.getByAddressOverrideDefaults(addr.getAddress(), addr.getPort());</span>
                }

<span class="fc bfc" id="L207" title="All 2 branches covered.">                if (clientState.getUser() != null)</span>
                {
<span class="fc" id="L209">                    user = clientState.getUser().getName();</span>
                }
<span class="fc" id="L211">                keyspace = clientState.getRawKeyspace();</span>
            }
            else
            {
<span class="nc" id="L215">                source = DEFAULT_SOURCE;</span>
<span class="nc" id="L216">                user = AuthenticatedUser.SYSTEM_USER.getName();</span>
            }

<span class="fc" id="L219">            timestamp = currentTimeMillis();</span>
<span class="fc" id="L220">        }</span>

        public Builder(AuditLogEntry entry)
<span class="fc" id="L223">        {</span>
<span class="fc" id="L224">            type = entry.type;</span>
<span class="fc" id="L225">            source = entry.source;</span>
<span class="fc" id="L226">            user = entry.user;</span>
<span class="fc" id="L227">            timestamp = entry.timestamp;</span>
<span class="fc" id="L228">            batch = entry.batch;</span>
<span class="fc" id="L229">            keyspace = entry.keyspace;</span>
<span class="fc" id="L230">            scope = entry.scope;</span>
<span class="fc" id="L231">            operation = entry.operation;</span>
<span class="fc" id="L232">            options = entry.options;</span>
<span class="fc" id="L233">            state = entry.state;</span>
<span class="fc" id="L234">        }</span>

        public Builder setType(AuditLogEntryType type)
        {
<span class="fc" id="L238">            this.type = type;</span>
<span class="fc" id="L239">            return this;</span>
        }

        public Builder(AuditLogEntryType type)
<span class="fc" id="L243">        {</span>
<span class="fc" id="L244">            this.type = type;</span>
<span class="fc" id="L245">            operation = DEFAULT_OPERATION;</span>
<span class="fc" id="L246">        }</span>

        public Builder setUser(String user)
        {
<span class="nc" id="L250">            this.user = user;</span>
<span class="nc" id="L251">            return this;</span>
        }

        public Builder setBatch(UUID batch)
        {
<span class="fc" id="L256">            this.batch = batch;</span>
<span class="fc" id="L257">            return this;</span>
        }

        public Builder setTimestamp(long timestampMillis)
        {
<span class="fc" id="L262">            this.timestamp = timestampMillis;</span>
<span class="fc" id="L263">            return this;</span>
        }

        public Builder setKeyspace(QueryState queryState, @Nullable CQLStatement statement)
        {
<span class="pc bpc" id="L268" title="1 of 4 branches missed.">            keyspace = statement != null &amp;&amp; statement.getAuditLogContext().keyspace != null</span>
<span class="fc" id="L269">                       ? statement.getAuditLogContext().keyspace</span>
<span class="fc" id="L270">                       : queryState.getClientState().getRawKeyspace();</span>
<span class="fc" id="L271">            return this;</span>
        }

        public Builder setKeyspace(String keyspace)
        {
<span class="fc" id="L276">            this.keyspace = keyspace;</span>
<span class="fc" id="L277">            return this;</span>
        }

        public Builder setKeyspace(CQLStatement statement)
        {
<span class="fc" id="L282">            this.keyspace = statement.getAuditLogContext().keyspace;</span>
<span class="fc" id="L283">            return this;</span>
        }

        public Builder setScope(CQLStatement statement)
        {
<span class="fc" id="L288">            this.scope = statement.getAuditLogContext().scope;</span>
<span class="fc" id="L289">            return this;</span>
        }

        public Builder setOperation(String operation)
        {
<span class="fc" id="L294">            this.operation = operation;</span>
<span class="fc" id="L295">            return this;</span>
        }

        public void appendToOperation(String str)
        {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(str))</span>
            {
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">                if (operation.isEmpty())</span>
<span class="nc" id="L303">                    operation = str;</span>
                else
<span class="fc" id="L305">                    operation = operation.concat(&quot;; &quot;).concat(str);</span>
            }
<span class="fc" id="L307">        }</span>

        public Builder setOptions(QueryOptions options)
        {
<span class="fc" id="L311">            this.options = options;</span>
<span class="fc" id="L312">            return this;</span>
        }

        public AuditLogEntry build()
        {
<span class="fc bfc" id="L317" title="All 2 branches covered.">            timestamp = timestamp &gt; 0 ? timestamp : currentTimeMillis();</span>
<span class="fc" id="L318">            return new AuditLogEntry(type, source, user, timestamp, batch, keyspace, scope, operation, options, state);</span>
        }
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>