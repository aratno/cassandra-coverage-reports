<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCryptoProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.security</a> &gt; <span class="el_source">AbstractCryptoProvider.java</span></div><h1>AbstractCryptoProvider.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.security;

import org.apache.cassandra.exceptions.ConfigurationException;
import org.apache.cassandra.utils.FBUtilities;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.security.Provider;
import java.security.Security;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

import static java.lang.String.format;
import static org.apache.cassandra.config.CassandraRelevantProperties.FAIL_ON_MISSING_CRYPTO_PROVIDER;

public abstract class AbstractCryptoProvider
{
<span class="fc" id="L38">    protected static final Logger logger = LoggerFactory.getLogger(AbstractCryptoProvider.class);</span>
    public static final String FAIL_ON_MISSING_PROVIDER_KEY = &quot;fail_on_missing_provider&quot;;

    protected final boolean failOnMissingProvider;
    private final Map&lt;String, String&gt; properties;

    public AbstractCryptoProvider(Map&lt;String, String&gt; args)
<span class="fc" id="L45">    {</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        this.properties = args == null ? new HashMap&lt;&gt;() : args;</span>
<span class="fc" id="L47">        boolean failOnMissingProviderFromProperties = Boolean.parseBoolean(this.properties.getOrDefault(FAIL_ON_MISSING_PROVIDER_KEY, &quot;false&quot;));</span>
<span class="fc" id="L48">        failOnMissingProvider = FAIL_ON_MISSING_CRYPTO_PROVIDER.getBoolean(failOnMissingProviderFromProperties);</span>
<span class="fc" id="L49">    }</span>

    /**
     * Returns unmodifiable properties of this crypto provider
     *
     * @return crypto provider properties
     */
    public Map&lt;String, String&gt; getProperties()
    {
<span class="nc" id="L58">        return Collections.unmodifiableMap(properties);</span>
    }

    /**
     * Returns name of the provider, as returned from {@link Provider#getName()}
     *
     * @return name of the provider
     */
    public abstract String getProviderName();

    /**
     * Returns the name of the class which installs specific provider of name {@link #getProviderName()}.
     *
     * @return name of class of provider
     */
    public abstract String getProviderClassAsString();

    /**
     * Returns a runnable which installs this crypto provider.
     *
     * @return runnable which installs this provider
     */
    protected abstract Runnable installator();

    /**
     * Returns boolean telling if this provider was installed properly.
     *
     * @return {@code true} if provider was installed properly, {@code false} otherwise.
     */
    protected abstract boolean isHealthyInstallation() throws Exception;

    /**
     * The default installation runs {@link AbstractCryptoProvider#installator()} and after that
     * {@link AbstractCryptoProvider#isHealthyInstallation()}.
     * &lt;p&gt;
     * If any step fails, it will not throw an exception unless the parameter
     * {@link AbstractCryptoProvider#FAIL_ON_MISSING_PROVIDER_KEY} is {@code true}.
     */
    public void install() throws Exception
    {
<span class="fc" id="L98">        String failureMessage = null;</span>
<span class="fc" id="L99">        Throwable t = null;</span>
        try
        {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">            if (JREProvider.class.getName().equals(getProviderClassAsString()))</span>
            {
<span class="fc" id="L104">                logger.info(format(&quot;Installation of a crypto provider was skipped as %s was used.&quot;, JREProvider.class.getName()));</span>
<span class="fc" id="L105">                return;</span>
            }

<span class="nc" id="L108">            FBUtilities.classForName(getProviderClassAsString(), &quot;crypto provider&quot;);</span>

<span class="nc" id="L110">            String providerName = getProviderName();</span>
<span class="nc" id="L111">            int providerPosition = getProviderPosition(providerName);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (providerPosition &gt; 0)</span>
            {
<span class="nc bnc" id="L114" title="All 2 branches missed.">                if (providerPosition == 1)</span>
                {
<span class="nc" id="L116">                    logger.info(&quot;{} was already installed on position {}.&quot;, providerName, providerPosition);</span>
                }
<span class="nc bnc" id="L118" title="All 2 branches missed.">                else if (failOnMissingProvider)</span>
                {
<span class="nc" id="L120">                    throw new IllegalStateException(String.format(&quot;%s was already installed on position %s.&quot;, providerName, providerPosition));</span>
                }
                else
                {
<span class="nc" id="L124">                    logger.warn(&quot;{} was already installed on position {}. Check the configuration of &quot; +</span>
                                &quot;JRE and either remove the provider from java.security or do not install this provider &quot; +
<span class="nc" id="L126">                                &quot;by Cassandra.&quot;, providerName, providerPosition);</span>
<span class="nc" id="L127">                    return;</span>
                }
            }
            else
            {
<span class="nc" id="L132">                Runnable r = installator();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (r == null)</span>
<span class="nc" id="L134">                    throw new IllegalStateException(&quot;Installator runnable can not be null!&quot;);</span>
                else
<span class="nc" id="L136">                    r.run();</span>
            }

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (isHealthyInstallation())</span>
<span class="nc" id="L140">                logger.info(&quot;{} health check OK.&quot;, getProviderName());</span>
            else
<span class="nc" id="L142">                failureMessage = format(&quot;%s has not passed the health check. &quot; +</span>
                                        &quot;Check node's architecture (`uname -m`) is supported, see lib/&lt;arch&gt; subdirectories. &quot; +
                                        &quot;The correct architecture-specific library for %s needs to be on the classpath. &quot;,
<span class="nc" id="L145">                                        getProviderName(),</span>
<span class="nc" id="L146">                                        getProviderClassAsString());</span>
        }
<span class="nc" id="L148">        catch (ConfigurationException ex)</span>
        {
<span class="nc" id="L150">            failureMessage = getProviderClassAsString() + &quot; is not on the class path! &quot; +</span>
                             &quot;Check node's architecture (`uname -m`) is supported, see lib/&lt;arch&gt; subdirectories. &quot; +
                             &quot;The correct architecture-specific library for needs to be on the classpath.&quot;;
        }
<span class="nc" id="L154">        catch (Throwable ex)</span>
        {
<span class="nc" id="L156">            failureMessage = format(&quot;The installation of %s was not successful, reason: %s&quot;,</span>
<span class="nc" id="L157">                                    getProviderClassAsString(), ex.getMessage());</span>
<span class="nc" id="L158">            t = ex;</span>
<span class="nc" id="L159">        }</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (failureMessage != null)</span>
        {
            // To be sure there is not any leftover, proactively remove this provider in case of any failure.
            // This method returns silently if the provider is not installed or if name is null.
            try
            {
<span class="nc" id="L167">                uninstall();</span>
            }
<span class="nc" id="L169">            catch (Throwable throwable)</span>
            {
<span class="nc" id="L171">                logger.warn(&quot;Uninstallation of {} failed&quot;, getProviderName(), throwable);</span>
<span class="nc" id="L172">            }</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (failOnMissingProvider)</span>
<span class="nc" id="L175">                throw new ConfigurationException(failureMessage, t);</span>
            else
<span class="nc" id="L177">                logger.warn(failureMessage);</span>
        }
<span class="nc" id="L179">    }</span>

    /**
     * Uninstalls this crypto provider of name {@link #getProviderName()}
     *
     * @see Security#removeProvider(String)
     */
    public void uninstall()
    {
<span class="nc" id="L188">        Security.removeProvider(getProviderName());</span>
<span class="nc" id="L189">    }</span>

    private int getProviderPosition(String providerName)
    {
<span class="nc" id="L193">        Provider[] providers = Security.getProviders();</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        for (int i = 0; i &lt; providers.length; i++)</span>
        {
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (providers[i].getName().equals(providerName))</span>
            {
<span class="nc" id="L199">                return i + 1;</span>
            }
        }

<span class="nc" id="L203">        return -1;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>