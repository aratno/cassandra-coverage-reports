<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Values.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.db.guardrails</a> &gt; <span class="el_source">Values.java</span></div><h1>Values.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.db.guardrails;

import java.util.Set;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.Nullable;

import com.google.common.collect.Sets;

import org.apache.cassandra.service.ClientState;

import static java.lang.String.format;

/**
 * A guardrail that warns about some specific values, warns about but ignores some other values, and/or rejects the use
 * of some other values.
 *
 * @param &lt;T&gt; The type of the values of which certain are warned, ignored and/or disallowed.
 */
public class Values&lt;T&gt; extends Guardrail
{
    private final Function&lt;ClientState, Set&lt;T&gt;&gt; warnedValues;
    private final Function&lt;ClientState, Set&lt;T&gt;&gt; ignoredValues;
    private final Function&lt;ClientState, Set&lt;T&gt;&gt; disallowedValues;
    private final String what;

    /**
     * Creates a new values guardrail.
     *
     * @param name             the identifying name of the guardrail
     * @param reason           the optional description of the reason for guarding the operation
     * @param warnedValues     a {@link ClientState}-based provider of the values for which a warning is triggered.
     * @param ignoredValues    a {@link ClientState}-based provider of the values that are ignored.
     * @param disallowedValues a {@link ClientState}-based provider of the values that are disallowed.
     * @param what             The feature that is guarded by this guardrail (for reporting in error messages).
     */
    public Values(String name,
                  @Nullable String reason,
                  Function&lt;ClientState, Set&lt;T&gt;&gt; warnedValues,
                  Function&lt;ClientState, Set&lt;T&gt;&gt; ignoredValues,
                  Function&lt;ClientState, Set&lt;T&gt;&gt; disallowedValues,
                  String what)
    {
<span class="fc" id="L63">        super(name, reason);</span>
<span class="fc" id="L64">        this.warnedValues = warnedValues;</span>
<span class="fc" id="L65">        this.ignoredValues = ignoredValues;</span>
<span class="fc" id="L66">        this.disallowedValues = disallowedValues;</span>
<span class="fc" id="L67">        this.what = what;</span>
<span class="fc" id="L68">    }</span>

    /**
     * Triggers a warning for each of the provided values that is discouraged by this guardrail. If any of the values
     * is disallowed it will abort the operation.
     * &lt;p&gt;
     * This assumes that there aren't any values to be ignored, thus it doesn't require an ignore action. If this is
     * not the case and the provided value is set up to be ignored this will throw an assertion error.
     *
     * @param values The values to check.
     * @param state  The client state, used to skip the check if the query is internal or is done by a superuser.
     *               A {@code null} value means that the check should be done regardless of the query.
     */
    public void guard(Set&lt;T&gt; values, @Nullable ClientState state)
    {
<span class="nc" id="L83">        guard(values, x -&gt; {</span>
<span class="nc" id="L84">            throw new AssertionError(format(&quot;There isn't an ignore action for %s, but value %s is setup to be ignored&quot;,</span>
                                            what, x));
        }, state);
<span class="nc" id="L87">    }</span>

    /**
     * Triggers a warning for each of the provided values that is discouraged by this guardrail. Also triggers a warning
     * for each of the provided values that is ignored by this guardrail and triggers the provided action to ignore it.
     * If any of the values is disallowed it will abort the operation.
     *
     * @param values       The values to check.
     * @param ignoreAction An action called on the subset of {@code values} that should be ignored. This action
     *                     should do whatever is necessary to make sure the value is ignored.
     * @param state        The client state, used to skip the check if the query is internal or is done by a superuser.
     *                     A {@code null} value means that the check should be done regardless of the query, although it
     *                     won't throw any exception if the failure threshold is exceeded. This is so because checks
     *                     without an associated client come from asynchronous processes such as compaction, and we
     *                     don't want to interrupt such processes.
     */
    public void guard(Set&lt;T&gt; values, Consumer&lt;T&gt; ignoreAction, @Nullable ClientState state)
    {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (!enabled(state))</span>
<span class="fc" id="L106">            return;</span>

<span class="nc" id="L108">        Set&lt;T&gt; disallowed = disallowedValues.apply(state);</span>
<span class="nc" id="L109">        Set&lt;T&gt; toDisallow = Sets.intersection(values, disallowed);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (!toDisallow.isEmpty())</span>
<span class="nc" id="L111">            fail(format(&quot;Provided values %s are not allowed for %s (disallowed values are: %s)&quot;,</span>
<span class="nc" id="L112">                        toDisallow.stream().sorted().collect(Collectors.toList()), what, disallowed), state);</span>

<span class="nc" id="L114">        Set&lt;T&gt; ignored = ignoredValues.apply(state);</span>
<span class="nc" id="L115">        Set&lt;T&gt; toIgnore = Sets.intersection(values, ignored);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!toIgnore.isEmpty())</span>
        {
<span class="nc" id="L118">            warn(format(&quot;Ignoring provided values %s as they are not supported for %s (ignored values are: %s)&quot;,</span>
<span class="nc" id="L119">                        toIgnore.stream().sorted().collect(Collectors.toList()), what, ignored));</span>
<span class="nc" id="L120">            toIgnore.forEach(ignoreAction);</span>
        }

<span class="nc" id="L123">        Set&lt;T&gt; warned = warnedValues.apply(state);</span>
<span class="nc" id="L124">        Set&lt;T&gt; toWarn = Sets.intersection(values, warned);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (!toWarn.isEmpty())</span>
<span class="nc" id="L126">            warn(format(&quot;Provided values %s are not recommended for %s (warned values are: %s)&quot;,</span>
<span class="nc" id="L127">                        toWarn.stream().sorted().collect(Collectors.toList()), what, warned));</span>
<span class="nc" id="L128">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>