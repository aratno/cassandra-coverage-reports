<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Verb.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.net</a> &gt; <span class="el_source">Verb.java</span></div><h1>Verb.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.cassandra.net;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.function.Supplier;
import java.util.function.ToLongFunction;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.ImmutableList;

import org.apache.cassandra.batchlog.Batch;
import org.apache.cassandra.batchlog.BatchRemoveVerbHandler;
import org.apache.cassandra.batchlog.BatchStoreVerbHandler;
import org.apache.cassandra.concurrent.Stage;
import org.apache.cassandra.config.DatabaseDescriptor;
import org.apache.cassandra.db.CounterMutation;
import org.apache.cassandra.db.CounterMutationVerbHandler;
import org.apache.cassandra.db.Mutation;
import org.apache.cassandra.db.MutationVerbHandler;
import org.apache.cassandra.db.ReadCommand;
import org.apache.cassandra.db.ReadCommandVerbHandler;
import org.apache.cassandra.db.ReadRepairVerbHandler;
import org.apache.cassandra.db.ReadResponse;
import org.apache.cassandra.db.SnapshotCommand;
import org.apache.cassandra.db.TruncateResponse;
import org.apache.cassandra.db.TruncateVerbHandler;
import org.apache.cassandra.db.TruncateRequest;
import org.apache.cassandra.exceptions.RequestFailureReason;
import org.apache.cassandra.gms.GossipDigestAck;
import org.apache.cassandra.gms.GossipDigestAck2;
import org.apache.cassandra.gms.GossipDigestAck2VerbHandler;
import org.apache.cassandra.gms.GossipDigestAckVerbHandler;
import org.apache.cassandra.gms.GossipDigestSyn;
import org.apache.cassandra.gms.GossipDigestSynVerbHandler;
import org.apache.cassandra.gms.GossipShutdownVerbHandler;
import org.apache.cassandra.hints.HintMessage;
import org.apache.cassandra.hints.HintVerbHandler;
import org.apache.cassandra.io.IVersionedAsymmetricSerializer;
import org.apache.cassandra.repair.RepairMessageVerbHandler;
import org.apache.cassandra.repair.messages.CleanupMessage;
import org.apache.cassandra.repair.messages.FailSession;
import org.apache.cassandra.repair.messages.FinalizeCommit;
import org.apache.cassandra.repair.messages.FinalizePromise;
import org.apache.cassandra.repair.messages.FinalizePropose;
import org.apache.cassandra.repair.messages.PrepareConsistentRequest;
import org.apache.cassandra.repair.messages.PrepareConsistentResponse;
import org.apache.cassandra.repair.messages.PrepareMessage;
import org.apache.cassandra.repair.messages.SnapshotMessage;
import org.apache.cassandra.repair.messages.StatusRequest;
import org.apache.cassandra.repair.messages.StatusResponse;
import org.apache.cassandra.repair.messages.SyncResponse;
import org.apache.cassandra.repair.messages.SyncRequest;
import org.apache.cassandra.repair.messages.ValidationResponse;
import org.apache.cassandra.repair.messages.ValidationRequest;
import org.apache.cassandra.schema.SchemaMutationsSerializer;
import org.apache.cassandra.schema.SchemaPullVerbHandler;
import org.apache.cassandra.schema.SchemaPushVerbHandler;
import org.apache.cassandra.schema.SchemaVersionVerbHandler;
import org.apache.cassandra.service.paxos.PaxosCommit;
import org.apache.cassandra.service.paxos.PaxosCommitAndPrepare;
import org.apache.cassandra.service.paxos.PaxosPrepare;
import org.apache.cassandra.service.paxos.PaxosPrepareRefresh;
import org.apache.cassandra.service.paxos.PaxosPropose;
import org.apache.cassandra.service.paxos.PaxosRepair;
import org.apache.cassandra.service.paxos.cleanup.PaxosCleanupHistory;
import org.apache.cassandra.service.paxos.cleanup.PaxosCleanupRequest;
import org.apache.cassandra.service.paxos.cleanup.PaxosCleanupResponse;
import org.apache.cassandra.service.paxos.cleanup.PaxosCleanupComplete;
import org.apache.cassandra.service.paxos.cleanup.PaxosStartPrepareCleanup;
import org.apache.cassandra.service.paxos.cleanup.PaxosFinishPrepareCleanup;
import org.apache.cassandra.utils.BooleanSerializer;
import org.apache.cassandra.service.EchoVerbHandler;
import org.apache.cassandra.service.SnapshotVerbHandler;
import org.apache.cassandra.service.paxos.Commit;
import org.apache.cassandra.service.paxos.Commit.Agreed;
import org.apache.cassandra.service.paxos.PrepareResponse;
import org.apache.cassandra.service.paxos.v1.PrepareVerbHandler;
import org.apache.cassandra.service.paxos.v1.ProposeVerbHandler;
import org.apache.cassandra.streaming.ReplicationDoneVerbHandler;
import org.apache.cassandra.utils.ReflectionUtils;
import org.apache.cassandra.utils.TimeUUID;
import org.apache.cassandra.utils.UUIDSerializer;

import static java.util.concurrent.TimeUnit.NANOSECONDS;
import static org.apache.cassandra.concurrent.Stage.*;
import static org.apache.cassandra.net.VerbTimeouts.*;
import static org.apache.cassandra.net.Verb.Kind.*;
import static org.apache.cassandra.net.Verb.Priority.*;

/**
 * Note that priorities except P0 are presently unused.  P0 corresponds to urgent, i.e. what used to be the &quot;Gossip&quot; connection.
 */
<span class="fc" id="L112">public enum Verb</span>
{
<span class="fc" id="L114">    MUTATION_RSP           (60,  P1, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L115">    MUTATION_REQ           (0,   P3, writeTimeout,    MUTATION,          () -&gt; Mutation.serializer,                  () -&gt; MutationVerbHandler.instance,        MUTATION_RSP        ),</span>
<span class="fc" id="L116">    HINT_RSP               (61,  P1, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L117">    HINT_REQ               (1,   P4, writeTimeout,    MUTATION,          () -&gt; HintMessage.serializer,               () -&gt; HintVerbHandler.instance,            HINT_RSP            ),</span>
<span class="fc" id="L118">    READ_REPAIR_RSP        (62,  P1, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L119">    READ_REPAIR_REQ        (2,   P1, writeTimeout,    MUTATION,          () -&gt; Mutation.serializer,                  () -&gt; ReadRepairVerbHandler.instance,      READ_REPAIR_RSP     ),</span>
<span class="pc" id="L120">    BATCH_STORE_RSP        (65,  P1, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L121">    BATCH_STORE_REQ        (5,   P3, writeTimeout,    MUTATION,          () -&gt; Batch.serializer,                     () -&gt; BatchStoreVerbHandler.instance,      BATCH_STORE_RSP     ),</span>
<span class="pc" id="L122">    BATCH_REMOVE_RSP       (66,  P1, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L123">    BATCH_REMOVE_REQ       (6,   P3, writeTimeout,    MUTATION,          () -&gt; TimeUUID.Serializer.instance,         () -&gt; BatchRemoveVerbHandler.instance,     BATCH_REMOVE_RSP    ),</span>

<span class="pc" id="L125">    PAXOS_PREPARE_RSP      (93,  P2, writeTimeout,    REQUEST_RESPONSE,  () -&gt; PrepareResponse.serializer,           () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L126">    PAXOS_PREPARE_REQ      (33,  P2, writeTimeout,    MUTATION,          () -&gt; Commit.serializer,                    () -&gt; PrepareVerbHandler.instance,         PAXOS_PREPARE_RSP   ),</span>
<span class="pc" id="L127">    PAXOS_PROPOSE_RSP      (94,  P2, writeTimeout,    REQUEST_RESPONSE,  () -&gt; BooleanSerializer.serializer,         () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L128">    PAXOS_PROPOSE_REQ      (34,  P2, writeTimeout,    MUTATION,          () -&gt; Commit.serializer,                    () -&gt; ProposeVerbHandler.instance,         PAXOS_PROPOSE_RSP   ),</span>
<span class="pc" id="L129">    PAXOS_COMMIT_RSP       (95,  P2, writeTimeout,    REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L130">    PAXOS_COMMIT_REQ       (35,  P2, writeTimeout,    MUTATION,          () -&gt; Agreed.serializer,                    () -&gt; PaxosCommit.requestHandler,          PAXOS_COMMIT_RSP    ),</span>

<span class="pc" id="L132">    TRUNCATE_RSP           (79,  P0, truncateTimeout, REQUEST_RESPONSE,  () -&gt; TruncateResponse.serializer,          () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L133">    TRUNCATE_REQ           (19,  P0, truncateTimeout, MUTATION,          () -&gt; TruncateRequest.serializer,           () -&gt; TruncateVerbHandler.instance,        TRUNCATE_RSP        ),</span>

<span class="pc" id="L135">    COUNTER_MUTATION_RSP   (84,  P1, counterTimeout,  REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L136">    COUNTER_MUTATION_REQ   (24,  P2, counterTimeout,  COUNTER_MUTATION,  () -&gt; CounterMutation.serializer,           () -&gt; CounterMutationVerbHandler.instance, COUNTER_MUTATION_RSP),</span>

<span class="fc" id="L138">    READ_RSP               (63,  P2, readTimeout,     REQUEST_RESPONSE,  () -&gt; ReadResponse.serializer,              () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L139">    READ_REQ               (3,   P3, readTimeout,     READ,              () -&gt; ReadCommand.serializer,               () -&gt; ReadCommandVerbHandler.instance,     READ_RSP            ),</span>
<span class="fc" id="L140">    RANGE_RSP              (69,  P2, rangeTimeout,    REQUEST_RESPONSE,  () -&gt; ReadResponse.serializer,              () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L141">    RANGE_REQ              (9,   P3, rangeTimeout,    READ,              () -&gt; ReadCommand.serializer,               () -&gt; ReadCommandVerbHandler.instance,     RANGE_RSP           ),</span>

<span class="fc" id="L143">    GOSSIP_DIGEST_SYN      (14,  P0, longTimeout,     GOSSIP,            () -&gt; GossipDigestSyn.serializer,           () -&gt; GossipDigestSynVerbHandler.instance                      ),</span>
<span class="fc" id="L144">    GOSSIP_DIGEST_ACK      (15,  P0, longTimeout,     GOSSIP,            () -&gt; GossipDigestAck.serializer,           () -&gt; GossipDigestAckVerbHandler.instance                      ),</span>
<span class="fc" id="L145">    GOSSIP_DIGEST_ACK2     (16,  P0, longTimeout,     GOSSIP,            () -&gt; GossipDigestAck2.serializer,          () -&gt; GossipDigestAck2VerbHandler.instance                     ),</span>
<span class="fc" id="L146">    GOSSIP_SHUTDOWN        (29,  P0, rpcTimeout,      GOSSIP,            () -&gt; NoPayload.serializer,                 () -&gt; GossipShutdownVerbHandler.instance                       ),</span>

<span class="fc" id="L148">    ECHO_RSP               (91,  P0, rpcTimeout,      GOSSIP,            () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L149">    ECHO_REQ               (31,  P0, rpcTimeout,      GOSSIP,            () -&gt; NoPayload.serializer,                 () -&gt; EchoVerbHandler.instance,            ECHO_RSP            ),</span>
<span class="fc" id="L150">    PING_RSP               (97,  P1, pingTimeout,     GOSSIP,            () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L151">    PING_REQ               (37,  P1, pingTimeout,     GOSSIP,            () -&gt; PingRequest.serializer,               () -&gt; PingVerbHandler.instance,            PING_RSP            ),</span>

    // P1 because messages can be arbitrarily large or aren't crucial
<span class="pc" id="L154">    SCHEMA_PUSH_RSP        (98,  P1, rpcTimeout,      MIGRATION,         () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L155">    SCHEMA_PUSH_REQ        (18,  P1, rpcTimeout,      MIGRATION,         () -&gt; SchemaMutationsSerializer.instance,   () -&gt; SchemaPushVerbHandler.instance,      SCHEMA_PUSH_RSP     ),</span>
<span class="fc" id="L156">    SCHEMA_PULL_RSP        (88,  P1, rpcTimeout,      MIGRATION,         () -&gt; SchemaMutationsSerializer.instance,   () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L157">    SCHEMA_PULL_REQ        (28,  P1, rpcTimeout,      MIGRATION,         () -&gt; NoPayload.serializer,                 () -&gt; SchemaPullVerbHandler.instance,      SCHEMA_PULL_RSP     ),</span>
<span class="pc" id="L158">    SCHEMA_VERSION_RSP     (80,  P1, rpcTimeout,      MIGRATION,         () -&gt; UUIDSerializer.serializer,            () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L159">    SCHEMA_VERSION_REQ     (20,  P1, rpcTimeout,      MIGRATION,         () -&gt; NoPayload.serializer,                 () -&gt; SchemaVersionVerbHandler.instance,   SCHEMA_VERSION_RSP  ),</span>

    // repair; mostly doesn't use callbacks and sends responses as their own request messages, with matching sessions by uuid; should eventually harmonize and make idiomatic
    // for the repair messages that implement retry logic, use rpcTimeout so the single request fails faster, then retries can be used to recover
<span class="pc" id="L163">    REPAIR_RSP             (100, P1, repairTimeout,   REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L164">    VALIDATION_RSP         (102, P1, repairValidationRspTimeout,    ANTI_ENTROPY,      () -&gt; ValidationResponse.serializer,        () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L165">    VALIDATION_REQ         (101, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; ValidationRequest.serializer,         () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L166">    SYNC_RSP               (104, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; SyncResponse.serializer,              () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L167">    SYNC_REQ               (103, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; SyncRequest.serializer,               () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L168">    PREPARE_MSG            (105, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; PrepareMessage.serializer,            () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L169">    SNAPSHOT_MSG           (106, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; SnapshotMessage.serializer,           () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L170">    CLEANUP_MSG            (107, P1, repairWithBackoffTimeout,      ANTI_ENTROPY,      () -&gt; CleanupMessage.serializer,            () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L171">    PREPARE_CONSISTENT_RSP (109, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; PrepareConsistentResponse.serializer, () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L172">    PREPARE_CONSISTENT_REQ (108, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; PrepareConsistentRequest.serializer,  () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L173">    FINALIZE_PROPOSE_MSG   (110, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; FinalizePropose.serializer,           () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L174">    FINALIZE_PROMISE_MSG   (111, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; FinalizePromise.serializer,           () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L175">    FINALIZE_COMMIT_MSG    (112, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; FinalizeCommit.serializer,            () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L176">    FAILED_SESSION_MSG     (113, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; FailSession.serializer,               () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L177">    STATUS_RSP             (115, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; StatusResponse.serializer,            () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>
<span class="pc" id="L178">    STATUS_REQ             (114, P1, repairTimeout,   ANTI_ENTROPY,      () -&gt; StatusRequest.serializer,             () -&gt; RepairMessageVerbHandler.instance(),   REPAIR_RSP          ),</span>

<span class="pc" id="L180">    REPLICATION_DONE_RSP   (82,  P0, rpcTimeout,      MISC,              () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L181">    REPLICATION_DONE_REQ   (22,  P0, rpcTimeout,      MISC,              () -&gt; NoPayload.serializer,                 () -&gt; ReplicationDoneVerbHandler.instance, REPLICATION_DONE_RSP),</span>
<span class="pc" id="L182">    SNAPSHOT_RSP           (87,  P0, rpcTimeout,      MISC,              () -&gt; NoPayload.serializer,                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="pc" id="L183">    SNAPSHOT_REQ           (27,  P0, rpcTimeout,      MISC,              () -&gt; SnapshotCommand.serializer,           () -&gt; SnapshotVerbHandler.instance,        SNAPSHOT_RSP        ),</span>

<span class="pc" id="L185">    PAXOS2_COMMIT_REMOTE_REQ         (38, P2, writeTimeout,  MUTATION,          () -&gt; Mutation.serializer,                     () -&gt; MutationVerbHandler.instance,                          MUTATION_RSP                     ),</span>
<span class="pc" id="L186">    PAXOS2_COMMIT_REMOTE_RSP         (39, P2, writeTimeout,  REQUEST_RESPONSE,  () -&gt; NoPayload.serializer,                    () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L187">    PAXOS2_PREPARE_RSP               (50, P2, writeTimeout,  REQUEST_RESPONSE,  () -&gt; PaxosPrepare.responseSerializer,         () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L188">    PAXOS2_PREPARE_REQ               (40, P2, writeTimeout,  MUTATION,          () -&gt; PaxosPrepare.requestSerializer,          () -&gt; PaxosPrepare.requestHandler,                           PAXOS2_PREPARE_RSP               ),</span>
<span class="pc" id="L189">    PAXOS2_PREPARE_REFRESH_RSP       (51, P2, writeTimeout,  REQUEST_RESPONSE,  () -&gt; PaxosPrepareRefresh.responseSerializer,  () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L190">    PAXOS2_PREPARE_REFRESH_REQ       (41, P2, writeTimeout,  MUTATION,          () -&gt; PaxosPrepareRefresh.requestSerializer,   () -&gt; PaxosPrepareRefresh.requestHandler,                    PAXOS2_PREPARE_REFRESH_RSP       ),</span>
<span class="pc" id="L191">    PAXOS2_PROPOSE_RSP               (52, P2, writeTimeout,  REQUEST_RESPONSE,  () -&gt; PaxosPropose.responseSerializer,         () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L192">    PAXOS2_PROPOSE_REQ               (42, P2, writeTimeout,  MUTATION,          () -&gt; PaxosPropose.requestSerializer,          () -&gt; PaxosPropose.requestHandler,                           PAXOS2_PROPOSE_RSP               ),</span>
<span class="pc" id="L193">    PAXOS2_COMMIT_AND_PREPARE_RSP    (53, P2, writeTimeout,  REQUEST_RESPONSE,  () -&gt; PaxosPrepare.responseSerializer,         () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L194">    PAXOS2_COMMIT_AND_PREPARE_REQ    (43, P2, writeTimeout,  MUTATION,          () -&gt; PaxosCommitAndPrepare.requestSerializer, () -&gt; PaxosCommitAndPrepare.requestHandler,                  PAXOS2_COMMIT_AND_PREPARE_RSP    ),</span>
<span class="pc" id="L195">    PAXOS2_REPAIR_RSP                (54, P2, writeTimeout,  PAXOS_REPAIR,      () -&gt; PaxosRepair.responseSerializer,          () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L196">    PAXOS2_REPAIR_REQ                (44, P2, writeTimeout,  PAXOS_REPAIR,      () -&gt; PaxosRepair.requestSerializer,           () -&gt; PaxosRepair.requestHandler,                            PAXOS2_REPAIR_RSP                ),</span>
<span class="pc" id="L197">    PAXOS2_CLEANUP_START_PREPARE_RSP (55, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; PaxosCleanupHistory.serializer,          () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L198">    PAXOS2_CLEANUP_START_PREPARE_REQ (45, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; PaxosStartPrepareCleanup.serializer,     () -&gt; PaxosStartPrepareCleanup.verbHandler,                  PAXOS2_CLEANUP_START_PREPARE_RSP ),</span>
<span class="pc" id="L199">    PAXOS2_CLEANUP_RSP               (56, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; NoPayload.serializer,                    () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L200">    PAXOS2_CLEANUP_REQ               (46, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; PaxosCleanupRequest.serializer,          () -&gt; PaxosCleanupRequest.verbHandler,                       PAXOS2_CLEANUP_RSP               ),</span>
<span class="pc" id="L201">    PAXOS2_CLEANUP_RSP2              (57, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; PaxosCleanupResponse.serializer,         () -&gt; PaxosCleanupResponse.verbHandler                                                        ),</span>
<span class="pc" id="L202">    PAXOS2_CLEANUP_FINISH_PREPARE_RSP(58, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; NoPayload.serializer,                    () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L203">    PAXOS2_CLEANUP_FINISH_PREPARE_REQ(47, P2, repairTimeout, IMMEDIATE,         () -&gt; PaxosCleanupHistory.serializer,          () -&gt; PaxosFinishPrepareCleanup.verbHandler,                 PAXOS2_CLEANUP_FINISH_PREPARE_RSP),</span>
<span class="pc" id="L204">    PAXOS2_CLEANUP_COMPLETE_RSP      (59, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; NoPayload.serializer,                    () -&gt; ResponseVerbHandler.instance                                                            ),</span>
<span class="pc" id="L205">    PAXOS2_CLEANUP_COMPLETE_REQ      (48, P2, repairTimeout, PAXOS_REPAIR,      () -&gt; PaxosCleanupComplete.serializer,         () -&gt; PaxosCleanupComplete.verbHandler,                      PAXOS2_CLEANUP_COMPLETE_RSP      ),</span>

    // generic failure response
<span class="pc" id="L208">    FAILURE_RSP            (99,  P0, noTimeout,       REQUEST_RESPONSE,  () -&gt; RequestFailureReason.serializer,      () -&gt; ResponseVerbHandler.instance                             ),</span>

    // dummy verbs
<span class="pc" id="L211">    _TRACE                 (30,  P1, rpcTimeout,      TRACING,           () -&gt; NoPayload.serializer,                 () -&gt; null                                                     ),</span>
<span class="pc" id="L212">    _SAMPLE                (49,  P1, rpcTimeout,      INTERNAL_RESPONSE, () -&gt; NoPayload.serializer,                 () -&gt; null                                                     ),</span>
<span class="pc" id="L213">    _TEST_1                (10,  P0, writeTimeout,    IMMEDIATE,         () -&gt; NoPayload.serializer,                 () -&gt; null                                                     ),</span>
<span class="pc" id="L214">    _TEST_2                (11,  P1, rpcTimeout,      IMMEDIATE,         () -&gt; NoPayload.serializer,                 () -&gt; null                                                     ),</span>

<span class="fc" id="L216">    @Deprecated</span>
<span class="nc" id="L217">    REQUEST_RSP            (4,   P1, rpcTimeout,      REQUEST_RESPONSE,  () -&gt; null,                                 () -&gt; ResponseVerbHandler.instance                             ),</span>
<span class="fc" id="L218">    @Deprecated</span>
<span class="nc" id="L219">    INTERNAL_RSP           (23,  P1, rpcTimeout,      INTERNAL_RESPONSE, () -&gt; null,                                 () -&gt; ResponseVerbHandler.instance                             ),</span>

    // largest used ID: 116

    // CUSTOM VERBS
<span class="fc" id="L224">    UNUSED_CUSTOM_VERB     (CUSTOM,</span>
<span class="nc" id="L225">                            0,   P1, rpcTimeout,      INTERNAL_RESPONSE, () -&gt; null,                                 () -&gt; null                                                     ),</span>
    ;

<span class="fc" id="L228">    public static final List&lt;Verb&gt; VERBS = ImmutableList.copyOf(Verb.values());</span>

<span class="fc" id="L230">    public enum Priority</span>
    {
<span class="fc" id="L232">        P0,  // sends on the urgent connection (i.e. for Gossip, Echo)</span>
<span class="fc" id="L233">        P1,  // small or empty responses</span>
<span class="fc" id="L234">        P2,  // larger messages that can be dropped but who have a larger impact on system stability (e.g. READ_REPAIR, READ_RSP)</span>
<span class="fc" id="L235">        P3,</span>
<span class="fc" id="L236">        P4</span>
    }

<span class="fc" id="L239">    public enum Kind</span>
    {
<span class="fc" id="L241">        NORMAL,</span>
<span class="fc" id="L242">        CUSTOM</span>
    }

    public final int id;
    public final Priority priority;
    public final Stage stage;
    public final Kind kind;

    /**
     * Messages we receive from peers have a Verb that tells us what kind of message it is.
     * Most of the time, this is enough to determine how to deserialize the message payload.
     * The exception is the REQUEST_RSP verb, which just means &quot;a response to something you told me to do.&quot;
     * Traditionally, this was fine since each VerbHandler knew what type of payload it expected, and
     * handled the deserialization itself.  Now that we do that in ITC, to avoid the extra copy to an
     * intermediary byte[] (See CASSANDRA-3716), we need to wire that up to the CallbackInfo object
     * (see below).
     *
     * NOTE: we use a Supplier to avoid loading the dependent classes until necessary.
     */
    private final Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer;
    private final Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler;

    public final Verb responseVerb;

    private final ToLongFunction&lt;TimeUnit&gt; expiration;


    /**
     * Verbs it's okay to drop if the request has been queued longer than the request timeout.  These
     * all correspond to client requests or something triggered by them; we don't want to
     * drop internal messages like bootstrap or repair notifications.
     */
    Verb(int id, Priority priority, ToLongFunction&lt;TimeUnit&gt; expiration, Stage stage, Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer, Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler)
    {
<span class="fc" id="L276">        this(id, priority, expiration, stage, serializer, handler, null);</span>
<span class="fc" id="L277">    }</span>

    Verb(int id, Priority priority, ToLongFunction&lt;TimeUnit&gt; expiration, Stage stage, Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer, Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler, Verb responseVerb)
    {
<span class="fc" id="L281">        this(NORMAL, id, priority, expiration, stage, serializer, handler, responseVerb);</span>
<span class="fc" id="L282">    }</span>

    Verb(Kind kind, int id, Priority priority, ToLongFunction&lt;TimeUnit&gt; expiration, Stage stage, Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer, Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler)
    {
<span class="fc" id="L286">        this(kind, id, priority, expiration, stage, serializer, handler, null);</span>
<span class="fc" id="L287">    }</span>

    Verb(Kind kind, int id, Priority priority, ToLongFunction&lt;TimeUnit&gt; expiration, Stage stage, Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer, Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler, Verb responseVerb)
<span class="fc" id="L290">    {</span>
<span class="fc" id="L291">        this.stage = stage;</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">        if (id &lt; 0)</span>
<span class="nc" id="L293">            throw new IllegalArgumentException(&quot;Verb id must be non-negative, got &quot; + id + &quot; for verb &quot; + name());</span>

<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (kind == CUSTOM)</span>
        {
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">            if (id &gt; MAX_CUSTOM_VERB_ID)</span>
<span class="nc" id="L298">                throw new AssertionError(&quot;Invalid custom verb id &quot; + id + &quot; - we only allow custom ids between 0 and &quot; + MAX_CUSTOM_VERB_ID);</span>
<span class="fc" id="L299">            this.id = idForCustomVerb(id);</span>
        }
        else
        {
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">            if (id &gt; CUSTOM_VERB_START - MAX_CUSTOM_VERB_ID)</span>
<span class="nc" id="L304">                throw new AssertionError(&quot;Invalid verb id &quot; + id + &quot; - we only allow ids between 0 and &quot; + (CUSTOM_VERB_START - MAX_CUSTOM_VERB_ID));</span>
<span class="fc" id="L305">            this.id = id;</span>
        }
<span class="fc" id="L307">        this.priority = priority;</span>
<span class="fc" id="L308">        this.serializer = serializer;</span>
<span class="fc" id="L309">        this.handler = handler;</span>
<span class="fc" id="L310">        this.responseVerb = responseVerb;</span>
<span class="fc" id="L311">        this.expiration = expiration;</span>
<span class="fc" id="L312">        this.kind = kind;</span>
<span class="fc" id="L313">    }</span>

    public &lt;In, Out&gt; IVersionedAsymmetricSerializer&lt;In, Out&gt; serializer()
    {
<span class="fc" id="L317">        return (IVersionedAsymmetricSerializer&lt;In, Out&gt;) serializer.get();</span>
    }

    public &lt;T&gt; IVerbHandler&lt;T&gt; handler()
    {
<span class="fc" id="L322">        return (IVerbHandler&lt;T&gt;) handler.get();</span>
    }

    public long expiresAtNanos(long nowNanos)
    {
<span class="fc" id="L327">        return nowNanos + expiresAfterNanos();</span>
    }

    public long expiresAfterNanos()
    {
<span class="fc" id="L332">        return expiration.applyAsLong(NANOSECONDS);</span>
    }

    // this is a little hacky, but reduces the number of parameters up top
    public boolean isResponse()
    {
<span class="fc bfc" id="L338" title="All 2 branches covered.">        return handler.get() == ResponseVerbHandler.instance;</span>
    }

    @VisibleForTesting
    Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; unsafeSetHandler(Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; handler) throws NoSuchFieldException, IllegalAccessException
    {
<span class="nc" id="L344">        Supplier&lt;? extends IVerbHandler&lt;?&gt;&gt; original = this.handler;</span>
<span class="nc" id="L345">        Field field = Verb.class.getDeclaredField(&quot;handler&quot;);</span>
<span class="nc" id="L346">        field.setAccessible(true);</span>
<span class="nc" id="L347">        Field modifiers = ReflectionUtils.getModifiersField();</span>
<span class="nc" id="L348">        modifiers.setAccessible(true);</span>
<span class="nc" id="L349">        modifiers.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span class="nc" id="L350">        field.set(this, handler);</span>
<span class="nc" id="L351">        return original;</span>
    }

    @VisibleForTesting
    public Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; unsafeSetSerializer(Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; serializer) throws NoSuchFieldException, IllegalAccessException
    {
<span class="nc" id="L357">        Supplier&lt;? extends IVersionedAsymmetricSerializer&lt;?, ?&gt;&gt; original = this.serializer;</span>
<span class="nc" id="L358">        Field field = Verb.class.getDeclaredField(&quot;serializer&quot;);</span>
<span class="nc" id="L359">        field.setAccessible(true);</span>
<span class="nc" id="L360">        Field modifiers = ReflectionUtils.getModifiersField();</span>
<span class="nc" id="L361">        modifiers.setAccessible(true);</span>
<span class="nc" id="L362">        modifiers.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span class="nc" id="L363">        field.set(this, serializer);</span>
<span class="nc" id="L364">        return original;</span>
    }

    @VisibleForTesting
    ToLongFunction&lt;TimeUnit&gt; unsafeSetExpiration(ToLongFunction&lt;TimeUnit&gt; expiration) throws NoSuchFieldException, IllegalAccessException
    {
<span class="nc" id="L370">        ToLongFunction&lt;TimeUnit&gt; original = this.expiration;</span>
<span class="nc" id="L371">        Field field = Verb.class.getDeclaredField(&quot;expiration&quot;);</span>
<span class="nc" id="L372">        field.setAccessible(true);</span>
<span class="nc" id="L373">        Field modifiers = ReflectionUtils.getModifiersField();</span>
<span class="nc" id="L374">        modifiers.setAccessible(true);</span>
<span class="nc" id="L375">        modifiers.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span>
<span class="nc" id="L376">        field.set(this, expiration);</span>
<span class="nc" id="L377">        return original;</span>
    }

    // This is the largest number we can store in 2 bytes using VIntCoding (1 bit per byte is used to indicate if there is more data coming).
    // When generating ids we count *down* from this number
    private static final int CUSTOM_VERB_START = (1 &lt;&lt; (7 * 2)) - 1;

    // Sanity check for the custom verb ids - avoids someone mistakenly adding a custom verb id close to the normal verbs which
    // could cause a conflict later when new normal verbs are added.
    private static final int MAX_CUSTOM_VERB_ID = 1000;

    private static final Verb[] idToVerbMap;
    private static final Verb[] idToCustomVerbMap;
    private static final int minCustomId;

    static
    {
<span class="fc" id="L394">        Verb[] verbs = values();</span>
<span class="fc" id="L395">        int max = -1;</span>
<span class="fc" id="L396">        int minCustom = Integer.MAX_VALUE;</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">        for (Verb v : verbs)</span>
        {
<span class="pc bpc" id="L399" title="1 of 3 branches missed.">            switch (v.kind)</span>
            {
                case NORMAL:
<span class="fc" id="L402">                    max = Math.max(v.id, max);</span>
<span class="fc" id="L403">                    break;</span>
                case CUSTOM:
<span class="fc" id="L405">                    minCustom = Math.min(v.id, minCustom);</span>
<span class="fc" id="L406">                    break;</span>
                default:
<span class="nc" id="L408">                    throw new AssertionError(&quot;Unsupported Verb Kind: &quot; + v.kind + &quot; for verb &quot; + v);</span>
            }
        }
<span class="fc" id="L411">        minCustomId = minCustom;</span>

<span class="pc bpc" id="L413" title="1 of 2 branches missed.">        if (minCustom &lt;= max)</span>
<span class="nc" id="L414">            throw new IllegalStateException(&quot;Overlapping verb ids are not allowed&quot;);</span>

<span class="fc" id="L416">        Verb[] idMap = new Verb[max + 1];</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">        int customCount = minCustom &lt; Integer.MAX_VALUE ? CUSTOM_VERB_START - minCustom : 0;</span>
<span class="fc" id="L418">        Verb[] customIdMap = new Verb[customCount + 1];</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">        for (Verb v : verbs)</span>
        {
<span class="pc bpc" id="L421" title="1 of 3 branches missed.">            switch (v.kind)</span>
            {
                case NORMAL:
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">                    if (idMap[v.id] != null)</span>
<span class="nc" id="L425">                        throw new IllegalArgumentException(&quot;cannot have two verbs that map to the same id: &quot; + v + &quot; and &quot; + idMap[v.id]);</span>
<span class="fc" id="L426">                    idMap[v.id] = v;</span>
<span class="fc" id="L427">                    break;</span>
                case CUSTOM:
<span class="fc" id="L429">                    int relativeId = idForCustomVerb(v.id);</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">                    if (customIdMap[relativeId] != null)</span>
<span class="nc" id="L431">                        throw new IllegalArgumentException(&quot;cannot have two custom verbs that map to the same id: &quot; + v + &quot; and &quot; + customIdMap[relativeId]);</span>
<span class="fc" id="L432">                    customIdMap[relativeId] = v;</span>
<span class="fc" id="L433">                    break;</span>
                default:
<span class="nc" id="L435">                    throw new AssertionError(&quot;Unsupported Verb Kind: &quot; + v.kind + &quot; for verb &quot; + v);</span>
            }
        }

<span class="fc" id="L439">        idToVerbMap = idMap;</span>
<span class="fc" id="L440">        idToCustomVerbMap = customIdMap;</span>
<span class="fc" id="L441">    }</span>

    public static Verb fromId(int id)
    {
<span class="fc" id="L445">        Verb[] verbs = idToVerbMap;</span>
<span class="pc bpc" id="L446" title="1 of 2 branches missed.">        if (id &gt;= minCustomId)</span>
        {
<span class="nc" id="L448">            id = idForCustomVerb(id);</span>
<span class="nc" id="L449">            verbs = idToCustomVerbMap;</span>
        }
<span class="pc bpc" id="L451" title="2 of 4 branches missed.">        Verb verb = id &gt;= 0 &amp;&amp; id &lt; verbs.length ? verbs[id] : null;</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">        if (verb == null)</span>
<span class="nc" id="L453">            throw new IllegalArgumentException(&quot;Unknown verb id &quot; + id);</span>
<span class="fc" id="L454">        return verb;</span>
    }

    /**
     * calculate an id for a custom verb
     */
    private static int idForCustomVerb(int id)
    {
<span class="fc" id="L462">        return CUSTOM_VERB_START - id;</span>
    }
}

@SuppressWarnings(&quot;unused&quot;)
<span class="nc" id="L467">class VerbTimeouts</span>
{
<span class="fc" id="L469">    static final ToLongFunction&lt;TimeUnit&gt; rpcTimeout      = DatabaseDescriptor::getRpcTimeout;</span>
<span class="fc" id="L470">    static final ToLongFunction&lt;TimeUnit&gt; writeTimeout    = DatabaseDescriptor::getWriteRpcTimeout;</span>
<span class="fc" id="L471">    static final ToLongFunction&lt;TimeUnit&gt; readTimeout     = DatabaseDescriptor::getReadRpcTimeout;</span>
<span class="fc" id="L472">    static final ToLongFunction&lt;TimeUnit&gt; rangeTimeout    = DatabaseDescriptor::getRangeRpcTimeout;</span>
<span class="fc" id="L473">    static final ToLongFunction&lt;TimeUnit&gt; counterTimeout  = DatabaseDescriptor::getCounterWriteRpcTimeout;</span>
<span class="fc" id="L474">    static final ToLongFunction&lt;TimeUnit&gt; truncateTimeout = DatabaseDescriptor::getTruncateRpcTimeout;</span>
<span class="fc" id="L475">    static final ToLongFunction&lt;TimeUnit&gt; repairTimeout   = DatabaseDescriptor::getRepairRpcTimeout;</span>
<span class="fc" id="L476">    static final ToLongFunction&lt;TimeUnit&gt; pingTimeout     = DatabaseDescriptor::getPingTimeout;</span>
<span class="fc" id="L477">    static final ToLongFunction&lt;TimeUnit&gt; longTimeout     = units -&gt; Math.max(DatabaseDescriptor.getRpcTimeout(units), units.convert(5L, TimeUnit.MINUTES));</span>
<span class="pc" id="L478">    static final ToLongFunction&lt;TimeUnit&gt; noTimeout       = units -&gt; {  throw new IllegalStateException(); };</span>

    // repair verbs need to have different timeouts based off if retries are enabled or not
<span class="fc" id="L481">    static final ToLongFunction&lt;TimeUnit&gt; repairWithBackoffTimeout      = units -&gt; {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!DatabaseDescriptor.getRepairRetrySpec().isEnabled())</span>
<span class="nc" id="L483">            return repairTimeout.applyAsLong(units);</span>
<span class="nc" id="L484">        return rpcTimeout.applyAsLong(units);</span>
    };
<span class="fc" id="L486">    static final ToLongFunction&lt;TimeUnit&gt; repairValidationRspTimeout    = units -&gt; {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">        if (!DatabaseDescriptor.getRepairRetrySpec().isMerkleTreeRetriesEnabled())</span>
<span class="nc" id="L488">            return longTimeout.applyAsLong(units);</span>
<span class="nc" id="L489">        return rpcTimeout.applyAsLong(units);</span>
    };
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>