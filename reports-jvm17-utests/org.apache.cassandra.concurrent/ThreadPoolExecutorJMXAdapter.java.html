<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThreadPoolExecutorJMXAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Cassandara Coverage Report</a> &gt; <a href="index.source.html" class="el_package">org.apache.cassandra.concurrent</a> &gt; <span class="el_source">ThreadPoolExecutorJMXAdapter.java</span></div><h1>ThreadPoolExecutorJMXAdapter.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.cassandra.concurrent;

import java.util.concurrent.RejectedExecutionHandler;
import java.util.concurrent.TimeUnit;

import com.google.common.annotations.VisibleForTesting;

import org.apache.cassandra.metrics.ThreadPoolMetrics;
import org.apache.cassandra.utils.MBeanWrapper;

/**
 * A {@link ThreadPoolExecutorBase} adapter to expose it via JMX.
 * The executor is not itself modified to maximise code re-use.
 * Only its rejected execution handler is updated, and a shutdown listener is registered.
 */
@VisibleForTesting
public class ThreadPoolExecutorJMXAdapter implements Runnable, ResizableThreadPoolMXBean
{
    /**
     * A builder wrapper that delegates all methods except {@link Builder#build()}
     * @param &lt;E&gt;
     */
    static class Builder&lt;E extends ThreadPoolExecutorBase&gt; implements ExecutorBuilder&lt;E&gt;
    {
        final ExecutorBuilder&lt;E&gt; wrapped;
        final String jmxPath;
        Builder(ExecutorBuilder&lt;E&gt; wrapped, String jmxPath)
<span class="fc" id="L46">        {</span>
<span class="fc" id="L47">            this.wrapped = wrapped;</span>
<span class="fc" id="L48">            this.jmxPath = jmxPath;</span>
<span class="fc" id="L49">        }</span>

        @Override
        public ExecutorBuilder&lt;E&gt; withKeepAlive(long keepAlive, TimeUnit keepAliveUnits)
        {
<span class="fc" id="L54">            wrapped.withKeepAlive(keepAlive, keepAliveUnits);</span>
<span class="fc" id="L55">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withKeepAlive()
        {
<span class="nc" id="L61">            wrapped.withKeepAlive();</span>
<span class="nc" id="L62">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withThreadPriority(int threadPriority)
        {
<span class="fc" id="L68">            wrapped.withThreadPriority(threadPriority);</span>
<span class="fc" id="L69">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withQueueLimit(int queueLimit)
        {
<span class="fc" id="L75">            wrapped.withQueueLimit(queueLimit);</span>
<span class="fc" id="L76">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withThreadGroup(ThreadGroup threadGroup)
        {
<span class="fc" id="L82">            wrapped.withThreadGroup(threadGroup);</span>
<span class="fc" id="L83">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withDefaultThreadGroup()
        {
<span class="nc" id="L89">            wrapped.withDefaultThreadGroup();</span>
<span class="nc" id="L90">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withRejectedExecutionHandler(RejectedExecutionHandler rejectedExecutionHandler)
        {
<span class="fc" id="L96">            wrapped.withRejectedExecutionHandler(rejectedExecutionHandler);</span>
<span class="fc" id="L97">            return this;</span>
        }

        @Override
        public ExecutorBuilder&lt;E&gt; withUncaughtExceptionHandler(Thread.UncaughtExceptionHandler uncaughtExceptionHandler)
        {
<span class="nc" id="L103">            wrapped.withUncaughtExceptionHandler(uncaughtExceptionHandler);</span>
<span class="nc" id="L104">            return this;</span>
        }

        /**
         * Invoke {@link ExecutorBuilder#build()} on {@link #wrapped}, and register the resultant
         * {@link ThreadPoolExecutorBase} with a new {@link ThreadPoolExecutorJMXAdapter}.
         *
         * The executor constructed by {@link #wrapped} is returned.
         */
        @Override
        public E build()
        {
<span class="fc" id="L116">            E result = wrapped.build();</span>
<span class="fc" id="L117">            register(jmxPath, result);</span>
<span class="fc" id="L118">            return result;</span>
        }
    }

    public static void register(String jmxPath, ThreadPoolExecutorBase executor)
    {
<span class="fc" id="L124">        new ThreadPoolExecutorJMXAdapter(jmxPath, executor);</span>
<span class="fc" id="L125">    }</span>

    final String mbeanName;
    final ThreadPoolExecutorBase executor;
    final ThreadPoolMetrics metrics;
    boolean released;

    private ThreadPoolExecutorJMXAdapter(String jmxPath, ThreadPoolExecutorBase executor)
<span class="fc" id="L133">    {</span>
<span class="fc" id="L134">        this.executor = executor;</span>
<span class="fc" id="L135">        this.mbeanName = &quot;org.apache.cassandra.&quot; + jmxPath + &quot;:type=&quot; + executor.getThreadFactory().id;</span>
<span class="fc" id="L136">        this.metrics = new ThreadPoolMetrics(executor, jmxPath, executor.getThreadFactory().id).register();</span>
<span class="fc" id="L137">        executor.setRejectedExecutionHandler(rejectedExecutionHandler(metrics, executor.getRejectedExecutionHandler()));</span>
<span class="fc" id="L138">        MBeanWrapper.instance.registerMBean(this, mbeanName);</span>
<span class="fc" id="L139">        executor.onShutdown(this);</span>
<span class="fc" id="L140">    }</span>

    @Override
    public synchronized void run()
    {
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (released)</span>
<span class="fc" id="L146">            return;</span>

<span class="fc" id="L148">        MBeanWrapper.instance.unregisterMBean(mbeanName);</span>
<span class="fc" id="L149">        metrics.release();</span>
<span class="fc" id="L150">        released = true;</span>
<span class="fc" id="L151">    }</span>

    public ThreadPoolMetrics metrics()
    {
<span class="fc" id="L155">        return metrics;</span>
    }

    @Override
    public int getActiveTaskCount()
    {
<span class="nc" id="L161">        return executor.getActiveTaskCount();</span>
    }

    @Override
    public int getPendingTaskCount()
    {
<span class="nc" id="L167">        return executor.getPendingTaskCount();</span>
    }

    @Override
    public int getCoreThreads()
    {
<span class="nc" id="L173">        return executor.getCoreThreads();</span>
    }

    @Override
    public void setCoreThreads(int number)
    {
<span class="nc" id="L179">        executor.setCoreThreads(number);</span>
<span class="nc" id="L180">    }</span>

    @Override
    public int getMaximumThreads()
    {
<span class="nc" id="L185">        return executor.getMaximumThreads();</span>
    }

    @Override
    public void setMaximumThreads(int number)
    {
<span class="nc" id="L191">        executor.setMaximumThreads(number);</span>
<span class="nc" id="L192">    }</span>

    @Override
    public void setCorePoolSize(int corePoolSize)
    {
<span class="nc" id="L197">        executor.setCorePoolSize(corePoolSize);</span>
<span class="nc" id="L198">    }</span>

    @Override
    public int getCorePoolSize()
    {
<span class="nc" id="L203">        return executor.getCorePoolSize();</span>
    }

    @Override
    public void setMaximumPoolSize(int maximumPoolSize)
    {
<span class="nc" id="L209">        executor.setMaximumPoolSize(maximumPoolSize);</span>
<span class="nc" id="L210">    }</span>

    @Override
    public int getMaximumPoolSize()
    {
<span class="nc" id="L215">        return executor.getMaximumPoolSize();</span>
    }

    @Override
    public long getCompletedTaskCount()
    {
<span class="nc" id="L221">        return executor.getCompletedTaskCount();</span>
    }

    @Override
    public int getMaxTasksQueued()
    {
<span class="nc" id="L227">        return executor.getMaxTasksQueued();</span>
    }

    static RejectedExecutionHandler rejectedExecutionHandler(ThreadPoolMetrics metrics, RejectedExecutionHandler wrap)
    {
<span class="fc" id="L232">        return (task, executor) -&gt;</span>
        {
<span class="fc" id="L234">            metrics.totalBlocked.inc();</span>
<span class="fc" id="L235">            metrics.currentBlocked.inc();</span>
            try
            {
<span class="fc" id="L238">                wrap.rejectedExecution(task, executor);</span>
            }
            finally
            {
<span class="fc" id="L242">                metrics.currentBlocked.dec();</span>
            }
<span class="fc" id="L244">        };</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>